

       MCS-51 Family Macro Assembler   A S E M - 5 1   V 1.3
       =====================================================



        Source File:    MCU.a51
        Object File:    MCU.hex
        List File:      MCU.lst



 Line  I  Addr  Code            Source

    1:                          $NOPAGING
    2:          N      00FA     $PAGEWIDTH (250) ;250 columns per line
    3:                          $NOTABS          ;expand tabs
    4:                          $NOSYMBOLS
    5:
    6:                          $INCLUDE        (MCU.inc)
    7: 1                        ;*****************************************************
    8: 1                        ;Interrupt vectors.
    9: 1                        ;-----------------------------------------------------
   10: 1                        ;RESET          0000
   11: 1                        ;IE0            0003
   12: 1                        ;TF0            000B
   13: 1                        ;IE1            0013
   14: 1                        ;TF1            001B
   15: 1                        ;RI & TI        0023
   16: 1                        ;TF2 & EXF2     002B
   17: 1                        ;-----------------------------------------------------
   18: 1                        ;*****************************************************
   19: 1                        ;PORT 1
   20: 1                        ;-----------------------------------------------------
   21: 1                        ;P1.0           OUT:    +5V On
   22: 1                        ;P1.1           OUT:    RST
   23: 1                        ;P1.2           OUT:    SCK
   24: 1                        ;P1.3           OUT:    MISO
   25: 1                        ;P1.4           IN:     MOSI
   26: 1                        ;P1.5
   27: 1                        ;P1.6
   28: 1                        ;P1.7
   29: 1                        ;-----------------------------------------------------
   30: 1                        ;*****************************************************
   31: 1                        ;Internal RAM Locations
   32: 1                        ;-----------------------------------------------------
   33: 1                        ;20             Interrupt control bit flags
   34: 1                        ;               D0                      If set INT0 interrupt jumps to 2003h
   35: 1                        ;               D1                      If set TIMER0 interrupt jumps to 200Bh
   36: 1                        ;               D2                      If set INT1 interrupt jumps to 2013h
   37: 1                        ;               D3                      If set TIMER1 interrupt jumps to 201Bh
   38: 1                        ;               D4                      If set RI/TI interrupt jumps to 2023h
   39: 1                        ;               D5                      If set TIMER2 interrupt jumps to 202Bh
   40: 1                        ;               D6                      If set output is to terminal instead of LCD
   41: 1                        ;               D7                      If set single stepping is enabled
   42: 1                        ;21             D6                      OUTPUT PORT #8000
   43: 1                        ;               D7
   44: 1                        ;24             ARG_STACK               ARGUMENT STACK POINTER
   45: 1                        ;25             FORMAT                  LOCATION OF OUTPUT FORMAT BYTE
   46: 1                        ;26.1           INTGRC                  BIT SET IF INTEGER ERROR
   47: 1                        ;26.3           ADD_IN                  DCMPXZ IN BASIC BACKAGE
   48: 1                        ;26.6           ZSURP                   ZERO SUPRESSION FOR HEX PRINT
   49: 1                        ;28-3D          FP WORK AREA
   50: 1                        ;40-4F          ROMBUFF / LCDLINE       16 Bytes
   51: 1                        ;50             FPCHR_OUT               Holds addrss to next byte during FP number convertion
   52: 1                        ;51             ROMVER                  Byte to be verified
   53: 1                        ;52             ROMPAGES                Number of pages
   54: 1                        ;53             ROMACTION               Menu pos
   55: 1                        ;54             ROMSIZE                 Menu pos
   56: 1                        ;55             ROMMODE                 Menu pos
   57: 1                        ;56             ROMVERERR               Number of verify errors
   58: 1                        ;57             DPLSAVE                 Holds DPL during PRNTCSTR
   59: 1                        ;58             DPHSAVE                 Holds DPH during PRNTCSTR
   60: 1                        ;59             MODE                    Selected mode (0-7)
   61: 1                        ;5A             SSADRLSB                Single step adress
   62: 1                        ;5B             SSADRMSB                Single step adress
   63: 1                        ;60             LCF1
   64: 1                        ;68             LCF2
   65: 1                        ;70             LCF3
   66: 1
   67: 1                        ;C0-FF          48 Byte stack
   68: 1
   69: 1                        ;External RAM Locations
   70: 1                        ;-----------------------------------------------------
   71: 1                        ;0048           EXTERNAL RAM FP NUMBER INPUT AREA
   72: 1                        ;0100           EXTERNAL RAM FP STACK
   73: 1                        ;8000           MEMORU MAPPED I/O
   74: 1                        ;8001           MEMORU MAPPED I/O
   75: 1
   76: 1                        ;-----------------------------------------------------
   77: 1                        ;*****************************************************
   78: 1                        ;SCREEN DRIVER
   79: 1                        ;-----------------------------------------------------
   80: 1                        ;01             START SEND ROMDATA.HEX FILE
   81: 1                        ;02             STOP SEND FILE
   82: 1                        ;03             START RECIEVE ROMDATA.HEX FILE
   83: 1                        ;04             STOP RECIEVE FILE
   84: 1                        ;05             START RECIEVE FILE IN 16 BYTE BLOCKS
   85: 1                        ;06             STOP RECIEVE FILE IN 16 BYTE BLOCKS
   86: 1                        ;07             BELL
   87: 1                        ;08             BACK SPACE
   88: 1                        ;09             TAB
   89: 1                        ;0A             LF
   90: 1                        ;0B             LOCATE
   91: 1                        ;0C             HOME
   92: 1                        ;0D             CR
   93: 1                        ;0E             CLS
   94: 1                        ;0F             MODE
   95: 1                        ;10             START SEND CMDFILE.CMD FILE
   96: 1                        ;-----------------------------------------------------
   97: 1                        ;*****************************************************
   98: 1                        ;Memory mapped I/O
   99: 1                        ;-----------------------------------------------------
  100: 1                        ;8000h Output
  101: 1                        ;-----------------------------------------------------
  102: 1                        ;D0             LCD DB4
  103: 1                        ;D1             LCD DB5
  104: 1                        ;D2             LCD DB6
  105: 1                        ;D3             LCD DB7
  106: 1                        ;D4             LCD RS
  107: 1                        ;D5             LCD E
  108: 1                        ;D6             LC Meter        0=C, 1=L
  109: 1                        ;D7             LC Meter        0=F1, 1=F2 (Adding C Cal)
  110: 1                        ;-----------------------------------------------------
  111: 1                        ;8001h Output
  112: 1                        ;-----------------------------------------------------
  113: 1                        ;D0             FRQ SEL A
  114: 1                        ;D1             FRQ SEL B       00=EXT FRQ,01=FGEN,10=LCMETER,11=ALE
  115: 1                        ;D2             FRQ GATE        ACTIVE LOW
  116: 1                        ;D3             FRQ RESET       ACTIVE HIGH
  117: 1                        ;D4             ADC CS          ACTIVE LOW
  118: 1                        ;D5             ADC CLK         HIGH TO LOW TRANSITION
  119: 1                        ;D6             ADC DIN         START,S/D,D2,D1,D0
  120: 1                        ;D7             FRQ TTL         ACTIVE HIGH
  121: 1                        ;-----------------------------------------------------
  122: 1                        ;8000h Input
  123: 1                        ;-----------------------------------------------------
  124: 1                        ;D0             FRQ LSB
  125: 1                        ;D1
  126: 1                        ;D2
  127: 1                        ;D3
  128: 1                        ;D4
  129: 1                        ;D5
  130: 1                        ;D6
  131: 1                        ;D7             FRQ MSB
  132: 1                        ;-----------------------------------------------------
  133: 1                        ;8001h Input
  134: 1                        ;-----------------------------------------------------
  135: 1                        ;D0             ADC DOUT
  136: 1                        ;D1
  137: 1                        ;D2
  138: 1                        ;D3
  139: 1                        ;D4
  140: 1                        ;D5
  141: 1                        ;D6
  142: 1                        ;D7
  143: 1
  144: 1                        ;-----------------------------------------------------
  145: 1                        ;*****************************************************
  146: 1                        ;Equates
  147: 1                        ;-----------------------------------------------------
  148: 1        N      00C8     T2CON           EQU 0C8h
  149: 1        N      00CA     RCAP2L          EQU 0CAh
  150: 1        N      00CB     RCAP2H          EQU 0CBh
  151: 1        N      00CC     TL2             EQU 0CCh
  152: 1        N      00CD     TH2             EQU 0CDh
  153: 1        N        BD     PT2             BIT 0BDh
  154: 1        N      000A     MODEMAX         EQU 10
  155: 1                        ;-----------------------------------------------------
  156: 1        N      0020     INTBITS         EQU 20h                 ;Interrupt jump control
  157: 1        N      0021     OUTD7D6         EQU 21h                 ;Output port #8000h
  158: 1        N      0040     ROMBUFF         EQU 40h                 ;16 Bytes
  159: 1        N      0040     LCDLINE         EQU 40h                 ;16 Bytes
  160: 1        N      0050     FPCHR_OUT       EQU 50h                 ;Holds addrss to next byte during FP number convertion
  161: 1        N      0051     ROMVER          EQU 51h                 ;Byte to be verified
  162: 1        N      0052     ROMPAGES        EQU 52h                 ;Number of pages
  163: 1        N      0053     ROMACTION       EQU 53h                 ;Menu pos
  164: 1        N      0054     ROMSIZE         EQU 54h                 ;Menu pos
  165: 1        N      0055     ROMMODE         EQU 55h                 ;Menu pos
  166: 1        N      0056     ROMVERERR       EQU 56h                 ;Number of verify errors
  167: 1        N      0057     DPLSAVE         EQU 57h                 ;Holds DPL during PRNTCSTR
  168: 1        N      0058     DPHSAVE         EQU 58h                 ;Holds DPH during PRNTCSTR
  169: 1        N      0059     MODE            EQU 59h                 ;Selected mode (0-7)
  170: 1        N      005A     SSADRLSB        EQU 5Ah                 ;Single step adress LSB
  171: 1        N      005B     SSADRMSB        EQU 5Bh                 ;Single step adress MSB
  172: 1                        ;*****************************************************
  173: 1                        ; The following values MUST be provided by the user
  174: 1                        ;*****************************************************
  175: 1        N      0001     ARG_STACK_PAGE  EQU 01H                 ;External memory page for arg stack
  176: 1        N      0024     ARG_STACK       EQU 24H                 ;ARGUMENT STACK POINTER
  177: 1        N      0025     FORMAT          EQU 25H                 ;LOCATION OF OUTPUT FORMAT BYTE
  178: 1        B        31     INTGRC          BIT 26H.1               ;BIT SET IF INTEGER ERROR
  179: 1        B        33     ADD_IN          BIT 26H.3               ;DCMPXZ IN BASIC BACKAGE
  180: 1        B        36     ZSURP           BIT 26H.6               ;ZERO SUPRESSION FOR HEX PRINT
  181: 1                        ;*****************************************************
  182: 1                        ;XRAM
  183: 1                        ;*****************************************************
  184: 1        N      0048     CONVT           EQU 0048H               ;String addr TO CONVERT NUMBERS
  185: 1        N      0060     LCF1            EQU 0060H               ;LC Meter F1
  186: 1        N      0068     LCF2            EQU 0068h               ;LC Meter F2
  187: 1        N      0070     LCF3            EQU 0070h               ;LC Meter F3
  188: 1        N      0078     LCCA            EQU 0078h               ;((F1/F2)^2)-1
  189: 1        N      0080     LCCB            EQU 0080h               ;((1/2*Pi*F1)^2)*LCCA
  190: 1        N      0088     LCCT            EQU 0088h               ;Temp
  191: 1                        ;-----------------------------------------------------
  192:
  193:          N      0000     DEVMODE         EQU 0
  194:          N      0000     DEBUG           EQU 0
  195:
  196:          N      FFFF     IF DEVMODE=0
  197:                          ;RESET:***********************************************
  198:          N      0000                     ORG     0000h
  199:    0000  02 10 00                        LJMP    START0
  200:                          ;IE0IRQ:**********************************************
  201:          N      0003                     ORG     0003h
  202:    0003  01 32                           AJMP    IE0IRQ
  203:                          ;TF0IRQ:**********************************************
  204:          N      000B                     ORG     000Bh
  205:    000B  20 01 01                        JB      INTBITS.1,$+4
  206:    000E  32                              RETI
  207:    000F  02 20 0B                        LJMP    200Bh
  208:                          ;IE1IRQ:**********************************************
  209:          N      0013                     ORG     0013h
  210:    0013  01 41                           AJMP    IE1IRQ
  211:                          ;TF1IRQ:**********************************************
  212:          N      001B                     ORG     001Bh
  213:    001B  20 03 01                        JB      INTBITS.3,$+4
  214:    001E  32                              RETI
  215:    001F  02 20 1B                        LJMP    201Bh
  216:                          ;RITIIRQ:*********************************************
  217:          N      0023                     ORG     0023h
  218:    0023  20 04 01                        JB      INTBITS.4,$+4
  219:    0026  32                              RETI
  220:    0027  02 20 23                        LJMP    2023h
  221:                          ;TF2EXF2IRQ:******************************************
  222:          N      002B                     ORG     002Bh
  223:    002B  20 05 01                        JB      INTBITS.5,$+4
  224:    002E  32                              RETI
  225:    002F  02 20 2B                        LJMP    202Bh
  226:                          ;*****************************************************
  227:    0032  20 00 09        IE0IRQ:         JB      INTBITS.0,IE0IRQ1
  228:    0035  15 59                           DEC     MODE
  229:    0037  11 72                           ACALL   SETMODE
  230:    0039  11 56                           ACALL   DEBOUNCEINT0
  231:    003B  02 10 38                        LJMP    START
  232:    003E  02 20 03        IE0IRQ1:        LJMP    2003h
  233:
  234:    0041  20 02 0C        IE1IRQ:         JB      INTBITS.2,IE1IRQ1
  235:    0044  20 07 0C                        JB      INTBITS.7,IE1IRQ2
  236:    0047  05 59                           INC     MODE
  237:    0049  11 72                           ACALL   SETMODE
  238:    004B  11 64                           ACALL   DEBOUNCEINT1
  239:    004D  02 10 38                        LJMP    START
  240:    0050  02 20 13        IE1IRQ1:        LJMP    2013h
  241:    0053  02 1D 74        IE1IRQ2:        LJMP    SINGLESTEP
  242:
  243:                          ELSE
  244:                          ;RESET:***********************************************
  245:                                          ORG     2000h
  246:                                          LJMP    START0
  247:                          ;IE0IRQ:**********************************************
  248:                                          ORG     2003h
  249:                                          AJMP    IE0IRQ
  250:                          ;TF0IRQ:**********************************************
  251:                                          ORG     200Bh
  252:                                          RETI
  253:                          ;IE1IRQ:**********************************************
  254:                                          ORG     2013h
  255:                                          AJMP    IE1IRQ
  256:                          ;TF1IRQ:**********************************************
  257:                                          ORG     201Bh
  258:                                          RETI
  259:                          ;RITIIRQ:*********************************************
  260:                                          ORG     2023h
  261:                                          RETI
  262:                          ;TF2EXF2IRQ:******************************************
  263:                                          ORG     202Bh
  264:                                          RETI
  265:                          ;*****************************************************
  266:                          IE0IRQ:         DEC     MODE
  267:                                          ACALL   SETMODE
  268:                                          ACALL   DEBOUNCEINT0
  269:                                          LJMP    START
  270:
  271:                          IE1IRQ:         JB      INTBITS.7,IE1IRQ2
  272:                                          INC     MODE
  273:                                          ACALL   SETMODE
  274:                                          ACALL   DEBOUNCEINT1
  275:                                          LJMP    START
  276:                          IE1IRQ2:        LJMP    SINGLESTEP
  277:
  278:                          ENDIF
  279:
  280:    0056  7E 00           DEBOUNCEINT0:   MOV     R6,#00h
  281:    0058  7F 00                           MOV     R7,#00h
  282:    005A  30 B2 F9        DEBOUNCEINT01:  JNB     P3.2,DEBOUNCEINT0
  283:    005D  DE FB                           DJNZ    R6,DEBOUNCEINT01
  284:    005F  DF F9                           DJNZ    R7,DEBOUNCEINT01
  285:    0061  C2 89                           CLR     IE0
  286:    0063  32                              RETI
  287:
  288:    0064  7E 00           DEBOUNCEINT1:   MOV     R6,#00h
  289:    0066  7F 00                           MOV     R7,#00h
  290:    0068  30 B3 F9        DEBOUNCEINT11:  JNB     P3.3,DEBOUNCEINT1
  291:    006B  DE FB                           DJNZ    R6,DEBOUNCEINT11
  292:    006D  DF F9                           DJNZ    R7,DEBOUNCEINT11
  293:    006F  C2 8B                           CLR     IE1
  294:    0071  32                              RETI
  295:
  296:    0072  E5 59           SETMODE:        MOV     A,MODE
  297:    0074  B4 FF 02                        CJNE    A,#0FFh,SETMODE1
  298:    0077  74 0A                           MOV     A,#MODEMAX
  299:    0079  B4 0B 01        SETMODE1:       CJNE    A,#MODEMAX+1,SETMODE2
  300:    007C  E4                              CLR     A
  301:    007D  F5 59           SETMODE2:       MOV     MODE,A
  302:    007F  FF                              MOV     R7,A
  303:    0080  90 0D 13                        MOV     DPTR,#MODE0
  304:    0083  DF 03                           DJNZ    R7,SETMODE3
  305:    0085  90 0D 1C                        MOV     DPTR,#MODE1
  306:    0088  DF 03           SETMODE3:       DJNZ    R7,SETMODE4
  307:    008A  90 0D 26                        MOV     DPTR,#MODE2
  308:    008D  DF 03           SETMODE4:       DJNZ    R7,SETMODE5
  309:    008F  90 0D 34                        MOV     DPTR,#MODE3
  310:    0092  DF 03           SETMODE5:       DJNZ    R7,SETMODE6
  311:    0094  90 0D 41                        MOV     DPTR,#MODE4
  312:    0097  DF 03           SETMODE6:       DJNZ    R7,SETMODE7
  313:    0099  90 0D 4E                        MOV     DPTR,#MODE5
  314:    009C  DF 03           SETMODE7:       DJNZ    R7,SETMODE8
  315:    009E  90 0D 5C                        MOV     DPTR,#MODE6
  316:    00A1  DF 03           SETMODE8:       DJNZ    R7,SETMODE9
  317:    00A3  90 0D 66                        MOV     DPTR,#MODE7
  318:    00A6  DF 03           SETMODE9:       DJNZ    R7,SETMODE10
  319:    00A8  90 0D 70                        MOV     DPTR,#MODE8
  320:    00AB  DF 03           SETMODE10:      DJNZ    R7,SETMODE11
  321:    00AD  90 0D 78                        MOV     DPTR,#MODE9
  322:    00B0  DF 03           SETMODE11:      DJNZ    R7,SETMODE12
  323:    00B2  90 0D 80                        MOV     DPTR,#MODE10
  324:    00B5  12 1D 38        SETMODE12:      LCALL   LCDCLEAR
  325:    00B8  12 11 37                        LCALL   PRNTCDPTRLCD
  326:    00BB  22                              RET
  327:
  328:          N      FFFF     IF DEVMODE=0
  329:          N      00C0                     ORG     00C0h
  330:                          ELSE
  331:                                          ORG     20C0h
  332:                          ENDIF
  333:
  334:                          $INCLUDE        (FP52.a51)
  335: 1                        ; This is a complete BCD floating point package for the 8051 micro-
  336: 1                        ; controller. It provides 8 digits of accuracy with exponents that
  337: 1                        ; range from +127 to -127. The mantissa is in packed BCD, while the
  338: 1                        ; exponent is expressed in pseudo-twos complement. A ZERO exponent
  339: 1                        ; is used to express the number ZERO. An exponent value of 80H or
  340: 1                        ; greater than means the exponent is positive, i.e. 80H = E 0,
  341: 1                        ; 81H = E+1, 82H = E+2 and so on. If the exponent is 7FH or less,
  342: 1                        ; the exponent is negative, 7FH = E-1, 7EH = E-2, and so on.
  343: 1                        ; ALL NUMBERS ARE ASSUMED TO BE NORMALIZED and all results are
  344: 1                        ; normalized after calculation. A normalized mantissa is >=.10 and
  345: 1                        ; <=.99999999.
  346: 1                        ;
  347: 1                        ; The numbers in memory assumed to be stored as follows:
  348: 1                        ;
  349: 1                        ; EXPONENT OF ARGUMENT 2   =   VALUE OF ARG_STACK+FP_NUMBER_SIZE
  350: 1                        ; SIGN OF ARGUMENT 2       =   VALUE OF ARG_STACK+FP_NUMBER_SIZE-1
  351: 1                        ; DIGIT 78 OF ARGUMENT 2   =   VALUE OF ARG_STACK+FP_NUMBER_SIZE-2
  352: 1                        ; DIGIT 56 OF ARGUMENT 2   =   VALUE OF ARG_STACK+FP_NUMBER_SIZE-3
  353: 1                        ; DIGIT 34 OF ARGUMENT 2   =   VALUE OF ARG_STACK+FP_NUMBER_SIZE-4
  354: 1                        ; DIGIT 12 OF ARGUMENT 2   =   VALUE OF ARG_STACK+FP_NUMBER_SIZE-5
  355: 1                        ;
  356: 1                        ; EXPONENT OF ARGUMENT 1   =   VALUE OF ARG_STACK
  357: 1                        ; SIGN OF ARGUMENT 1       =   VALUE OF ARG_STACK-1
  358: 1                        ; DIGIT 78 OF ARGUMENT 1   =   VALUE OF ARG_STACK-2
  359: 1                        ; DIGIT 56 OF ARGUMENT 1   =   VALUE OF ARG_STACK-3
  360: 1                        ; DIGIT 34 OF ARGUMENT 1   =   VALUE OF ARG_STACK-4
  361: 1                        ; DIGIT 12 OF ARGUMENT 1   =   VALUE OF ARG_STACK-5
  362: 1                        ;
  363: 1                        ; The operations are performed thusly:
  364: 1                        ;
  365: 1                        ; ARG_STACK+FP_NUMBER_SIZE = ARG_STACK+FP_NUMBER_SIZE # ARG_STACK
  366: 1                        ;
  367: 1                        ; Which is ARGUMENT 2 = ARGUMENT 2 # ARGUMENT 1
  368: 1                        ;
  369: 1                        ; Where # can be ADD, SUBTRACT, MULTIPLY OR DIVIDE.
  370: 1                        ;
  371: 1                        ; Note that the stack gets popped after an operation.
  372: 1                        ;
  373: 1                        ; The FP_COMP instruction POPS the ARG_STACK TWICE and returns status.
  374: 1                        ;
  375: 1                        ;**********************************************************************
  376: 1                        ;
  377: 1                        ;**********************************************************************
  378: 1                        ;
  379: 1                        ; STATUS ON RETURN - After performing an operation (+, -, *, /)
  380: 1                        ;                    the accumulator contains the following status
  381: 1                        ;
  382: 1                        ; ACCUMULATOR - BIT 0 - FLOATING POINT UNDERFLOW OCCURED
  383: 1                        ;
  384: 1                        ;             - BIT 1 - FLOATING POINT OVERFLOW OCCURED
  385: 1                        ;
  386: 1                        ;             - BIT 2 - RESULT WAS ZER0
  387: 1                        ;
  388: 1                        ;             - BIT 3 - DIVIDE BY ZERO ATTEMPTED
  389: 1                        ;
  390: 1                        ;             - BIT 4 - NOT USED, 0 RETURNED
  391: 1                        ;
  392: 1                        ;             - BIT 5 - NOT USED, 0 RETURNED
  393: 1                        ;
  394: 1                        ;             - BIT 6 - NOT USED, 0 RETURNED
  395: 1                        ;
  396: 1                        ;             - BIT 7 - NOT USED, 0 RETURNED
  397: 1                        ;
  398: 1                        ; NOTE: When underflow occures, a ZERO result is returned.
  399: 1                        ;       When overflow or divide by zero occures, a result of
  400: 1                        ;       .99999999 E+127 is returned and it is up to the user
  401: 1                        ;       to handle these conditions as needed in the program.
  402: 1                        ;
  403: 1                        ; NOTE: The Compare instruction returns F0 = 0 if ARG 1 = ARG 2
  404: 1                        ;       and returns a CARRY FLAG = 1 if ARG 1 is > ARG 2
  405: 1                        ;
  406: 1                        ;***********************************************************************
  407: 1                        ;
  408: 1                        ; The following equates are used internally
  409: 1                        ;
  410: 1                        ;***********************************************************************
  411: 1                        ;
  412: 1        N      0006     FP_NUMBER_SIZE  EQU     6
  413: 1        N      0004     DIGIT           EQU     4
  414: 1        N      0000     R0B0            EQU     0
  415: 1        N      0001     R1B0            EQU     1
  416: 1        N      0000     UNDERFLOW       EQU     0
  417: 1        N      0001     OVERFLOW        EQU     1
  418: 1        N      0002     ZERO            EQU     2
  419: 1        N      0003     ZERO_DIVIDE     EQU     3
  420: 1                        ;
  421: 1                        ;***********************************************************************
  422: 1                                ;**************************************************************
  423: 1                                ;
  424: 1                                ; The following internal locations are used by the math pack
  425: 1                                ; ordering is important and the FP_DIGITS must be bit
  426: 1                                ; addressable
  427: 1                                ;
  428: 1                                ;***************************************************************
  429: 1                                ;
  430: 1        N      0028     FP_STATUS       EQU     28H                             ;NOT used data pointer me
  431: 1        N      0029     FP_TEMP         EQU     FP_STATUS+1                     ;NOT USED
  432: 1        N      002A     FP_CARRY        EQU     FP_STATUS+2                     ;USED FOR BITS
  433: 1        N      002B     FP_DIG12        EQU     FP_CARRY+1
  434: 1        N      002C     FP_DIG34        EQU     FP_CARRY+2
  435: 1        N      002D     FP_DIG56        EQU     FP_CARRY+3
  436: 1        N      002E     FP_DIG78        EQU     FP_CARRY+4
  437: 1        N      002F     FP_SIGN         EQU     FP_CARRY+5
  438: 1        N      0030     FP_EXP          EQU     FP_CARRY+6
  439: 1        B        78     MSIGN           BIT     FP_SIGN.0
  440: 1        B        50     XSIGN           BIT     FP_CARRY.0
  441: 1        B        51     FOUND_RADIX     BIT     FP_CARRY.1
  442: 1        B        52     FIRST_RADIX     BIT     FP_CARRY.2
  443: 1        B        53     DONE_LOAD       BIT     FP_CARRY.3
  444: 1        N      002B     FP_NIB1         EQU     FP_DIG12
  445: 1        N      002C     FP_NIB2         EQU     FP_NIB1+1
  446: 1        N      002D     FP_NIB3         EQU     FP_NIB1+2
  447: 1        N      002E     FP_NIB4         EQU     FP_NIB1+3
  448: 1        N      002F     FP_NIB5         EQU     FP_NIB1+4
  449: 1        N      0030     FP_NIB6         EQU     FP_NIB1+5
  450: 1        N      0031     FP_NIB7         EQU     FP_NIB1+6
  451: 1        N      0032     FP_NIB8         EQU     FP_NIB1+7
  452: 1        N      0033     FP_ACCX         EQU     FP_NIB1+8
  453: 1        N      0034     FP_ACCC         EQU     FP_NIB1+9
  454: 1        N      0035     FP_ACC1         EQU     FP_NIB1+10
  455: 1        N      0036     FP_ACC2         EQU     FP_NIB1+11
  456: 1        N      0037     FP_ACC3         EQU     FP_NIB1+12
  457: 1        N      0038     FP_ACC4         EQU     FP_NIB1+13
  458: 1        N      0039     FP_ACC5         EQU     FP_NIB1+14
  459: 1        N      003A     FP_ACC6         EQU     FP_NIB1+15
  460: 1        N      003B     FP_ACC7         EQU     FP_NIB1+16
  461: 1        N      003C     FP_ACC8         EQU     FP_NIB1+17
  462: 1        N      003D     FP_ACCS         EQU     FP_NIB1+18
  463: 1                                ;
  464: 1
  465: 1        C      00C0     FP_BASE         EQU     $
  466: 1
  467: 1                                ;**************************************************************
  468: 1                                ;
  469: 1                                ; The floating point entry points and jump table
  470: 1                                ;
  471: 1                                ;**************************************************************
  472: 1                                ;
  473: 1  00C0  01 F2                           AJMP    FLOATING_ADD
  474: 1  00C2  01 E8                           AJMP    FLOATING_SUB
  475: 1  00C4  21 A5                           AJMP    FLOATING_COMP
  476: 1  00C6  21 D6                           AJMP    FLOATING_MUL
  477: 1  00C8  41 0B                           AJMP    FLOATING_DIV
  478: 1  00CA  61 D2                           AJMP    HEXSCAN
  479: 1  00CC  81 0B                           AJMP    FLOATING_POINT_INPUT
  480: 1  00CE  81 C3                           AJMP    FLOATING_POINT_OUTPUT
  481: 1  00D0  C1 40                           AJMP    CONVERT_BINARY_TO_ASCII_STRING
  482: 1  00D2  A1 E7                           AJMP    CONVERT_ASCII_STRING_TO_BINARY
  483: 1  00D4  C1 1C                           AJMP    MULNUM10
  484: 1  00D6  C1 88                           AJMP    FPHEXOUT
  485: 1                        ;
  486: 1                        ; the remaining jump to routines were extracted from basic52
  487: 1                        ; by me to make the floating point software stand alone
  488: 1                        ;
  489: 1  00D8  61 FF                           AJMP    PUSHR2R0                        ; INTEGER to FLOAT
  490: 1  00DA  C1 D2                           AJMP    IFIX                            ; FLOAT to INTEGER
  491: 1  00DC  E1 13                           AJMP    PUSHAS                          ; PUSH R2:R0 TO ARGUMENT
  492: 1  00DE  E1 0F                           AJMP    POPAS                           ; POP ARGUMENT TO R3:R1
  493: 1  00E0  E1 30                           AJMP    MOVAS                           ; COPY ARGUMENT
  494: 1  00E2  E1 53                           AJMP    AINT                            ; INT FUNCTION
  495: 1  00E4  E1 7B                           AJMP    PUSHC                           ; PUSH ARG IN DPTR TO STACK
  496: 1
  497: 1  00E6  22              PRTERR:         RET
  498: 1  00E7  22              BADPRM:         RET
  499: 1
  500: 1                                ;
  501: 1                                ;
  502: 1  00E8                  FLOATING_SUB:
  503: 1                                ;
  504: 1  00E8  75 A0 01                        MOV     P2,#ARG_STACK_PAGE
  505: 1  00EB  A8 24                           MOV     R0,ARG_STACK
  506: 1  00ED  18                              DEC     R0                              ;POINT TO SIGN
  507: 1  00EE  E2                              MOVX    A,@R0                           ;READ SIGN
  508: 1  00EF  B2 E0                           CPL     ACC.0
  509: 1  00F1  F2                              MOVX    @R0,A
  510: 1                                ;
  511: 1                                ;AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
  512: 1                                ;
  513: 1  00F2                  FLOATING_ADD:
  514: 1                                ;
  515: 1                                ;AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
  516: 1                                ;
  517: 1                                ;
  518: 1  00F2  71 B3                           ACALL   MDES1                           ;R7=TOS EXP, R6=TOS-1 EXP, R4=TOS SIGN
  519: 1                                                                                                                        ;R3=TOS-1 SIGN, OPERATION IS R1 # R0
  520: 1                                ;
  521: 1  00F4  EF                              MOV     A,R7                            ;GET TOS EXPONENT
  522: 1  00F5  60 0D                           JZ      POP_AND_EXIT                    ;IF TOS=0 THEN POP AND EXIT
  523: 1  00F7  BE 00 12                        CJNE    R6,#0,LOAD1                     ;CLEAR CARRY EXIT IF ZERO
  524: 1                                ;
  525: 1                                ;**************************************************************
  526: 1                                ;
  527: 1  00FA                  SWAP_AND_EXIT:                                          ; Swap external args and return
  528: 1                                ;
  529: 1                                ;**************************************************************
  530: 1                                ;
  531: 1  00FA  71 A7                           ACALL   LOAD_POINTERS
  532: 1  00FC  7F 06                           MOV     R7,#FP_NUMBER_SIZE
  533: 1                                ;
  534: 1  00FE  E2              SE1:            MOVX    A,@R0                           ;SWAP THE ARGUMENTS
  535: 1  00FF  F3                              MOVX    @R1,A
  536: 1  0100  18                              DEC     R0
  537: 1  0101  19                              DEC     R1
  538: 1  0102  DF FA                           DJNZ    R7,SE1
  539: 1                                ;
  540: 1  0104                  POP_AND_EXIT:
  541: 1                                ;
  542: 1  0104  E5 24                           MOV     A,ARG_STACK                     ;POP THE STACK
  543: 1  0106  24 06                           ADD     A,#FP_NUMBER_SIZE
  544: 1  0108  F5 24                           MOV     ARG_STACK,A
  545: 1  010A  E4                              CLR     A
  546: 1  010B  22                              RET
  547: 1                                ;
  548: 1                                ;
  549: 1  010C  9E              LOAD1:          SUBB    A,R6                            ;A = ARG 1 EXP - ARG 2 EXP
  550: 1  010D  8F 30                           MOV     FP_EXP,R7                       ;SAVE EXPONENT AND SIGN
  551: 1  010F  8C 2F                           MOV     FP_SIGN,R4
  552: 1  0111  50 09                           JNC     LOAD2                           ;ARG1 EXPONENT IS LARGER OR SAME
  553: 1  0113  8E 30                           MOV     FP_EXP,R6
  554: 1  0115  8B 2F                           MOV     FP_SIGN,R3
  555: 1  0117  F4                              CPL     A
  556: 1  0118  04                              INC     A                               ;COMPENSATE FOR EXP DELTA
  557: 1  0119  C8                              XCH     A,R0                            ;FORCE R0 TO POINT AT THE LARGEST
  558: 1  011A  C9                              XCH     A,R1                            ;EXPONENT
  559: 1  011B  C8                              XCH     A,R0
  560: 1                                ;
  561: 1  011C  FF              LOAD2:          MOV     R7,A                            ;SAVE THE EXPONENT DELTA IN R7
  562: 1  011D  C2 33                           CLR     ADD_IN
  563: 1  011F  BD 00 02                        CJNE    R5,#0,$+5
  564: 1  0122  D2 33                           SETB    ADD_IN
  565: 1                                ;
  566: 1                                ; Load the R1 mantissa
  567: 1                                ;
  568: 1  0124  71 C4                           ACALL   LOADR1_MANTISSA                 ;LOAD THE SMALLEST NUMBER
  569: 1                                ;
  570: 1                                ; Now align the number to the delta exponent
  571: 1                                ; R4 points to the string of the last digits lost
  572: 1                                ;
  573: 1  0126  BF 0B 00                        CJNE    R7,#DIGIT+DIGIT+3,$+3
  574: 1  0129  40 02                           JC      $+4
  575: 1  012B  7F 0A                           MOV     R7,#DIGIT+DIGIT+2
  576: 1                                ;
  577: 1  012D  75 2A 00                        MOV     FP_CARRY,#00                    ;CLEAR THE CARRY
  578: 1  0130  71 04                           ACALL   RIGHT                           ;SHIFT THE NUMBER
  579: 1                                ;
  580: 1                                ; Set up for addition and subtraction
  581: 1                                ;
  582: 1  0132  7F 04                           MOV     R7,#DIGIT                       ;LOOP COUNT
  583: 1  0134  79 2E                           MOV     R1,#FP_DIG78
  584: 1  0136  74 9E                           MOV     A,#9EH
  585: 1  0138  C3                              CLR     C
  586: 1  0139  9C                              SUBB    A,R4
  587: 1  013A  D4                              DA      A
  588: 1  013B  CC                              XCH     A,R4
  589: 1  013C  70 01                           JNZ     $+3
  590: 1  013E  FC                              MOV     R4,A
  591: 1  013F  B4 50 00                        CJNE    A,#50H,$+3                      ;TEST FOR SUBTRACTION
  592: 1  0142  30 33 18                        JNB     ADD_IN,SUBLP                    ;DO SUBTRACTION IF NO ADD_IN
  593: 1  0145  B3                              CPL     C                               ;FLIP CARRY FOR ADDITION
  594: 1  0146  31 54                           ACALL   ADDLP                           ;DO ADDITION
  595: 1                                ;
  596: 1  0148  50 08                           JNC     ADD_R
  597: 1  014A  05 2A                           INC     FP_CARRY
  598: 1  014C  7F 01                           MOV     R7,#1
  599: 1  014E  71 04                           ACALL   RIGHT
  600: 1  0150  51 BB                           ACALL   INC_FP_EXP                      ;SHIFT AND BUMP EXPONENT
  601: 1                                ;
  602: 1  0152  41 AC           ADD_R:          AJMP    STORE_ALIGN_TEST_AND_EXIT
  603: 1                                ;
  604: 1  0154  E2              ADDLP:          MOVX    A,@R0
  605: 1  0155  37                              ADDC    A,@R1
  606: 1  0156  D4                              DA      A
  607: 1  0157  F7                              MOV     @R1,A
  608: 1  0158  18                              DEC     R0
  609: 1  0159  19                              DEC     R1
  610: 1  015A  DF F8                           DJNZ    R7,ADDLP                        ;LOOP UNTIL DONE
  611: 1  015C  22                              RET
  612: 1                                ;
  613: 1                                ;
  614: 1  015D  E2              SUBLP:          MOVX    A,@R0                           ;NOW DO SUBTRACTION
  615: 1  015E  FE                              MOV     R6,A
  616: 1  015F  E4                              CLR     A
  617: 1  0160  34 99                           ADDC    A,#99H
  618: 1  0162  97                              SUBB    A,@R1
  619: 1  0163  2E                              ADD     A,R6
  620: 1  0164  D4                              DA      A
  621: 1  0165  F7                              MOV     @R1,A
  622: 1  0166  18                              DEC     R0
  623: 1  0167  19                              DEC     R1
  624: 1  0168  DF F3                           DJNZ    R7,SUBLP
  625: 1  016A  40 11                           JC      FSUB6
  626: 1                                ;
  627: 1                                ;
  628: 1                                ; Need to complement the result and sign because the floating
  629: 1                                ; point accumulator mantissa was larger than the external
  630: 1                                ; memory and their signs were equal.
  631: 1                                ;
  632: 1  016C  B2 78                           CPL     FP_SIGN.0
  633: 1  016E  79 2E                           MOV     R1,#FP_DIG78
  634: 1  0170  7F 04                           MOV     R7,#DIGIT                       ;LOOP COUNT
  635: 1                                ;
  636: 1  0172  74 9A           FSUB5:          MOV     A,#9AH
  637: 1  0174  97                              SUBB    A,@R1
  638: 1  0175  24 00                           ADD     A,#0
  639: 1  0177  D4                              DA      A
  640: 1  0178  F7                              MOV     @R1,A
  641: 1  0179  19                              DEC     R1
  642: 1  017A  B3                              CPL     C
  643: 1  017B  DF F5                           DJNZ    R7,FSUB5                        ;LOOP
  644: 1                                ;
  645: 1                                ; Now see how many zeros their are
  646: 1                                ;
  647: 1  017D  78 2B           FSUB6:          MOV     R0,#FP_DIG12
  648: 1  017F  7F 00                           MOV     R7,#0
  649: 1                                ;
  650: 1  0181  E6              FSUB7:          MOV     A,@R0
  651: 1  0182  70 08                           JNZ     FSUB8
  652: 1  0184  0F                              INC     R7
  653: 1  0185  0F                              INC     R7
  654: 1  0186  08                              INC     R0
  655: 1  0187  B8 2F F7                        CJNE    R0,#FP_SIGN,FSUB7
  656: 1  018A  41 F4                           AJMP    ZERO_AND_EXIT
  657: 1                                ;
  658: 1  018C  B4 10 00        FSUB8:          CJNE    A,#10H,$+3
  659: 1  018F  50 01                           JNC     FSUB9
  660: 1  0191  0F                              INC     R7
  661: 1                                ;
  662: 1                                ; Now R7 has the number of leading zeros in the FP ACC
  663: 1                                ;
  664: 1  0192  E5 30           FSUB9:          MOV     A,FP_EXP                        ;GET THE OLD EXPONENT
  665: 1  0194  C3                              CLR     C
  666: 1  0195  9F                              SUBB    A,R7                            ;SUBTRACT FROM THE NUMBER OF ZEROS
  667: 1  0196  60 0B                           JZ      FSUB10
  668: 1  0198  40 09                           JC      FSUB10
  669: 1                                ;
  670: 1  019A  F5 30                           MOV     FP_EXP,A                        ;SAVE THE NEW EXPONENT
  671: 1                                ;
  672: 1  019C  71 3E                           ACALL   LEFT1                           ;SHIFT THE FP ACC
  673: 1  019E  75 2A 00                        MOV     FP_CARRY,#0
  674: 1  01A1  41 AC                           AJMP    STORE_ALIGN_TEST_AND_EXIT
  675: 1                                ;
  676: 1  01A3  41 EE           FSUB10:         AJMP    UNDERFLOW_AND_EXIT
  677: 1                                ;
  678: 1                                ;***************************************************************
  679: 1                                ;
  680: 1  01A5                  FLOATING_COMP:  ; Compare two floating point numbers
  681: 1                                        ; used for relational operations and is faster
  682: 1                                        ; than subtraction. ON RETURN, The carry is set
  683: 1                                        ; if ARG1 is > ARG2, else carry is not set
  684: 1                                        ; if ARG1 = ARG2, F0 gets set
  685: 1                                ;
  686: 1                                ;***************************************************************
  687: 1                                ;
  688: 1  01A5  71 B3                           ACALL   MDES1                           ;SET UP THE REGISTERS
  689: 1  01A7  E5 24                           MOV     A,ARG_STACK
  690: 1  01A9  24 0C                           ADD     A,#FP_NUMBER_SIZE+FP_NUMBER_SIZE
  691: 1  01AB  F5 24                           MOV     ARG_STACK,A                     ;POP THE STACK TWICE, CLEAR THE CARRY
  692: 1  01AD  EE                              MOV     A,R6                            ;CHECK OUT EXPONENTS
  693: 1  01AE  C2 D5                           CLR     F0
  694: 1  01B0  C3                              CLR     C
  695: 1  01B1  9F                              SUBB    A,R7
  696: 1  01B2  60 0A                           JZ      EXPONENTS_EQUAL
  697: 1  01B4  40 03                           JC      ARG1_EXP_IS_LARGER
  698: 1                                ;
  699: 1                                ; Now the ARG2 EXPONENT is > ARG1 EXPONENT
  700: 1                                ;
  701: 1  01B6                  SIGNS_DIFFERENT:
  702: 1                                ;
  703: 1  01B6  EB                              MOV     A,R3                            ;SEE IF SIGN OF ARG2 IS POSITIVE
  704: 1  01B7  80 01                           SJMP    $+3
  705: 1                                ;
  706: 1  01B9                  ARG1_EXP_IS_LARGER:
  707: 1                                ;
  708: 1  01B9  EC                              MOV     A,R4                            ;GET THE SIGN OF ARG1 EXPONENT
  709: 1  01BA  60 01                           JZ      $+3
  710: 1  01BC  B3                              CPL     C
  711: 1  01BD  22                              RET
  712: 1                                ;
  713: 1  01BE                  EXPONENTS_EQUAL:
  714: 1                                ;
  715: 1                                ; First, test the sign, then the mantissa
  716: 1                                ;
  717: 1  01BE  BD 00 F5                        CJNE    R5,#0,SIGNS_DIFFERENT
  718: 1                                ;
  719: 1  01C1                  BOTH_PLUS:
  720: 1                                ;
  721: 1  01C1  7F 04                           MOV     R7,#DIGIT                       ;POINT AT MS DIGIT
  722: 1  01C3  18                              DEC     R0
  723: 1  01C4  18                              DEC     R0
  724: 1  01C5  18                              DEC     R0
  725: 1  01C6  19                              DEC     R1
  726: 1  01C7  19                              DEC     R1
  727: 1  01C8  19                              DEC     R1
  728: 1                                ;
  729: 1                                ; Now do the compare
  730: 1                                ;
  731: 1  01C9  E2              CLOOP:          MOVX    A,@R0
  732: 1  01CA  FE                              MOV     R6,A
  733: 1  01CB  E3                              MOVX    A,@R1
  734: 1  01CC  9E                              SUBB    A,R6
  735: 1  01CD  70 EA                           JNZ     ARG1_EXP_IS_LARGER
  736: 1  01CF  08                              INC     R0
  737: 1  01D0  09                              INC     R1
  738: 1  01D1  DF F6                           DJNZ    R7,CLOOP
  739: 1                                ;
  740: 1                                ; If here, the numbers are the same, the carry is cleared
  741: 1                                ;
  742: 1  01D3  D2 D5                           SETB    F0
  743: 1  01D5  22                              RET                                     ;EXIT WITH EQUAL
  744: 1                                ;
  745: 1                        ;MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
  746: 1                        ;
  747: 1  01D6                  FLOATING_MUL:                                           ; Floating point multiply
  748: 1                        ;
  749: 1                        ;MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
  750: 1                        ;
  751: 1  01D6  71 B1                           ACALL   MUL_DIV_EXP_AND_SIGN
  752: 1                                ;
  753: 1                                ; check for zero exponents
  754: 1                                ;
  755: 1  01D8  BE 00 02                        CJNE    R6,#00,$+5                      ;ARG 2 EXP ZERO?
  756: 1  01DB  41 F4                           AJMP    ZERO_AND_EXIT
  757: 1                                ;
  758: 1                                ; calculate the exponent
  759: 1                                ;
  760: 1  01DD  8D 2F           FMUL1:          MOV     FP_SIGN,R5                      ;SAVE THE SIGN, IN CASE OF FAILURE
  761: 1                                ;
  762: 1  01DF  EF                              MOV     A,R7
  763: 1  01E0  60 F9                           JZ      FMUL1-2
  764: 1  01E2  2E                              ADD     A,R6                            ;ADD THE EXPONENTS
  765: 1  01E3  20 E7 05                        JB      ACC.7,FMUL_OVER
  766: 1  01E6  10 D7 06                        JBC     CY,FMUL2                        ;SEE IF CARRY IS SET
  767: 1                                ;
  768: 1  01E9  41 EE                           AJMP    UNDERFLOW_AND_EXIT
  769: 1                                ;
  770: 1  01EB                  FMUL_OVER:
  771: 1                                ;
  772: 1  01EB  50 02                           JNC     FMUL2                           ;OK IF SET
  773: 1                                ;
  774: 1  01ED  41 DD           FOV:            AJMP    OVERFLOW_AND_EXIT
  775: 1                                ;
  776: 1  01EF  94 81           FMUL2:          SUBB    A,#129                          ;SUBTRACT THE EXPONENT BIAS
  777: 1  01F1  FE                              MOV     R6,A                            ;SAVE IT FOR LATER
  778: 1                                ;
  779: 1                                ; Unpack and load R0
  780: 1                                ;
  781: 1  01F2  51 C7                           ACALL   UNPACK_R0
  782: 1                                ;
  783: 1                                ; Now set up for loop multiply
  784: 1                                ;
  785: 1  01F4  7B 04                           MOV     R3,#DIGIT
  786: 1  01F6  AC 01                           MOV     R4,R1B0
  787: 1                                ;
  788: 1                                ;
  789: 1                                ; Now, do the multiply and accumulate the product
  790: 1                                ;
  791: 1  01F8  8C 01           FMUL3:          MOV     R1B0,R4
  792: 1  01FA  E3                              MOVX    A,@R1
  793: 1  01FB  FA                              MOV     R2,A
  794: 1  01FC  71 74                           ACALL   MUL_NIBBLE
  795: 1                                ;
  796: 1  01FE  EA                              MOV     A,R2
  797: 1  01FF  C4                              SWAP    A
  798: 1  0200  71 74                           ACALL   MUL_NIBBLE
  799: 1  0202  1C                              DEC     R4
  800: 1  0203  DB F3                           DJNZ    R3,FMUL3
  801: 1                                ;
  802: 1                                ; Now, pack and restore the sign
  803: 1                                ;
  804: 1  0205  8E 30                           MOV     FP_EXP,R6
  805: 1  0207  8D 2F                           MOV     FP_SIGN,R5
  806: 1  0209  41 6C                           AJMP    PACK                            ;FINISH IT OFF
  807: 1                                ;
  808: 1                                ;DDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDD
  809: 1                                ;
  810: 1  020B                  FLOATING_DIV:
  811: 1                                ;
  812: 1                                ;DDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDD
  813: 1                                ;
  814: 1  020B  71 B3                           ACALL   MDES1
  815: 1                                ;
  816: 1                                ; Check the exponents
  817: 1                                ;
  818: 1  020D  8D 2F                           MOV     FP_SIGN,R5                      ;SAVE THE SIGN
  819: 1  020F  BF 00 06                        CJNE    R7,#0,DIV0                      ;CLEARS THE CARRY
  820: 1  0212  51 DD                           ACALL   OVERFLOW_AND_EXIT
  821: 1  0214  E4                              CLR     A
  822: 1  0215  D2 E3                           SETB    ACC.ZERO_DIVIDE
  823: 1  0217  22                              RET
  824: 1                                ;
  825: 1  0218  EE              DIV0:           MOV     A,R6                            ;GET EXPONENT
  826: 1  0219  60 C0                           JZ      FMUL1-2                         ;EXIT IF ZERO
  827: 1  021B  9F                              SUBB    A,R7                            ;DELTA EXPONENT
  828: 1  021C  20 E7 04                        JB      ACC.7,D_UNDER
  829: 1  021F  50 04                           JNC     DIV3
  830: 1  0221  41 EE                           AJMP    UNDERFLOW_AND_EXIT
  831: 1                                ;
  832: 1  0223  50 C8           D_UNDER:        JNC     FOV
  833: 1                                ;
  834: 1  0225  24 81           DIV3:           ADD     A,#129                          ;CORRECTLY BIAS THE EXPONENT
  835: 1  0227  F5 30                           MOV     FP_EXP,A                        ;SAVE THE EXPONENT
  836: 1  0229  71 C4                           ACALL   LOADR1_MANTISSA                 ;LOAD THE DIVIDED
  837: 1                                ;
  838: 1  022B  7A 34                           MOV     R2,#FP_ACCC                     ;SAVE LOCATION
  839: 1  022D  AB 00                           MOV     R3,R0B0                         ;SAVE POINTER IN R3
  840: 1  022F  75 2A 00                        MOV     FP_CARRY,#0                     ;ZERO CARRY BYTE
  841: 1                                ;
  842: 1  0232  7D FF           DIV4:           MOV     R5,#0FFH                        ;LOOP COUNT
  843: 1  0234  D3                              SETB    C
  844: 1                                ;
  845: 1  0235  8B 00           DIV5:           MOV     R0B0,R3                         ;RESTORE THE EXTERNAL POINTER
  846: 1  0237  79 2E                           MOV     R1,#FP_DIG78                    ;SET UP INTERNAL POINTER
  847: 1  0239  7F 04                           MOV     R7,#DIGIT                       ;LOOP COUNT
  848: 1  023B  50 17                           JNC     DIV7                            ;EXIT IF NO CARRY
  849: 1                                ;
  850: 1  023D  E2              DIV6:           MOVX    A,@R0                           ;DO ACCUMLATION
  851: 1  023E  FE                              MOV     R6,A
  852: 1  023F  E4                              CLR     A
  853: 1  0240  34 99                           ADDC    A,#99H
  854: 1  0242  9E                              SUBB    A,R6
  855: 1  0243  27                              ADD     A,@R1
  856: 1  0244  D4                              DA      A
  857: 1  0245  F7                              MOV     @R1,A
  858: 1  0246  18                              DEC     R0
  859: 1  0247  19                              DEC     R1
  860: 1  0248  DF F3                           DJNZ    R7,DIV6                         ;LOOP
  861: 1                                ;
  862: 1  024A  0D                              INC     R5                              ;SUBTRACT COUNTER
  863: 1  024B  40 E8                           JC      DIV5                            ;KEEP LOOPING IF CARRY
  864: 1  024D  E7                              MOV     A,@R1                           ;GET CARRY
  865: 1  024E  94 01                           SUBB    A,#1                            ;CARRY IS CLEARED
  866: 1  0250  F7                              MOV     @R1,A                           ;SAVE CARRY DIGIT
  867: 1  0251  B3                              CPL     C
  868: 1  0252  80 E1                           SJMP    DIV5                            ;LOOP
  869: 1                                ;
  870: 1                                ; Restore the result if carry was found
  871: 1                                ;
  872: 1  0254  31 54           DIV7:           ACALL   ADDLP                           ;ADD NUMBER BACK
  873: 1  0256  77 00                           MOV     @R1,#0                          ;CLEAR CARRY
  874: 1  0258  8A 00                           MOV     R0B0,R2                         ;GET SAVE COUNTER
  875: 1  025A  A6 05                           MOV     @R0,5                           ;SAVE COUNT BYTE
  876: 1                                ;
  877: 1  025C  0A                              INC     R2                              ;ADJUST SAVE COUNTER
  878: 1  025D  7F 01                           MOV     R7,#1                           ;BUMP DIVIDEND
  879: 1  025F  71 3C                           ACALL   LEFT
  880: 1  0261  BA 3E CE                        CJNE    R2,#FP_ACC8+2,DIV4
  881: 1                                ;
  882: 1  0264  D5 30 02                        DJNZ    FP_EXP,DIV8
  883: 1  0267  41 EE                           AJMP    UNDERFLOW_AND_EXIT
  884: 1                                ;
  885: 1  0269  75 2A 00        DIV8:           MOV     FP_CARRY,#0
  886: 1                                ;
  887: 1                                ;***************************************************************
  888: 1                                ;
  889: 1  026C                  PACK:   ; Pack the mantissa
  890: 1                                ;
  891: 1                                ;***************************************************************
  892: 1                                ;
  893: 1                                ; First, set up the pointers
  894: 1                                ;
  895: 1  026C  78 34                           MOV     R0,#FP_ACCC
  896: 1  026E  E6                              MOV     A,@R0                           ;GET FP_ACCC
  897: 1  026F  FE                              MOV     R6,A                            ;SAVE FOR ZERO COUNT
  898: 1  0270  60 03                           JZ      PACK0                           ;JUMP OVER IF ZERO
  899: 1  0272  51 BB                           ACALL   INC_FP_EXP                      ;BUMP THE EXPONENT
  900: 1  0274  18                              DEC     R0
  901: 1                                ;
  902: 1  0275  08              PACK0:          INC     R0                              ;POINT AT FP_ACC1
  903: 1                                ;
  904: 1  0276  74 08           PACK1:          MOV     A,#8                            ;ADJUST NIBBLE POINTER
  905: 1  0278  F9                              MOV     R1,A
  906: 1  0279  28                              ADD     A,R0
  907: 1  027A  F8                              MOV     R0,A
  908: 1  027B  B6 05 00                        CJNE    @R0,#5,$+3                      ;SEE IF ADJUSTING NEEDED
  909: 1  027E  40 13                           JC      PACK3+1
  910: 1                                ;
  911: 1  0280  D3              PACK2:          SETB    C
  912: 1  0281  E4                              CLR     A
  913: 1  0282  18                              DEC     R0
  914: 1  0283  36                              ADDC    A,@R0
  915: 1  0284  D4                              DA      A
  916: 1  0285  D6                              XCHD    A,@R0                           ;SAVE THE VALUE
  917: 1  0286  30 E4 09                        JNB     ACC.4,PACK3
  918: 1  0289  D9 F5                           DJNZ    R1,PACK2
  919: 1                                ;
  920: 1  028B  18                              DEC     R0
  921: 1  028C  76 01                           MOV     @R0,#1
  922: 1  028E  51 BB                           ACALL   INC_FP_EXP
  923: 1  0290  80 06                           SJMP    PACK4
  924: 1                                ;
  925: 1  0292  19              PACK3:          DEC     R1
  926: 1  0293  E9                              MOV     A,R1
  927: 1  0294  C3                              CLR     C
  928: 1  0295  C8                              XCH     A,R0
  929: 1  0296  98                              SUBB    A,R0
  930: 1  0297  F8                              MOV     R0,A
  931: 1                                ;
  932: 1  0298  79 2B           PACK4:          MOV     R1,#FP_DIG12
  933: 1                                ;
  934: 1                                ; Now, pack
  935: 1                                ;
  936: 1  029A  E6              PLOOP:          MOV     A,@R0
  937: 1  029B  C4                              SWAP    A                               ;FLIP THE DIGITS
  938: 1  029C  08                              INC     R0
  939: 1  029D  D6                              XCHD    A,@R0
  940: 1  029E  42 06                           ORL     6,A                             ;ACCUMULATE THE OR'ED DIGITS
  941: 1  02A0  F7                              MOV     @R1,A
  942: 1  02A1  08                              INC     R0
  943: 1  02A2  09                              INC     R1
  944: 1  02A3  B9 2F F4                        CJNE    R1,#FP_SIGN,PLOOP
  945: 1  02A6  EE                              MOV     A,R6
  946: 1  02A7  70 03                           JNZ     STORE_ALIGN_TEST_AND_EXIT
  947: 1  02A9  75 30 00                        MOV     FP_EXP,#0                       ;ZERO EXPONENT
  948: 1                                ;
  949: 1                                ;**************************************************************
  950: 1                                ;
  951: 1  02AC                  STORE_ALIGN_TEST_AND_EXIT:                              ;Save the number align carry and exit
  952: 1                                ;
  953: 1                                ;**************************************************************
  954: 1                                ;
  955: 1  02AC  71 A7                           ACALL   LOAD_POINTERS
  956: 1  02AE  89 24                           MOV     ARG_STACK,R1                    ;SET UP THE NEW STACK
  957: 1  02B0  78 30                           MOV     R0,#FP_EXP
  958: 1                                ;
  959: 1                                ; Now load the numbers
  960: 1                                ;
  961: 1  02B2  E6              STORE2:         MOV     A,@R0
  962: 1  02B3  F3                              MOVX    @R1,A                           ;SAVE THE NUMBER
  963: 1  02B4  18                              DEC     R0
  964: 1  02B5  19                              DEC     R1
  965: 1  02B6  B8 2A F9                        CJNE    R0,#FP_CARRY,STORE2
  966: 1                                ;
  967: 1  02B9  E4                              CLR     A                               ;NO ERRORS
  968: 1                                ;
  969: 1  02BA  22              PRET:           RET                                     ;EXIT
  970: 1                                ;
  971: 1  02BB                  INC_FP_EXP:
  972: 1                                ;
  973: 1  02BB  05 30                           INC     FP_EXP
  974: 1  02BD  E5 30                           MOV     A,FP_EXP
  975: 1  02BF  70 F9                           JNZ     PRET                            ;EXIT IF NOT ZERO
  976: 1  02C1  D0 E0                           POP     ACC                             ;WASTE THE CALLING STACK
  977: 1  02C3  D0 E0                           POP     ACC
  978: 1  02C5  41 DD                           AJMP    OVERFLOW_AND_EXIT
  979: 1                                ;
  980: 1                        ;***********************************************************************
  981: 1                        ;
  982: 1  02C7                  UNPACK_R0:      ; Unpack BCD digits and load into nibble locations
  983: 1                        ;
  984: 1                        ;***********************************************************************
  985: 1                                ;
  986: 1  02C7  C0 01                           PUSH    R1B0
  987: 1  02C9  79 32                           MOV     R1,#FP_NIB8
  988: 1                                ;
  989: 1  02CB  E2              ULOOP:          MOVX    A,@R0
  990: 1  02CC  54 0F                           ANL     A,#0FH
  991: 1  02CE  F7                              MOV     @R1,A                           ;SAVE THE NIBBLE
  992: 1  02CF  E2                              MOVX    A,@R0
  993: 1  02D0  C4                              SWAP    A
  994: 1  02D1  54 0F                           ANL     A,#0FH
  995: 1  02D3  19                              DEC     R1
  996: 1  02D4  F7                              MOV     @R1,A                           ;SAVE THE NIBBLE AGAIN
  997: 1  02D5  18                              DEC     R0
  998: 1  02D6  19                              DEC     R1
  999: 1  02D7  B9 2A F1                        CJNE    R1,#FP_NIB1-1,ULOOP
 1000: 1                                ;
 1001: 1  02DA  D0 01                           POP     R1B0
 1002: 1                                ;
 1003: 1  02DC  22              LOAD7:          RET
 1004: 1                                ;
 1005: 1                                ;**************************************************************
 1006: 1                                ;
 1007: 1  02DD                  OVERFLOW_AND_EXIT:      ;LOAD 99999999 E+127,  SET OV BIT, AND EXIT
 1008: 1                                ;
 1009: 1                                ;**************************************************************
 1010: 1                                ;
 1011: 1  02DD  78 2E                           MOV     R0,#FP_DIG78
 1012: 1  02DF  74 99                           MOV     A,#99H
 1013: 1                                ;
 1014: 1  02E1  F6              OVE1:           MOV     @R0,A
 1015: 1  02E2  18                              DEC     R0
 1016: 1  02E3  B8 2A FB                        CJNE    R0,#FP_CARRY,OVE1
 1017: 1                                ;
 1018: 1  02E6  75 30 FF                        MOV     FP_EXP,#0FFH
 1019: 1  02E9  51 AC                           ACALL   STORE_ALIGN_TEST_AND_EXIT
 1020: 1                                ;
 1021: 1  02EB  D2 E1                           SETB    ACC.OVERFLOW
 1022: 1  02ED  22                              RET
 1023: 1                                ;
 1024: 1                                ;**************************************************************
 1025: 1                                ;
 1026: 1  02EE                  UNDERFLOW_AND_EXIT:     ;LOAD 0, SET UF BIT, AND EXIT
 1027: 1                                ;
 1028: 1                                ;**************************************************************
 1029: 1                                ;
 1030: 1  02EE  51 F4                           ACALL   ZERO_AND_EXIT
 1031: 1  02F0  E4                              CLR     A
 1032: 1  02F1  D2 E0                           SETB    ACC.UNDERFLOW
 1033: 1  02F3  22                              RET
 1034: 1                                ;
 1035: 1                                ;**************************************************************
 1036: 1                                ;
 1037: 1  02F4                  ZERO_AND_EXIT:          ;LOAD 0, SET ZERO BIT, AND EXIT
 1038: 1                                ;
 1039: 1                                ;**************************************************************
 1040: 1                                ;
 1041: 1  02F4  51 FB                           ACALL   FP_CLEAR
 1042: 1  02F6  51 AC                           ACALL   STORE_ALIGN_TEST_AND_EXIT
 1043: 1  02F8  D2 E2                           SETB    ACC.ZERO
 1044: 1  02FA  22                              RET                                     ;EXIT
 1045: 1                                ;
 1046: 1                                ;**************************************************************
 1047: 1                                ;
 1048: 1  02FB                  FP_CLEAR:
 1049: 1                                ;
 1050: 1                                ; Clear internal storage
 1051: 1                                ;
 1052: 1                                ;**************************************************************
 1053: 1                                ;
 1054: 1  02FB  E4                              CLR     A
 1055: 1  02FC  78 3D                           MOV     R0,#FP_ACC8+1
 1056: 1                                ;
 1057: 1  02FE  F6              FPC1:           MOV     @R0,A
 1058: 1  02FF  18                              DEC     R0
 1059: 1  0300  B8 29 FB                        CJNE    R0,#FP_TEMP,FPC1
 1060: 1  0303  22                              RET
 1061: 1                                ;
 1062: 1                                ;**************************************************************
 1063: 1                                ;
 1064: 1  0304                  RIGHT:  ; Shift ACCUMULATOR RIGHT the number of nibbles in R7
 1065: 1                                ; Save the shifted values in R4 if SAVE_ROUND is set
 1066: 1                                ;
 1067: 1                                ;**************************************************************
 1068: 1                                ;
 1069: 1  0304  7C 00                           MOV     R4,#0                           ;IN CASE OF NO SHIFT
 1070: 1                                ;
 1071: 1  0306  C3              RIGHT1:         CLR     C
 1072: 1  0307  EF                              MOV     A,R7                            ;GET THE DIGITS TO SHIFT
 1073: 1  0308  60 22                           JZ      RIGHT5-1                        ;EXIT IF ZERO
 1074: 1  030A  94 02                           SUBB    A,#2                            ;TWO TO DO?
 1075: 1  030C  50 1F                           JNC     RIGHT5                          ;SHIFT TWO NIBBLES
 1076: 1                                ;
 1077: 1                                ; Swap one nibble then exit
 1078: 1                                ;
 1079: 1  030E  C0 00           RIGHT3:         PUSH    R0B0                            ;SAVE POINTER REGISTER
 1080: 1  0310  C0 01                           PUSH    R1B0
 1081: 1                                ;
 1082: 1  0312  79 2E                           MOV     R1,#FP_DIG78                    ;LOAD THE POINTERS
 1083: 1  0314  78 2D                           MOV     R0,#FP_DIG56
 1084: 1  0316  EC                              MOV     A,R4                            ;GET THE OVERFLOW REGISTER
 1085: 1  0317  D7                              XCHD    A,@R1                           ;GET DIGIT 8
 1086: 1  0318  C4                              SWAP    A                               ;FLIP FOR LOAD
 1087: 1  0319  FC                              MOV     R4,A
 1088: 1                                ;
 1089: 1  031A  E7              RIGHTL:         MOV     A,@R1                           ;GET THE LOW ORDER BYTE
 1090: 1  031B  D6                              XCHD    A,@R0                           ;SWAP NIBBLES
 1091: 1  031C  C4                              SWAP    A                               ;FLIP FOR STORE
 1092: 1  031D  F7                              MOV     @R1,A                           ;SAVE THE DIGITS
 1093: 1  031E  18                              DEC     R0                              ;BUMP THE POINTERS
 1094: 1  031F  19                              DEC     R1
 1095: 1  0320  B9 2A F7                        CJNE    R1,#FP_DIG12-1,RIGHTL           ;LOOP
 1096: 1                                ;
 1097: 1  0323  E7                              MOV     A,@R1                           ;ACC = CH8
 1098: 1  0324  C4                              SWAP    A                               ;ACC = 8CH
 1099: 1  0325  54 0F                           ANL     A,#0FH                          ;ACC = 0CH
 1100: 1  0327  F7                              MOV     @R1,A                           ;CARRY DONE
 1101: 1  0328  D0 01                           POP     R1B0                            ;EXIT
 1102: 1  032A  D0 00                           POP     R0B0                            ;RESTORE REGISTER
 1103: 1  032C  22                              RET
 1104: 1                                ;
 1105: 1  032D  FF              RIGHT5:         MOV     R7,A                            ;SAVE THE NEW SHIFT NUMBER
 1106: 1  032E  E4                              CLR     A
 1107: 1  032F  C5 2A                           XCH     A,FP_CARRY                      ;SWAP THE NIBBLES
 1108: 1  0331  C5 2B                           XCH     A,FP_DIG12
 1109: 1  0333  C5 2C                           XCH     A,FP_DIG34
 1110: 1  0335  C5 2D                           XCH     A,FP_DIG56
 1111: 1  0337  C5 2E                           XCH     A,FP_DIG78
 1112: 1  0339  FC                              MOV     R4,A                            ;SAVE THE LAST DIGIT SHIFTED
 1113: 1  033A  80 CB                           SJMP    RIGHT1+1
 1114: 1                                ;
 1115: 1                                ;***************************************************************
 1116: 1                                ;
 1117: 1  033C                  LEFT:   ; Shift ACCUMULATOR LEFT the number of nibbles in R7
 1118: 1                                ;
 1119: 1                                ;***************************************************************
 1120: 1                                ;
 1121: 1  033C  7C 00                           MOV     R4,#00H                         ;CLEAR FOR SOME ENTRYS
 1122: 1                                ;
 1123: 1  033E  C3              LEFT1:          CLR     C
 1124: 1  033F  EF                              MOV     A,R7                            ;GET SHIFT VALUE
 1125: 1  0340  60 22                           JZ      LEFT5-1                         ;EXIT IF ZERO
 1126: 1  0342  94 02                           SUBB    A,#2                            ;SEE HOW MANY BYTES TO SHIFT
 1127: 1  0344  50 1F                           JNC     LEFT5
 1128: 1                                ;
 1129: 1  0346  C0 00           LEFT3:          PUSH    R0B0                            ;SAVE POINTER
 1130: 1  0348  C0 01                           PUSH    R1B0
 1131: 1  034A  78 2A                           MOV     R0,#FP_CARRY
 1132: 1  034C  79 2B                           MOV     R1,#FP_DIG12
 1133: 1                                ;
 1134: 1  034E  E6                              MOV     A,@R0                           ;ACC=CHCL
 1135: 1  034F  C4                              SWAP    A                               ;ACC = CLCH
 1136: 1  0350  F6                              MOV     @R0,A                           ;ACC = CLCH, @R0 = CLCH
 1137: 1                                ;
 1138: 1  0351  E7              LEFTL:          MOV     A,@R1                           ;DIG 12
 1139: 1  0352  C4                              SWAP    A                               ;DIG 21
 1140: 1  0353  D6                              XCHD    A,@R0
 1141: 1  0354  F7                              MOV     @R1,A                           ;SAVE IT
 1142: 1  0355  08                              INC     R0                              ;BUMP POINTERS
 1143: 1  0356  09                              INC     R1
 1144: 1  0357  B8 2E F7                        CJNE    R0,#FP_DIG78,LEFTL
 1145: 1                                ;
 1146: 1  035A  EC                              MOV     A,R4
 1147: 1  035B  C4                              SWAP    A
 1148: 1  035C  D6                              XCHD    A,@R0
 1149: 1  035D  54 F0                           ANL     A,#0F0H
 1150: 1  035F  FC                              MOV     R4,A
 1151: 1                                ;
 1152: 1  0360  D0 01                           POP     R1B0
 1153: 1  0362  D0 00                           POP     R0B0                            ;RESTORE
 1154: 1  0364  22                              RET                                     ;DONE
 1155: 1                                ;
 1156: 1  0365  FF              LEFT5:          MOV     R7,A                            ;RESTORE COUNT
 1157: 1  0366  E4                              CLR     A
 1158: 1  0367  CC                              XCH     A,R4                            ;GET THE RESTORATION BYTE
 1159: 1  0368  C5 2E                           XCH     A,FP_DIG78                      ;DO THE SWAP
 1160: 1  036A  C5 2D                           XCH     A,FP_DIG56
 1161: 1  036C  C5 2C                           XCH     A,FP_DIG34
 1162: 1  036E  C5 2B                           XCH     A,FP_DIG12
 1163: 1  0370  C5 2A                           XCH     A,FP_CARRY
 1164: 1  0372  80 CB                           SJMP    LEFT1+1
 1165: 1                                ;
 1166: 1  0374                  MUL_NIBBLE:
 1167: 1                                ;
 1168: 1                                ; Multiply the nibble in R7 by the FP_NIB locations
 1169: 1                                ; accumulate the product in FP_ACC
 1170: 1                                ;
 1171: 1                                ; Set up the pointers for multiplication
 1172: 1                                ;
 1173: 1  0374  54 0F                           ANL     A,#0FH                          ;STRIP OFF MS NIBBLE
 1174: 1  0376  FF                              MOV     R7,A
 1175: 1  0377  78 3C                           MOV     R0,#FP_ACC8
 1176: 1  0379  79 32                           MOV     R1,#FP_NIB8
 1177: 1  037B  E4                              CLR     A
 1178: 1  037C  F5 33                           MOV     FP_ACCX,A
 1179: 1                                ;
 1180: 1  037E  18              MNLOOP:         DEC     R0                              ;BUMP POINTER TO PROPAGATE CARRY
 1181: 1  037F  26                              ADD     A,@R0                           ;ATTEMPT TO FORCE CARRY
 1182: 1  0380  D4                              DA      A                               ;BCD ADJUST
 1183: 1  0381  30 E4 03                        JNB     ACC.4,MNL0                      ;DON'T ADJUST IF NO NEED
 1184: 1  0384  18                              DEC     R0                              ;PROPAGATE CARRY TO THE NEXT DIGIT
 1185: 1  0385  06                              INC     @R0                             ;DO THE ADJUSTING
 1186: 1  0386  08                              INC     R0                              ;RESTORE R0
 1187: 1                                ;
 1188: 1  0387  D6              MNL0:           XCHD    A,@R0                           ;RESTORE INITIAL NUMBER
 1189: 1  0388  8F F0                           MOV     B,R7                            ;GET THE NUBBLE TO MULTIPLY
 1190: 1  038A  E7                              MOV     A,@R1                           ;GET THE OTHER NIBBLE
 1191: 1  038B  A4                              MUL     AB                              ;DO THE MULTIPLY
 1192: 1  038C  75 F0 0A                        MOV     B,#10                           ;NOW BCD ADJUST
 1193: 1  038F  84                              DIV     AB
 1194: 1  0390  C5 F0                           XCH     A,B                             ;GET THE REMAINDER
 1195: 1  0392  26                              ADD     A,@R0                           ;PROPAGATE THE PARTIAL PRODUCTS
 1196: 1  0393  D4                              DA      A                               ;BCD ADJUST
 1197: 1  0394  30 E4 02                        JNB     ACC.4,MNL1                      ;PROPAGATE PARTIAL PRODUCT CARRY
 1198: 1  0397  05 F0                           INC     B
 1199: 1                                ;
 1200: 1  0399  08              MNL1:           INC     R0
 1201: 1  039A  D6                              XCHD    A,@R0                           ;SAVE THE NEW PRODUCT
 1202: 1  039B  18                              DEC     R0
 1203: 1  039C  E5 F0                           MOV     A,B                             ;GET BACK THE QUOTIENT
 1204: 1  039E  19                              DEC     R1
 1205: 1  039F  B9 2A DC                        CJNE    R1,#FP_NIB1-1,MNLOOP
 1206: 1                                ;
 1207: 1  03A2  25 33                           ADD     A,FP_ACCX                       ;GET THE OVERFLOW
 1208: 1  03A4  D4                              DA      A                               ;ADJUST
 1209: 1  03A5  F6                              MOV     @R0,A                           ;SAVE IT
 1210: 1  03A6  22                              RET                                     ;EXIT
 1211: 1                                ;
 1212: 1                                ;***************************************************************
 1213: 1                                ;
 1214: 1  03A7                  LOAD_POINTERS:  ; Load the ARG_STACK into R0 and bump R1
 1215: 1                                ;
 1216: 1                                ;***************************************************************
 1217: 1                                ;
 1218: 1  03A7  75 A0 01                        MOV     P2,#ARG_STACK_PAGE
 1219: 1  03AA  A8 24                           MOV     R0,ARG_STACK
 1220: 1  03AC  74 06                           MOV     A,#FP_NUMBER_SIZE
 1221: 1  03AE  28                              ADD     A,R0
 1222: 1  03AF  F9                              MOV     R1,A
 1223: 1  03B0  22                              RET
 1224: 1                                ;
 1225: 1                                ;***************************************************************
 1226: 1                                ;
 1227: 1  03B1                  MUL_DIV_EXP_AND_SIGN:
 1228: 1                                ;
 1229: 1                                ; Load the sign into R7, R6. R5 gets the sign for
 1230: 1                                ; multiply and divide.
 1231: 1                                ;
 1232: 1                                ;***************************************************************
 1233: 1                                ;
 1234: 1  03B1  51 FB                           ACALL   FP_CLEAR                        ;CLEAR INTERNAL MEMORY
 1235: 1                                ;
 1236: 1  03B3  71 A7           MDES1:          ACALL   LOAD_POINTERS                   ;LOAD REGISTERS
 1237: 1  03B5  E2                              MOVX    A,@R0                           ;ARG 1 EXP
 1238: 1  03B6  FF                              MOV     R7,A                            ;SAVED IN R7
 1239: 1  03B7  E3                              MOVX    A,@R1                           ;ARG 2 EXP
 1240: 1  03B8  FE                              MOV     R6,A                            ;SAVED IN R6
 1241: 1  03B9  18                              DEC     R0                              ;BUMP POINTERS TO SIGN
 1242: 1  03BA  19                              DEC     R1
 1243: 1  03BB  E2                              MOVX    A,@R0                           ;GET THE SIGN
 1244: 1  03BC  FC                              MOV     R4,A                            ;SIGN OF ARG1
 1245: 1  03BD  E3                              MOVX    A,@R1                           ;GET SIGN OF NEXT ARG
 1246: 1  03BE  FB                              MOV     R3,A                            ;SIGN OF ARG2
 1247: 1  03BF  6C                              XRL     A,R4                            ;ACC GETS THE NEW SIGN
 1248: 1  03C0  FD                              MOV     R5,A                            ;R5 GETS THE NEW SIGN
 1249: 1                                ;
 1250: 1                                ; Bump the pointers to point at the LS digit
 1251: 1                                ;
 1252: 1  03C1  18                              DEC     R0
 1253: 1  03C2  19                              DEC     R1
 1254: 1                                ;
 1255: 1  03C3  22                              RET
 1256: 1                                ;
 1257: 1                                ;***************************************************************
 1258: 1                                ;
 1259: 1  03C4                  LOADR1_MANTISSA:
 1260: 1                                ;
 1261: 1                                ; Load the mantissa of R0 into FP_Digits
 1262: 1                                ;
 1263: 1                                ;***************************************************************
 1264: 1                                ;
 1265: 1  03C4  C0 00                           PUSH    R0B0                            ;SAVE REGISTER 1
 1266: 1  03C6  78 2E                           MOV     R0,#FP_DIG78                    ;SET UP THE POINTER
 1267: 1                                ;
 1268: 1  03C8  E3              LOADR1:         MOVX    A,@R1
 1269: 1  03C9  F6                              MOV     @R0,A
 1270: 1  03CA  19                              DEC     R1
 1271: 1  03CB  18                              DEC     R0
 1272: 1  03CC  B8 2A F9                        CJNE    R0,#FP_CARRY,LOADR1
 1273: 1                                ;
 1274: 1  03CF  D0 00                           POP     R0B0
 1275: 1  03D1  22                              RET
 1276: 1                                ;
 1277: 1                                ;***************************************************************
 1278: 1                                ;
 1279: 1  03D2                  HEXSCAN:        ; Scan a string to determine if it is a hex number
 1280: 1                                        ; set carry if hex, else carry = 0
 1281: 1                                ;
 1282: 1                                ;***************************************************************
 1283: 1                                ;
 1284: 1  03D2  91 A8                           ACALL   GET_DPTR_CHARACTER
 1285: 1  03D4  C0 83                           PUSH    DPH
 1286: 1  03D6  C0 82                           PUSH    DPL                             ;SAVE THE POINTER
 1287: 1                                ;
 1288: 1  03D8  E0              HEXSC1:         MOVX    A,@DPTR                         ;GET THE CHARACTER
 1289: 1  03D9  D1 B6                           ACALL   DIGIT_CHECK                     ;SEE IF A DIGIT
 1290: 1  03DB  40 12                           JC      HS1                             ;CONTINUE IF A DIGIT
 1291: 1  03DD  71 F2                           ACALL   HEX_CHECK                       ;SEE IF HEX
 1292: 1  03DF  40 0E                           JC      HS1
 1293: 1                                ;
 1294: 1  03E1  C2 E5                           CLR     ACC.5                           ;NO LOWER CASE
 1295: 1  03E3  B4 48 03                        CJNE    A,#'H',HEXDON
 1296: 1  03E6  D3                              SETB    C
 1297: 1  03E7  80 01                           SJMP    HEXDO1                          ;NUMBER IS VALID HEX, MAYBE
 1298: 1                                ;
 1299: 1  03E9  C3              HEXDON:         CLR     C
 1300: 1                                ;
 1301: 1  03EA  D0 82           HEXDO1:         POP     DPL                             ;RESTORE POINTER
 1302: 1  03EC  D0 83                           POP     DPH
 1303: 1  03EE  22                              RET
 1304: 1                                ;
 1305: 1  03EF  A3              HS1:            INC     DPTR                            ;BUMP TO NEXT CHARACTER
 1306: 1  03F0  80 E6                           SJMP    HEXSC1                          ;LOOP
 1307: 1                                ;
 1308: 1  03F2                  HEX_CHECK:      ;CHECK FOR A VALID ASCII HEX, SET CARRY IF FOUND
 1309: 1                                ;
 1310: 1  03F2  C2 E5                           CLR     ACC.5                           ;WASTE LOWER CASE
 1311: 1  03F4  B4 47 00                        CJNE    A,#'F'+1,$+3                    ;SEE IF F OR LESS
 1312: 1  03F7  40 01                           JC      HC1
 1313: 1  03F9  22                              RET
 1314: 1                                ;
 1315: 1  03FA  B4 41 00        HC1:            CJNE    A,#'A',$+3                      ;SEE IF A OR GREATER
 1316: 1  03FD  B3                              CPL     C
 1317: 1  03FE  22                              RET
 1318: 1                                ;
 1319: 1                                ;
 1320: 1  03FF                  PUSHR2R0:
 1321: 1                                ;
 1322: 1  03FF  7B 00                           MOV     R3,#HIGH CONVT                  ;CONVERSION LOCATION
 1323: 1  0401  79 48                           MOV     R1,#LOW CONVT
 1324: 1  0403  D1 40                           ACALL   CONVERT_BINARY_TO_ASCII_STRING
 1325: 1  0405  74 0D                           MOV     A,#0DH                          ;A CR TO TERMINATE
 1326: 1  0407  F3                              MOVX    @R1,A                           ;SAVE THE CR
 1327: 1  0408  90 00 48                        MOV     DPTR,#CONVT
 1328: 1                                ;
 1329: 1                                ; Falls thru to FLOATING INPUT
 1330: 1                                ;
 1331: 1                                ;***************************************************************
 1332: 1                                ;
 1333: 1  040B                  FLOATING_POINT_INPUT:   ; Input a floating point number pointed to by the DPTR
 1334: 1                                ;
 1335: 1                                ;***************************************************************
 1336: 1                                ;
 1337: 1  040B  51 FB                           ACALL   FP_CLEAR                        ;CLEAR EVERYTHING
 1338: 1  040D  91 A8                           ACALL   GET_DPTR_CHARACTER
 1339: 1  040F  91 AE                           ACALL   PLUS_MINUS_TEST
 1340: 1  0411  92 78                           MOV     MSIGN,C                         ;SAVE THE MANTISSA SIGN
 1341: 1                                ;
 1342: 1                                ; Now, set up for input loop
 1343: 1                                ;
 1344: 1  0413  78 34                           MOV     R0,#FP_ACCC
 1345: 1  0415  7E 7F                           MOV     R6,#7FH                         ;BASE EXPONENT
 1346: 1  0417  D2 D5                           SETB    F0                              ;SET INITIAL FLAG
 1347: 1                                ;
 1348: 1  0419  D1 B4           INLOOP:         ACALL   GET_DIGIT_CHECK
 1349: 1  041B  50 07                           JNC     GTEST                           ;IF NOT A CHARACTER, WHAT IS IT?
 1350: 1  041D  54 0F                           ANL     A,#0FH                          ;STRIP ASCII
 1351: 1  041F  91 81                           ACALL   STDIG                           ;STORE THE DIGITS
 1352: 1                                ;
 1353: 1  0421  A3              INLPIK:         INC     DPTR                            ;BUMP POINTER FOR LOOP
 1354: 1  0422  80 F5                           SJMP    INLOOP                          ;LOOP FOR INPUT
 1355: 1                                ;
 1356: 1  0424  B4 2E 0C        GTEST:          CJNE    A,#'.',GT1                      ;SEE IF A RADIX
 1357: 1  0427  20 51 63                        JB      FOUND_RADIX,INERR
 1358: 1  042A  D2 51                           SETB    FOUND_RADIX
 1359: 1  042C  B8 34 F2                        CJNE    R0,#FP_ACCC,INLPIK
 1360: 1  042F  D2 52                           SETB    FIRST_RADIX                     ;SET IF FIRST RADIX
 1361: 1  0431  80 EE                           SJMP    INLPIK                          ;GET ADDITIONAL DIGITS
 1362: 1                                ;
 1363: 1  0433  20 D5 57        GT1:            JB      F0,INERR                        ;ERROR IF NOT CLEARED
 1364: 1  0436  B4 65 02                        CJNE    A,#'e',$+5                      ;CHECK FOR LOWER CASE
 1365: 1  0439  80 03                           SJMP    $+5
 1366: 1  043B  B4 45 33                        CJNE    A,#'E',FINISH_UP
 1367: 1  043E  91 A7                           ACALL   INC_AND_GET_DPTR_CHARACTER
 1368: 1  0440  91 AE                           ACALL   PLUS_MINUS_TEST
 1369: 1  0442  92 50                           MOV     XSIGN,C                         ;SAVE SIGN STATUS
 1370: 1  0444  D1 B4                           ACALL   GET_DIGIT_CHECK
 1371: 1  0446  50 45                           JNC     INERR
 1372: 1                                ;
 1373: 1  0448  54 0F                           ANL     A,#0FH                          ;STRIP ASCII BIAS OFF THE CHARACTER
 1374: 1  044A  FD                              MOV     R5,A                            ;SAVE THE CHARACTER IN R5
 1375: 1                                ;
 1376: 1  044B  A3              GT2:            INC     DPTR
 1377: 1  044C  D1 B4                           ACALL   GET_DIGIT_CHECK
 1378: 1  044E  50 0D                           JNC     FINISH1
 1379: 1  0450  54 0F                           ANL     A,#0FH                          ;STRIP OFF BIAS
 1380: 1  0452  CD                              XCH     A,R5                            ;GET THE LAST DIGIT
 1381: 1  0453  75 F0 0A                        MOV     B,#10                           ;MULTIPLY BY TEN
 1382: 1  0456  A4                              MUL     AB
 1383: 1  0457  2D                              ADD     A,R5                            ;ADD TO ORIGINAL VALUE
 1384: 1  0458  FD                              MOV     R5,A                            ;SAVE IN R5
 1385: 1  0459  50 F0                           JNC     GT2                             ;LOOP IF NO CARRY
 1386: 1  045B  7D FF                           MOV     R5,#0FFH                        ;FORCE AN ERROR
 1387: 1                                ;
 1388: 1  045D  ED              FINISH1:        MOV     A,R5                            ;GET THE SIGN
 1389: 1  045E  30 50 09                        JNB     XSIGN,POSNUM                    ;SEE IF EXPONENT IS POS OR NEG
 1390: 1  0461  C3                              CLR     C
 1391: 1  0462  9E                              SUBB    A,R6
 1392: 1  0463  F4                              CPL     A
 1393: 1  0464  04                              INC     A
 1394: 1  0465  40 09                           JC      FINISH2
 1395: 1  0467  74 01                           MOV     A,#01H
 1396: 1  0469  22                              RET
 1397: 1                                ;
 1398: 1  046A  2E              POSNUM:         ADD     A,R6                            ;ADD TO EXPONENT
 1399: 1  046B  50 03                           JNC     FINISH2
 1400: 1                                ;
 1401: 1  046D  74 02           POSNM1:         MOV     A,#02H
 1402: 1  046F  22                              RET
 1403: 1                                ;
 1404: 1  0470  CE              FINISH2:        XCH     A,R6                            ;SAVE THE EXPONENT
 1405: 1                                ;
 1406: 1  0471                  FINISH_UP:
 1407: 1                                ;
 1408: 1  0471  8E 30                           MOV     FP_EXP,R6                       ;SAVE EXPONENT
 1409: 1  0473  B8 34 02                        CJNE    R0,#FP_ACCC,$+5
 1410: 1  0476  51 FB                           ACALL   FP_CLEAR                        ;CLEAR THE MEMORY IF 0
 1411: 1  0478  E5 24                           MOV     A,ARG_STACK                     ;GET THE ARG STACK
 1412: 1  047A  C3                              CLR     C
 1413: 1  047B  94 0C                           SUBB    A,#FP_NUMBER_SIZE+FP_NUMBER_SIZE
 1414: 1  047D  F5 24                           MOV     ARG_STACK,A                     ;ADJUST FOR STORE
 1415: 1  047F  41 6C                           AJMP    PACK
 1416: 1                                ;
 1417: 1  0481  C2 D5           STDIG:          CLR     F0                              ;CLEAR INITIAL DESIGNATOR
 1418: 1  0483  70 0B                           JNZ     STDIG1                          ;CONTINUE IF NOT ZERO
 1419: 1  0485  B8 34 08                        CJNE    R0,#FP_ACCC,STDIG1
 1420: 1  0488  30 52 04                        JNB     FIRST_RADIX,RET_X
 1421: 1                                ;
 1422: 1  048B  DE 02           DECX:           DJNZ    R6,RET_X
 1423: 1                                ;
 1424: 1  048D  74 FF           INERR:          MOV     A,#0FFH
 1425: 1                                ;
 1426: 1  048F  22              RET_X:          RET
 1427: 1                                ;
 1428: 1  0490  20 53 02        STDIG1:         JB      DONE_LOAD,FRTEST
 1429: 1  0493  C2 52                           CLR     FIRST_RADIX
 1430: 1                                ;
 1431: 1  0495  20 52 F3        FRTEST:         JB      FIRST_RADIX,DECX
 1432: 1                                ;
 1433: 1  0498  20 51 01        FDTEST:         JB      FOUND_RADIX,FDT1
 1434: 1  049B  0E                              INC     R6
 1435: 1                                ;
 1436: 1  049C  20 53 F0        FDT1:           JB      DONE_LOAD,RET_X
 1437: 1  049F  B8 3D 02                        CJNE    R0,#FP_ACC8+1,FDT2
 1438: 1  04A2  D2 53                           SETB    DONE_LOAD
 1439: 1                                ;
 1440: 1  04A4  F6              FDT2:           MOV     @R0,A                           ;SAVE THE STRIPPED ACCUMULATOR
 1441: 1  04A5  08                              INC     R0                              ;BUMP THE POINTER
 1442: 1  04A6  22                              RET                                     ;EXIT
 1443: 1                                ;
 1444: 1                                ;***************************************************************
 1445: 1                                ;
 1446: 1                                ; I/O utilities
 1447: 1                                ;
 1448: 1                                ;***************************************************************
 1449: 1                                ;
 1450: 1  04A7                  INC_AND_GET_DPTR_CHARACTER:
 1451: 1                                ;
 1452: 1  04A7  A3                              INC     DPTR
 1453: 1                                ;
 1454: 1  04A8                  GET_DPTR_CHARACTER:
 1455: 1                                ;
 1456: 1  04A8  E0                              MOVX    A,@DPTR                         ;GET THE CHARACTER
 1457: 1  04A9  B4 20 16                        CJNE    A,#' ',PMT1                     ;SEE IF A SPACE
 1458: 1                                ;
 1459: 1                                ; Kill spaces
 1460: 1                                ;
 1461: 1  04AC  80 F9                           SJMP    INC_AND_GET_DPTR_CHARACTER
 1462: 1                                ;
 1463: 1  04AE                  PLUS_MINUS_TEST:
 1464: 1                                ;
 1465: 1  04AE  B4 E3 02                        CJNE    A,#0E3H,$+5                     ;SEE IF A PLUS, PLUS TOKEN FROM BASIC
 1466: 1  04B1  80 0E                           SJMP    PMT3
 1467: 1  04B3  B4 2B 02                        CJNE    A,#'+',$+5
 1468: 1  04B6  80 09                           SJMP    PMT3
 1469: 1  04B8  B4 E5 02                        CJNE    A,#0E5H,$+5                     ;SEE IF MINUS, MINUS TOKEN FROM BASIC
 1470: 1  04BB  80 03                           SJMP    PMT2
 1471: 1  04BD  B4 2D 02                        CJNE    A,#'-',PMT1
 1472: 1                                ;
 1473: 1  04C0  D3              PMT2:           SETB    C
 1474: 1                                ;
 1475: 1  04C1  A3              PMT3:           INC     DPTR
 1476: 1                                ;
 1477: 1  04C2  22              PMT1:           RET
 1478: 1                                ;
 1479: 1                                ;***************************************************************
 1480: 1                                ;
 1481: 1  04C3                  FLOATING_POINT_OUTPUT:  ; Output the number, format is in location 25
 1482: 1                                ;
 1483: 1                                ; IF FORMAT = 00 - FREE FLOATING
 1484: 1                                ;           = FX - EXPONENTIAL (X IS THE NUMBER OF SIG DIGITS)
 1485: 1                                ;           = NX - N = NUM BEFORE RADIX, X = NUM AFTER RADIX
 1486: 1                                ;                  N + X = 8 MAX
 1487: 1                                ;
 1488: 1                                ;***************************************************************
 1489: 1                                ;
 1490: 1  04C3  71 B3                           ACALL   MDES1                           ;GET THE NUMBER TO OUTPUT, R0 IS POINTER
 1491: 1  04C5  31 04                           ACALL   POP_AND_EXIT                    ;OUTPUT POPS THE STACK
 1492: 1  04C7  EF                              MOV     A,R7
 1493: 1  04C8  FE                              MOV     R6,A                            ;PUT THE EXPONENT IN R6
 1494: 1  04C9  51 C7                           ACALL   UNPACK_R0                       ;UNPACK THE NUMBER
 1495: 1  04CB  78 2B                           MOV     R0,#FP_NIB1                     ;POINT AT THE NUMBER
 1496: 1  04CD  E5 25                           MOV     A,FORMAT                        ;GET THE FORMAT
 1497: 1  04CF  FB                              MOV     R3,A                            ;SAVE IN CASE OF EXP FORMAT
 1498: 1  04D0  60 49                           JZ      FREE                            ;FREE FLOATING?
 1499: 1  04D2  B4 F0 00                        CJNE    A,#0F0H,$+3                     ;SEE IF EXPONENTIAL
 1500: 1  04D5  50 73                           JNC     EXPOUT
 1501: 1                                ;
 1502: 1                                ; If here, must be integer USING format
 1503: 1                                ;
 1504: 1  04D7  EE                              MOV     A,R6                            ;GET THE EXPONENT
 1505: 1  04D8  70 02                           JNZ     $+4
 1506: 1  04DA  7E 80                           MOV     R6,#80H
 1507: 1  04DC  EB                              MOV     A,R3                            ;GET THE FORMAT
 1508: 1  04DD  C4                              SWAP    A                                       ;SPLIT INTEGER AND FRACTION
 1509: 1  04DE  54 0F                           ANL     A,#0FH
 1510: 1  04E0  FA                              MOV     R2,A                            ;SAVE INTEGER
 1511: 1  04E1  B1 B0                           ACALL   NUM_LT                          ;GET THE NUMBER OF INTEGERS
 1512: 1  04E3  CA                              XCH     A,R2                            ;FLIP FOR SUBB
 1513: 1  04E4  C3                              CLR             C
 1514: 1  04E5  9A                              SUBB    A,R2
 1515: 1  04E6  FF                              MOV     R7,A
 1516: 1  04E7  50 06                           JNC     $+8
 1517: 1  04E9  7D 3F                           MOV     R5,#'?'                         ;OUTPUT A QUESTION MARK
 1518: 1  04EB  B1 E5                           ACALL   SOUT1                           ;NUMBER IS TOO LARGE FOR FORMAT
 1519: 1  04ED  A1 1B                           AJMP    FREE
 1520: 1  04EF  BA 00 07                        CJNE    R2,#00,USING0                   ;SEE IF ZERO
 1521: 1  04F2  1F                              DEC     R7
 1522: 1  04F3  B1 D2                           ACALL   SS7
 1523: 1  04F5  B1 DF                           ACALL   ZOUT                            ;OUTPUT A ZERO
 1524: 1  04F7  80 06                           SJMP    USING1
 1525: 1                                ;
 1526: 1  04F9  B1 D2           USING0:         ACALL   SS7                             ;OUTPUT SPACES, IF NEED TO
 1527: 1  04FB  EA                              MOV     A,R2                            ;OUTPUT DIGITS
 1528: 1  04FC  FF                              MOV     R7,A
 1529: 1  04FD  B1 94                           ACALL   OUTR0
 1530: 1                                ;
 1531: 1  04FF  EB              USING1:         MOV     A,R3
 1532: 1  0500  54 0F                           ANL     A,#0FH                          ;GET THE NUMBER RIGHT OF DP
 1533: 1  0502  FA                              MOV     R2,A                            ;SAVE IT
 1534: 1  0503  60 BD                           JZ      PMT1                            ;EXIT IF ZERO
 1535: 1  0505  B1 DB                           ACALL   ROUT                            ;OUTPUT DP
 1536: 1  0507  B1 B9                           ACALL   NUM_RT
 1537: 1  0509  B5 02 03                        CJNE    A,2,USINGX                      ;COMPARE A TO R2
 1538: 1                                ;
 1539: 1  050C  EA              USINGY:         MOV     A,R2
 1540: 1  050D  A1 C9                           AJMP    Z7R7
 1541: 1                                ;
 1542: 1  050F  50 FB           USINGX:         JNC     USINGY
 1543: 1                                ;
 1544: 1  0511  CA              USING2:         XCH     A,R2
 1545: 1  0512  C3                              CLR     C
 1546: 1  0513  9A                              SUBB    A,R2
 1547: 1  0514  CA                              XCH     A,R2
 1548: 1  0515  B1 C9                           ACALL   Z7R7                            ;OUTPUT ZEROS IF NEED TO
 1549: 1  0517  EA                              MOV     A,R2
 1550: 1  0518  FF                              MOV     R7,A
 1551: 1  0519  A1 94                           AJMP    OUTR0
 1552: 1                                ;
 1553: 1                                ; First, force exponential output, if need to
 1554: 1                                ;
 1555: 1  051B  EE              FREE:           MOV     A,R6                            ;GET THE EXPONENT
 1556: 1  051C  70 04                           JNZ     FREE1                           ;IF ZERO, PRINT IT
 1557: 1  051E  B1 E3                           ACALL   SOUT
 1558: 1  0520  A1 DF                           AJMP    ZOUT
 1559: 1                                ;
 1560: 1  0522  7B F0           FREE1:          MOV     R3,#0F0H                        ;IN CASE EXP NEEDED
 1561: 1  0524  74 77                           MOV     A,#80H-DIGIT-DIGIT-1
 1562: 1  0526  2E                              ADD     A,R6
 1563: 1  0527  40 21                           JC      EXPOUT
 1564: 1  0529  94 F7                           SUBB    A,#0F7H
 1565: 1  052B  40 1D                           JC      EXPOUT
 1566: 1                                ;
 1567: 1                                ; Now, just print the number
 1568: 1                                ;
 1569: 1  052D  B1 D4                           ACALL   SINOUT                          ;PRINT THE SIGN OF THE NUMBER
 1570: 1  052F  B1 B0                           ACALL   NUM_LT                          ;GET THE NUMBER LEFT OF DP
 1571: 1  0531  B4 08 02                        CJNE    A,#8,FREE4
 1572: 1  0534  A1 94                           AJMP    OUTR0
 1573: 1                                ;
 1574: 1  0536  B1 94           FREE4:          ACALL   OUTR0
 1575: 1  0538  B1 A6                           ACALL   ZTEST                           ;TEST FOR TRAILING ZEROS
 1576: 1  053A  60 57                           JZ      U_RET                           ;DONE IF ALL TRAILING ZEROS
 1577: 1  053C  B1 DB                           ACALL   ROUT                            ;OUTPUT RADIX
 1578: 1                                ;
 1579: 1  053E  7F 01           FREE2:          MOV     R7,#1                           ;OUTPUT ONE DIGIT
 1580: 1  0540  B1 94                           ACALL   OUTR0
 1581: 1  0542  70 4F                           JNZ     U_RET
 1582: 1  0544  B1 A6                           ACALL   ZTEST
 1583: 1  0546  60 4B                           JZ      U_RET
 1584: 1  0548  80 F4                           SJMP    FREE2                           ;LOOP
 1585: 1                                ;
 1586: 1  054A  B1 D4           EXPOUT:         ACALL   SINOUT                          ;PRINT THE SIGN
 1587: 1  054C  7F 01                           MOV     R7,#1                           ;OUTPUT ONE CHARACTER
 1588: 1  054E  B1 94                           ACALL   OUTR0
 1589: 1  0550  B1 DB                           ACALL   ROUT                            ;OUTPUT RADIX
 1590: 1  0552  EB                              MOV     A,R3                            ;GET FORMAT
 1591: 1  0553  54 0F                           ANL     A,#0FH                          ;STRIP INDICATOR
 1592: 1  0555  60 06                           JZ      EXPOTX
 1593: 1                                ;
 1594: 1  0557  FF                              MOV     R7,A                            ;OUTPUT THE NUMBER OF DIGITS
 1595: 1  0558  1F                              DEC     R7                              ;ADJUST BECAUSE ONE CHAR ALREADY OUT
 1596: 1  0559  B1 94                           ACALL   OUTR0
 1597: 1  055B  80 02                           SJMP    EXPOT4
 1598: 1                                ;
 1599: 1  055D  B1 3E           EXPOTX:         ACALL   FREE2                           ;OUTPUT UNTIL TRAILING ZEROS
 1600: 1                                ;
 1601: 1  055F  B1 E3           EXPOT4:         ACALL   SOUT                            ;OUTPUT A SPACE
 1602: 1  0561  7D 45                           MOV     R5,#'E'
 1603: 1  0563  B1 E5                           ACALL   SOUT1                           ;OUTPUT AN E
 1604: 1  0565  EE                              MOV     A,R6                            ;GET THE EXPONENT
 1605: 1  0566  60 04                           JZ      XOUT0                           ;EXIT IF ZERO
 1606: 1  0568  14                              DEC     A                               ;ADJUST FOR THE DIGIT ALREADY OUTPUT
 1607: 1  0569  B4 80 05                        CJNE    A,#80H,XOUT2                    ;SEE WHAT IT IS
 1608: 1                                ;
 1609: 1  056C  B1 E3           XOUT0:          ACALL   SOUT
 1610: 1  056E  E4                              CLR     A
 1611: 1  056F  80 0C                           SJMP    XOUT4
 1612: 1                                ;
 1613: 1  0571  40 06           XOUT2:          JC      XOUT3                           ;NEGATIVE EXPONENT
 1614: 1  0573  7D 2B                           MOV     R5,#'+'                         ;OUTPUT A PLUS SIGN
 1615: 1  0575  B1 E5                           ACALL   SOUT1
 1616: 1  0577  80 04                           SJMP    XOUT4
 1617: 1                                ;
 1618: 1  0579  B1 D7           XOUT3:          ACALL   MOUT
 1619: 1  057B  F4                              CPL     A                               ;FLIP BITS
 1620: 1  057C  04                              INC     A                               ;BUMP
 1621: 1                                ;
 1622: 1  057D  C2 E7           XOUT4:          CLR     ACC.7
 1623: 1  057F  F8                              MOV     R0,A
 1624: 1  0580  7A 00                           MOV     R2,#0
 1625: 1  0582  79 48                           MOV     R1,#LOW CONVT                   ;CONVERSION LOCATION
 1626: 1  0584  7B 00                           MOV     R3,#HIGH CONVT
 1627: 1  0586  D1 40                           ACALL   CONVERT_BINARY_TO_ASCII_STRING
 1628: 1  0588  78 48                           MOV     R0,#LOW CONVT                   ;NOW, OUTPUT EXPONENT
 1629: 1                                ;
 1630: 1  058A  E2              EXPOT5:         MOVX    A,@R0                           ;GET THE CHARACTER
 1631: 1  058B  FD                              MOV     R5,A                            ;OUTPUT IT
 1632: 1  058C  B1 E5                           ACALL   SOUT1
 1633: 1  058E  08                              INC     R0                              ;BUMP THE POINTER
 1634: 1  058F  E8                              MOV     A,R0                            ;GET THE POINTER
 1635: 1  0590  B5 01 F7                        CJNE    A,R1B0,EXPOT5                   ;LOOP
 1636: 1                                ;
 1637: 1  0593  22              U_RET:          RET                                     ;EXIT
 1638: 1                                ;
 1639: 1  0594                  OUTR0:  ; Output the characters pointed to by R0, also bias ascii
 1640: 1                                ;
 1641: 1  0594  EF                              MOV     A,R7                            ;GET THE COUNTER
 1642: 1  0595  60 0E                           JZ      OUTR                            ;EXIT IF DONE
 1643: 1  0597  E6                              MOV     A,@R0                           ;GET THE NUMBER
 1644: 1  0598  44 30                           ORL     A,#30H                          ;ASCII BIAS
 1645: 1  059A  08                              INC     R0                              ;BUMP POINTER AND COUNTER
 1646: 1  059B  1F                              DEC     R7
 1647: 1  059C  FD                              MOV     R5,A                            ;PUT CHARACTER IN OUTPUT REGISTER
 1648: 1  059D  B1 E5                           ACALL   SOUT1                           ;OUTPUT THE CHARACTER
 1649: 1  059F  E4                              CLR     A                               ;JUST FOR TEST
 1650: 1  05A0  B8 33 F1                        CJNE    R0,#FP_NIB8+1,OUTR0
 1651: 1  05A3  74 55                           MOV     A,#55H                          ;KNOW WHERE EXIT OCCURED
 1652: 1                                ;
 1653: 1  05A5  22              OUTR:           RET
 1654: 1                                ;
 1655: 1  05A6  A9 00           ZTEST:          MOV     R1,R0B0                         ;GET POINTER REGISTER
 1656: 1                                ;
 1657: 1  05A8  E7              ZT0:            MOV     A,@R1                           ;GET THE VALUE
 1658: 1  05A9  70 04                           JNZ     ZT1
 1659: 1  05AB  09                              INC     R1                              ;BUMP POINTER
 1660: 1  05AC  B9 33 F9                        CJNE    R1,#FP_NIB8+1,ZT0
 1661: 1                                ;
 1662: 1  05AF  22              ZT1:            RET
 1663: 1                                ;
 1664: 1  05B0  EE              NUM_LT:         MOV     A,R6                            ;GET EXPONENT
 1665: 1  05B1  C3                              CLR     C                               ;GET READY FOR SUBB
 1666: 1  05B2  94 80                           SUBB    A,#80H                          ;SUB EXPONENT BIAS
 1667: 1  05B4  50 01                           JNC     NL1                             ;OK IF NO CARRY
 1668: 1  05B6  E4                              CLR     A                               ;NO DIGITS LEFT
 1669: 1                                ;
 1670: 1  05B7  FF              NL1:            MOV     R7,A                            ;SAVE THE COUNT
 1671: 1  05B8  22                              RET
 1672: 1                                ;
 1673: 1  05B9  C3              NUM_RT:         CLR     C                               ;SUBB AGAIN
 1674: 1  05BA  74 80                           MOV     A,#80H                          ;EXPONENT BIAS
 1675: 1  05BC  9E                              SUBB    A,R6                            ;GET THE BIASED EXPONENT
 1676: 1  05BD  50 01                           JNC     NR1
 1677: 1  05BF  E4                              CLR     A
 1678: 1                                ;
 1679: 1  05C0  22              NR1:            RET                                     ;EXIT
 1680: 1                                ;
 1681: 1  05C1  EF              SPACE7:         MOV     A,R7                            ;GET THE NUMBER OF SPACES
 1682: 1  05C2  60 FC                           JZ      NR1                             ;EXIT IF ZERO
 1683: 1  05C4  B1 E3                           ACALL   SOUT                            ;OUTPUT A SPACE
 1684: 1  05C6  1F                              DEC     R7                              ;BUMP COUNTER
 1685: 1  05C7  80 F8                           SJMP    SPACE7                          ;LOOP
 1686: 1                                ;
 1687: 1  05C9  FF              Z7R7:           MOV     R7,A
 1688: 1                                ;
 1689: 1  05CA  EF              ZERO7:          MOV     A,R7                            ;GET COUNTER
 1690: 1  05CB  60 F3                           JZ      NR1                             ;EXIT IF ZERO
 1691: 1  05CD  B1 DF                           ACALL   ZOUT                            ;OUTPUT A ZERO
 1692: 1  05CF  1F                              DEC     R7                              ;BUMP COUNTER
 1693: 1  05D0  80 F8                           SJMP    ZERO7                           ;LOOP
 1694: 1                                ;
 1695: 1  05D2  B1 C1           SS7:            ACALL   SPACE7
 1696: 1                                ;
 1697: 1  05D4  EC              SINOUT:         MOV     A,R4                            ;GET THE SIGN
 1698: 1  05D5  60 0C                           JZ      SOUT                            ;OUTPUT A SPACE IF ZERO
 1699: 1                                ;
 1700: 1  05D7  7D 2D           MOUT:           MOV     R5,#'-'
 1701: 1  05D9  80 0A                           SJMP    SOUT1                           ;OUTPUT A MINUS IF NOT
 1702: 1                                ;
 1703: 1  05DB  7D 2E           ROUT:           MOV     R5,#'.'                         ;OUTPUT A RADIX
 1704: 1  05DD  80 06                           SJMP    SOUT1
 1705: 1                                ;
 1706: 1  05DF  7D 30           ZOUT:           MOV     R5,#'0'                         ;OUTPUT A ZERO
 1707: 1  05E1  80 02                           SJMP    SOUT1
 1708: 1                                ;
 1709: 1  05E3  7D 20           SOUT:           MOV     R5,#' '                         ;OUTPUT A SPACE
 1710: 1                                ;
 1711: 1  05E5  C1 C1           SOUT1:          AJMP    R5OUT
 1712: 1                                ;
 1713: 1                                ;***************************************************************
 1714: 1                                ;
 1715: 1  05E7                  CONVERT_ASCII_STRING_TO_BINARY:
 1716: 1                                ;
 1717: 1                                ;DPTR POINTS TO ASCII STRING
 1718: 1                                ;PUT THE BINARY NUMBER IN R2:R0, ERROR IF >64K
 1719: 1                                ;
 1720: 1                                ;***************************************************************
 1721: 1                                ;
 1722: 1  05E7  71 D2           CASB:           ACALL   HEXSCAN                         ;SEE IF HEX NUMBER
 1723: 1  05E9  92 33                           MOV     ADD_IN,C                        ;IF ADD_IN IS SET, THE NUMBER IS HEX
 1724: 1  05EB  D1 B4                           ACALL   GET_DIGIT_CHECK
 1725: 1  05ED  B3                              CPL     C                               ;FLIP FOR EXIT
 1726: 1  05EE  40 28                           JC      RCASB
 1727: 1  05F0  7B 00                           MOV     R3,#00H                         ;ZERO R3:R1 FOR LOOP
 1728: 1  05F2  79 00                           MOV     R1,#00H
 1729: 1  05F4  80 15                           SJMP    CASB5
 1730: 1                                ;
 1731: 1  05F6  A3              CASB2:          INC     DPTR
 1732: 1  05F7  89 00                           MOV     R0B0,R1                         ;SAVE THE PRESENT CONVERTED VALUE
 1733: 1  05F9  8B 02                           MOV     R0B0+2,R3                       ;IN R2:R0
 1734: 1  05FB  D1 B4                           ACALL   GET_DIGIT_CHECK
 1735: 1  05FD  40 0C                           JC      CASB5
 1736: 1  05FF  30 33 16                        JNB     ADD_IN,RCASB                    ;CONVERSION COMPLETE
 1737: 1  0602  71 F2                           ACALL   HEX_CHECK                       ;SEE IF HEX NUMBER
 1738: 1  0604  40 03                           JC      CASB4                           ;PROCEED IF GOOD
 1739: 1  0606  A3                              INC     DPTR                            ;BUMP PAST H
 1740: 1  0607  80 0F                           SJMP    RCASB
 1741: 1                                ;
 1742: 1  0609  24 09           CASB4:          ADD     A,#9                            ;ADJUST HEX ASCII BIAS
 1743: 1                                ;
 1744: 1  060B  75 F0 0A        CASB5:          MOV     B,#10
 1745: 1  060E  30 33 03                        JNB     ADD_IN,CASB6
 1746: 1  0611  75 F0 10                        MOV     B,#16                           ;HEX MODE
 1747: 1                                ;
 1748: 1  0614  D1 1F           CASB6:          ACALL   MULNUM                          ;ACCUMULATE THE DIGITS
 1749: 1  0616  50 DE                           JNC     CASB2                           ;LOOP IF NO CARRY
 1750: 1                                ;
 1751: 1  0618  E4              RCASB:          CLR     A                               ;RESET ACC
 1752: 1  0619  92 E1                           MOV     ACC.OVERFLOW,C                  ;IF OVERFLOW, SAY SO
 1753: 1  061B  22                              RET                                     ;EXIT
 1754: 1                                ;
 1755: 1                                ;
 1756: 1  061C  75 F0 0A        MULNUM10:       MOV     B,#10
 1757: 1                                ;
 1758: 1                                ;***************************************************************
 1759: 1                                ;
 1760: 1  061F                  MULNUM: ; Take the next digit in the acc (masked to 0FH)
 1761: 1                                ; accumulate in R3:R1
 1762: 1                                ;
 1763: 1                                ;***************************************************************
 1764: 1                                ;
 1765: 1  061F  C0 E0                           PUSH    ACC                             ;SAVE ACC
 1766: 1  0621  C0 F0                           PUSH    B                               ;SAVE MULTIPLIER
 1767: 1  0623  E9                              MOV     A,R1                            ;PUT LOW ORDER BITS IN ACC
 1768: 1  0624  A4                              MUL     AB                              ;DO THE MULTIPLY
 1769: 1  0625  F9                              MOV     R1,A                            ;PUT THE RESULT BACK
 1770: 1  0626  EB                              MOV     A,R3                            ;GET THE HIGH ORDER BYTE
 1771: 1  0627  AB F0                           MOV     R3,B                            ;SAVE THE OVERFLOW
 1772: 1  0629  D0 F0                           POP     B                               ;GET THE MULTIPLIER
 1773: 1  062B  A4                              MUL     AB                              ;DO IT
 1774: 1  062C  A2 D2                           MOV     C,OV                            ;SAVE OVERFLOW IN F0
 1775: 1  062E  92 D5                           MOV     F0,C
 1776: 1  0630  2B                              ADD     A,R3                            ;ADD OVERFLOW TO HIGH RESULT
 1777: 1  0631  FB                              MOV     R3,A                            ;PUT IT BACK
 1778: 1  0632  D0 E0                           POP     ACC                             ;GET THE ORIGINAL ACC BACK
 1779: 1  0634  72 D5                           ORL     C,F0                            ;OR CARRY AND OVERFLOW
 1780: 1  0636  40 07                           JC      MULX                            ;NO GOOD IF THE CARRY IS SET
 1781: 1                                ;
 1782: 1  0638  54 0F           MUL11:          ANL     A,#0FH                          ;MASK OFF HIGH ORDER BITS
 1783: 1  063A  29                              ADD     A,R1                            ;NOW ADD THE ACC
 1784: 1  063B  F9                              MOV     R1,A                            ;PUT IT BACK
 1785: 1  063C  E4                              CLR     A                               ;PROPAGATE THE CARRY
 1786: 1  063D  3B                              ADDC    A,R3
 1787: 1  063E  FB                              MOV     R3,A                            ;PUT IT BACK
 1788: 1                                ;
 1789: 1  063F  22              MULX:           RET                                     ;EXIT WITH OR WITHOUT CARRY
 1790: 1                                ;
 1791: 1                                ;***************************************************************
 1792: 1                                ;
 1793: 1  0640                  CONVERT_BINARY_TO_ASCII_STRING:
 1794: 1                                ;
 1795: 1                                ;R3:R1 contains the address of the string
 1796: 1                                ;R2:R0 contains the value to convert
 1797: 1                                ;DPTR, R7, R6, and ACC gets clobbered
 1798: 1                                ;
 1799: 1                                ;***************************************************************
 1800: 1                                ;
 1801: 1  0640  E4                              CLR     A                               ;NO LEADING ZEROS
 1802: 1  0641  90 27 10                        MOV     DPTR,#10000                     ;SUBTRACT 10000
 1803: 1  0644  D1 5D                           ACALL   RSUB                            ;DO THE SUBTRACTION
 1804: 1  0646  90 03 E8                        MOV     DPTR,#1000                      ;NOW 1000
 1805: 1  0649  D1 5D                           ACALL   RSUB
 1806: 1  064B  90 00 64                        MOV     DPTR,#100                       ;NOW 100
 1807: 1  064E  D1 5D                           ACALL   RSUB
 1808: 1  0650  90 00 0A                        MOV     DPTR,#10                        ;NOW 10
 1809: 1  0653  D1 5D                           ACALL   RSUB
 1810: 1  0655  90 00 01                        MOV     DPTR,#1                         ;NOW 1
 1811: 1  0658  D1 5D                           ACALL   RSUB
 1812: 1  065A  60 20                           JZ      RSUB2                           ;JUMP OVER RET
 1813: 1                                ;
 1814: 1  065C  22              RSUB_R:         RET
 1815: 1                                ;
 1816: 1  065D  7E FF           RSUB:           MOV     R6,#-1                          ;SET UP THE COUNTER
 1817: 1                                ;
 1818: 1  065F  0E              RSUB1:          INC     R6                              ;BUMP THE COUNTER
 1819: 1  0660  CA                              XCH     A,R2                            ;DO A FAST COMPARE
 1820: 1  0661  B5 83 00                        CJNE    A,DPH,$+3
 1821: 1  0664  CA                              XCH     A,R2
 1822: 1  0665  40 12                           JC      FAST_DONE
 1823: 1  0667  C8                              XCH     A,R0                            ;GET LOW BYTE
 1824: 1  0668  95 82                           SUBB    A,DPL                           ;SUBTRACT, CARRY IS CLEARED
 1825: 1  066A  C8                              XCH     A,R0                            ;PUT IT BACK
 1826: 1  066B  CA                              XCH     A,R2                            ;GET THE HIGH BYTE
 1827: 1  066C  95 83                           SUBB    A,DPH                           ;ADD THE HIGH BYTE
 1828: 1  066E  CA                              XCH     A,R2                            ;PUT IT BACK
 1829: 1  066F  50 EE                           JNC     RSUB1                           ;LOOP UNTIL CARRY
 1830: 1                                ;
 1831: 1  0671  C8                              XCH     A,R0
 1832: 1  0672  25 82                           ADD     A,DPL                           ;RESTORE R2:R0
 1833: 1  0674  C8                              XCH     A,R0
 1834: 1  0675  CA                              XCH     A,R2
 1835: 1  0676  35 83                           ADDC    A,DPH
 1836: 1  0678  CA                              XCH     A,R2
 1837: 1                                ;
 1838: 1  0679                  FAST_DONE:
 1839: 1                                ;
 1840: 1  0679  4E                              ORL     A,R6                            ;OR THE COUNT VALUE
 1841: 1  067A  60 E0                           JZ      RSUB_R                          ;RETURN IF ZERO
 1842: 1                                ;
 1843: 1  067C  74 30           RSUB2:          MOV     A,#'0'                          ;GET THE ASCII BIAS
 1844: 1  067E  2E                              ADD     A,R6                            ;ADD THE COUNT
 1845: 1                                ;
 1846: 1  067F  8B A0           RSUB4:          MOV     P2,R3                           ;SET UP P2
 1847: 1  0681  F3                              MOVX    @R1,A                           ;PLACE THE VALUE IN MEMORY
 1848: 1  0682  09                              INC     R1
 1849: 1  0683  B9 00 01                        CJNE    R1,#00H,RSUB3                   ;SEE IF RAPPED AROUND
 1850: 1  0686  0B                              INC     R3                              ;BUMP HIGH BYTE
 1851: 1                                ;
 1852: 1  0687  22              RSUB3:          RET                                     ;EXIT
 1853: 1                                ;
 1854: 1                                ;***************************************************************
 1855: 1                                ;
 1856: 1  0688                  FPHEXOUT:       ; Output the hex number in R3:R1, supress leading zeros, if set
 1857: 1                                ;
 1858: 1                                ;***************************************************************
 1859: 1                                ;
 1860: 1  0688  B1 E3                           ACALL   SOUT                            ;OUTPUT A SPACE
 1861: 1  068A  A2 36                           MOV     C,ZSURP                         ;GET ZERO SUPPRESSION BIT
 1862: 1  068C  92 33                           MOV     ADD_IN,C
 1863: 1  068E  EB                              MOV     A,R3                            ;GET HIGH NIBBLE AND PRINT IT
 1864: 1  068F  D1 AB                           ACALL   HOUTHI
 1865: 1  0691  EB                              MOV     A,R3
 1866: 1  0692  D1 AC                           ACALL   HOUTLO
 1867: 1                                ;
 1868: 1  0694  C2 33           HEX2X:          CLR     ADD_IN                          ;DON'T SUPPRESS ZEROS
 1869: 1  0696  E9                              MOV     A,R1                            ;GET LOW NIBBLE AND PRINT IT
 1870: 1  0697  D1 AB                           ACALL   HOUTHI
 1871: 1  0699  E9                              MOV     A,R1
 1872: 1  069A  D1 AC                           ACALL   HOUTLO
 1873: 1  069C  7D 48                           MOV     R5,#'H'                         ;OUTPUT H TO INDICATE HEX MODE
 1874: 1                                ;
 1875: 1  069E  A1 E5           SOUT_1:         AJMP    SOUT1
 1876: 1                                ;
 1877: 1  06A0  C2 33           HOUT1:          CLR     ADD_IN                          ;PRINTED SOMETHING, SO CLEAR ADD_IN
 1878: 1  06A2  24 90                           ADD     A,#90H                          ;CONVERT TO ASCII
 1879: 1  06A4  D4                              DA      A
 1880: 1  06A5  34 40                           ADDC    A,#40H
 1881: 1  06A7  D4                              DA      A                               ;GOT IT HERE
 1882: 1  06A8  FD                              MOV     R5,A                            ;OUTPUT THE BYTE
 1883: 1  06A9  80 F3                           SJMP    SOUT_1
 1884: 1                                ;
 1885: 1  06AB  C4              HOUTHI:         SWAP    A                               ;SWAP TO OUTPUT HIGH NIBBLE
 1886: 1                                ;
 1887: 1  06AC  54 0F           HOUTLO:         ANL     A,#0FH                          ;STRIP
 1888: 1  06AE  70 F0                           JNZ     HOUT1                           ;PRINT IF NOT ZERO
 1889: 1  06B0  30 33 ED                        JNB     ADD_IN,HOUT1                    ;OUTPUT A ZERO IF NOT SUPRESSED
 1890: 1  06B3  22                              RET
 1891: 1                                ;
 1892: 1                                ;
 1893: 1  06B4                  GET_DIGIT_CHECK:        ; Get a character, then check for digit
 1894: 1                                ;
 1895: 1  06B4  91 A8                           ACALL   GET_DPTR_CHARACTER
 1896: 1                                ;
 1897: 1  06B6                  DIGIT_CHECK:    ;CHECK FOR A VALID ASCII DIGIT, SET CARRY IF FOUND
 1898: 1                                ;
 1899: 1  06B6  B4 3A 00                        CJNE    A,#'9'+1,$+3                    ;SEE IF ASCII 9 OR LESS
 1900: 1  06B9  40 01                           JC      DC1
 1901: 1  06BB  22                              RET
 1902: 1                                ;
 1903: 1  06BC  B4 30 00        DC1:            CJNE    A,#'0',$+3                      ;SEE IF ASCII 0 OR GREATER
 1904: 1  06BF  B3                              CPL     C
 1905: 1  06C0  22                              RET
 1906: 1                                ;
 1907: 1
 1908: 1  06C1  C0 E0           R5OUT:          PUSH    ACC                             ; ME
 1909: 1  06C3  C0 00                           PUSH    00H
 1910: 1  06C5  A8 50                           MOV     R0,FPCHR_OUT
 1911: 1  06C7  ED                              MOV     A,R5                            ; ME
 1912: 1  06C8  F6                              MOV     @R0,A
 1913: 1  06C9  05 50                           INC     FPCHR_OUT
 1914: 1  06CB  D0 00                           POP     00H
 1915: 1  06CD  D0 E0                           POP     ACC                             ; ME
 1916: 1  06CF  22                              RET                                     ; ME
 1917: 1
 1918: 1  06D0  01 E7           SQ_ERR:         JMP     BADPRM                          ; me
 1919: 1
 1920: 1                                ;***************************************************************
 1921: 1                                ;
 1922: 1  06D2                  IFIX:   ; Convert a floating point number to an integer, put in R3:R1
 1923: 1                                ;
 1924: 1                                ;***************************************************************
 1925: 1                                ;
 1926: 1  06D2  E4                              CLR     A                               ;RESET THE START
 1927: 1  06D3  FB                              MOV     R3,A
 1928: 1  06D4  F9                              MOV     R1,A
 1929: 1  06D5  A8 24                           MOV     R0,ARG_STACK                    ;GET THE ARG STACK
 1930: 1  06D7  75 A0 01                        MOV     P2,#ARG_STACK_PAGE
 1931: 1  06DA  E2                              MOVX    A,@R0                           ;READ EXPONENT
 1932: 1  06DB  C3                              CLR     C
 1933: 1  06DC  94 81                           SUBB    A,#81H                          ;BASE EXPONENT
 1934: 1  06DE  FC                              MOV     R4,A                            ;SAVE IT
 1935: 1  06DF  18                              DEC     R0                              ;POINT AT SIGN
 1936: 1  06E0  E2                              MOVX    A,@R0                           ;GET THE SIGN
 1937: 1  06E1  70 ED                           JNZ     SQ_ERR                          ;ERROR IF NEGATIVE
 1938: 1  06E3  40 17                           JC      INC_ASTKA                       ;EXIT IF EXPONENT IS < 81H
 1939: 1  06E5  0C                              INC     R4                              ;ADJUST LOOP COUNTER
 1940: 1  06E6  E8                              MOV     A,R0                            ;BUMP THE POINTER REGISTER
 1941: 1  06E7  94 05                           SUBB    A,#FP_NUMBER_SIZE-1
 1942: 1  06E9  F8                              MOV     R0,A
 1943: 1                                ;
 1944: 1  06EA  08              I2:             INC     R0                              ;POINT AT DIGIT
 1945: 1  06EB  E2                              MOVX    A,@R0                           ;GET DIGIT
 1946: 1  06EC  C4                              SWAP    A                               ;FLIP
 1947: 1  06ED  11 D4                           CALL    FP_BASE+20                      ;ACCUMULATE
 1948: 1  06EF  40 DF                           JC      SQ_ERR
 1949: 1  06F1  DC 02                           DJNZ    R4,$+4
 1950: 1  06F3  80 07                           SJMP    INC_ASTKA
 1951: 1  06F5  E2                              MOVX    A,@R0                           ;GET DIGIT
 1952: 1  06F6  11 D4                           CALL    FP_BASE+20
 1953: 1  06F8  40 D6                           JC      SQ_ERR
 1954: 1  06FA  DC EE                           DJNZ    R4,I2
 1955: 1                        ;
 1956: 1                        ; Pop the ARG STACK and check for overflow
 1957: 1  06FC                  INC_ASTKA:
 1958: 1  06FC  74 06                           MOV     A,#FP_NUMBER_SIZE               ;number to pop
 1959: 1  06FE  80 18                           SJMP    SETREG+1
 1960: 1                        ;
 1961: 1                        ;Push ARG STACK and check for underflow
 1962: 1  0700                  DEC_ASTKA:
 1963: 1  0700  74 FA                           MOV     A,#-FP_NUMBER_SIZE
 1964: 1  0702  25 24                           ADD     A,ARG_STACK
 1965: 1  0704  B4 00 00                        CJNE    A,#0,$+3
 1966: 1  0707  40 45                           JC      E4YY
 1967: 1  0709  F5 24                           MOV     ARG_STACK,A
 1968: 1  070B  F9                              MOV     R1,A
 1969: 1  070C  7B 01                           MOV     R3,#ARG_STACK_PAGE
 1970: 1  070E  22              SRT:            RET
 1971: 1                        ;
 1972: 1  070F  D1 FC           POPAS:          ACALL   INC_ASTKA
 1973: 1  0711  E1 41                           AJMP    VARCOP                          ;COPY THE VARIABLE
 1974: 1                        ;
 1975: 1  0713  F1 00           PUSHAS:         ACALL   DEC_ASTKA
 1976: 1  0715  E1 41                           AJMP    VARCOP
 1977: 1                        ;
 1978: 1  0717  E4              SETREG:         CLR     A                               ;DON'T POP ANYTHING
 1979: 1  0718  A8 24                           MOV     R0,ARG_STACK
 1980: 1  071A  7A 01                           MOV     R2,#ARG_STACK_PAGE
 1981: 1  071C  8A A0                           MOV     P2,R2
 1982: 1  071E  28                              ADD     A,R0
 1983: 1  071F  40 2D                           JC      E4YY
 1984: 1  0721  F5 24                           MOV     ARG_STACK,A
 1985: 1  0723  E2                              MOVX    A,@R0
 1986: 1  0724  22              A_D:            RET
 1987: 1                                ;
 1988: 1  0725  18              DEC3210:        DEC     R0                              ;BUMP THE POINTER
 1989: 1  0726  B8 FF 01                        CJNE    R0,#0FFH,$+4                    ;SEE IF OVERFLOWED
 1990: 1  0729  1A                              DEC     R2                              ;BUMP THE HIGH BYTE
 1991: 1  072A  19                              DEC     R1                              ;BUMP THE POINTER
 1992: 1  072B  B9 FF 01                        CJNE    R1,#0FFH,DEC_R                  ;SEE IF OVERFLOWED
 1993: 1  072E  1B                              DEC     R3                              ;CHANGE THE HIGH BYTE
 1994: 1  072F  22              DEC_R:          RET                                     ;EXIT
 1995: 1                        ;
 1996: 1
 1997: 1
 1998: 1                        ;Routine to copy bottom arg on stack to address in DPTR.
 1999: 1                        ;Does not work over page boundaries.
 2000: 1                        ;Bugs fixed by JKJ/IRC
 2001: 1  0730  F1 17           MOVAS:          ACALL   SETREG                          ;SET UP R2:R0
 2002: 1  0732  AB 83                           MOV     R3,DPH
 2003: 1  0734  A9 82                           MOV     R1,DPL
 2004: 1  0736  8A A0           M_C:            MOV     P2,R2                           ;SET UP THE PORTS
 2005: 1  0738  E2                              MOVX    A,@R0                           ;READ THE VALUE
 2006: 1  0739  8B A0                           MOV     P2,R3                           ;PORT TIME AGAIN
 2007: 1  073B  F3                              MOVX    @R1,A                           ;SAVE IT
 2008: 1  073C  08                              INC     R0
 2009: 1  073D  09                              INC     R1
 2010: 1  073E  DC F6                           DJNZ    R4,M_C                          ;LOOP
 2011: 1  0740  22                              RET                                     ;EXIT
 2012: 1
 2013: 1
 2014: 1                        ; VARCOP - Copy a variable from R2:R0 to R3:R1
 2015: 1  0741  7C 06           VARCOP:         MOV     R4,#FP_NUMBER_SIZE              ;LOAD THE LOOP COUNTER
 2016: 1  0743  8A A0           V_C:            MOV     P2,R2                           ;SET UP THE PORTS
 2017: 1  0745  E2                              MOVX    A,@R0                           ;READ THE VALUE
 2018: 1  0746  8B A0                           MOV     P2,R3                           ;PORT TIME AGAIN
 2019: 1  0748  F3                              MOVX    @R1,A                           ;SAVE IT
 2020: 1  0749  F1 25                           ACALL   DEC3210
 2021: 1  074B  DC F6                           DJNZ    R4,V_C                          ;LOOP
 2022: 1  074D  22                              RET                                     ;EXIT
 2023: 1                        ;
 2024: 1  074E  90 07 89        E4YY:           MOV     DPTR,#EXA
 2025: 1  0751  01 E6                           JMP     PRTERR                          ; me
 2026: 1
 2027: 1                                ; integer operator - INT
 2028: 1  0753  F1 17           AINT:           ACALL   SETREG                          ;SET UP THE REGISTERS, CLEAR CARRY
 2029: 1  0755  94 81                           SUBB    A,#129                          ;SUBTRACT EXPONENT BIAS
 2030: 1  0757  50 0D                           JNC     AI1                             ;JUMP IF ACC > 81H
 2031: 1                                ;
 2032: 1                                ; Force the number to be a zero
 2033: 1                                ;
 2034: 1  0759  D1 FC                           ACALL   INC_ASTKA                       ;BUMP THE STACK
 2035: 1                                ;
 2036: 1  075B  90 07 60        P_Z:            MOV     DPTR,#ZRO                       ;PUT ZERO ON THE STACK
 2037: 1  075E  E1 7B                           AJMP    PUSHC
 2038: 1  0760  00 00 00 00     ZRO:            DB      0,0,0,0,0,0
       1  0764  00 00
 2039: 1                                ;
 2040: 1  0766  94 07           AI1:            SUBB    A,#7
 2041: 1  0768  50 10                           JNC     AI3
 2042: 1  076A  F4                              CPL     A
 2043: 1  076B  04                              INC     A
 2044: 1  076C  FB                              MOV     R3,A
 2045: 1  076D  18                              DEC     R0                              ;POINT AT SIGN
 2046: 1                                ;
 2047: 1  076E  18              AI2:            DEC     R0                              ;NOW AT LSB'S
 2048: 1  076F  E2                              MOVX    A,@R0                           ;READ BYTE
 2049: 1  0770  54 F0                           ANL     A,#0F0H                         ;STRIP NIBBLE
 2050: 1  0772  F2                              MOVX    @R0,A                           ;WRITE BYTE
 2051: 1  0773  DB 01                           DJNZ    R3,$+3
 2052: 1  0775  22                              RET
 2053: 1  0776  E4                              CLR     A
 2054: 1  0777  F2                              MOVX    @R0,A                           ;CLEAR THE LOCATION
 2055: 1  0778  DB F4                           DJNZ    R3,AI2
 2056: 1  077A  22              AI3:            RET                                     ;EXIT
 2057: 1                                ;
 2058: 1                                ; PUSHC - Push constant pointed by DPTR on to the arg stack
 2059: 1  077B  F1 00           PUSHC:          ACALL   DEC_ASTKA
 2060: 1  077D  8B A0                           MOV     P2,R3
 2061: 1  077F  7B 06                           MOV     R3,#FP_NUMBER_SIZE              ;LOOP COUNTER
 2062: 1  0781  E4              PCL:            CLR     A                               ;SET UP A
 2063: 1  0782  93                              MOVC    A,@A+DPTR                       ;LOAD IT
 2064: 1  0783  F3                              MOVX    @R1,A                           ;SAVE IT
 2065: 1  0784  A3                              INC     DPTR                            ;BUMP POINTERS
 2066: 1  0785  19                              DEC     R1
 2067: 1  0786  DB F9                           DJNZ    R3,PCL                          ;LOOP
 2068: 1  0788  22                              RET                                     ;EXIT
 2069: 1                        ;
 2070: 1  0789  41 2D 53 54     EXA:            DB      'A-STACK',0
       1  078D  41 43 4B 00
 2071: 1
 2072:
 2073:                          ;------------------------------------------------------------------
 2074:
 2075:                          ;Binary to decimal converter
 2076:                          ;Converts R7:R6:R5:R4 to decimal pointed to by R0
 2077:                          ;Returns with number of digits in A
 2078:                          ;------------------------------------------------------------------
 2079:    0791  C0 00           BIN2DEC:        PUSH    00h
 2080:    0793  90 07 E7                        MOV     DPTR,#BINDEC
 2081:    0796  7A 0A                           MOV     R2,#0Ah
 2082:    0798  7B 2F           BIN2DEC1:       MOV     R3,#2Fh
 2083:    079A  0B              BIN2DEC2:       INC     R3
 2084:    079B  F1 BA                           ACALL   SUBIT
 2085:    079D  50 FB                           JNC     BIN2DEC2
 2086:    079F  F1 D3                           ACALL   ADDIT
 2087:    07A1  EB                              MOV     A,R3
 2088:    07A2  F6                              MOV     @R0,A
 2089:    07A3  08                              INC     R0
 2090:    07A4  A3                              INC     DPTR
 2091:    07A5  A3                              INC     DPTR
 2092:    07A6  A3                              INC     DPTR
 2093:    07A7  A3                              INC     DPTR
 2094:    07A8  DA EE                           DJNZ    R2,BIN2DEC1
 2095:    07AA  D0 00                           POP     00h
 2096:                                          ;Remove leading zeroes
 2097:    07AC  7A 09                           MOV     R2,#09h
 2098:    07AE  E6              BIN2DEC3:       MOV     A,@R0
 2099:    07AF  B4 30 05                        CJNE    A,#30h,BIN2DEC4
 2100:    07B2  76 20                           MOV     @R0,#20h
 2101:    07B4  08                              INC     R0
 2102:    07B5  DA F7                           DJNZ    R2,BIN2DEC3
 2103:    07B7  0A              BIN2DEC4:       INC     R2
 2104:    07B8  EA                              MOV     A,R2
 2105:    07B9  22                              RET
 2106:
 2107:    07BA  E4              SUBIT:          CLR     A
 2108:    07BB  93                              MOVC    A,@A+DPTR
 2109:    07BC  CC                              XCH     A,R4
 2110:    07BD  C3                              CLR     C
 2111:    07BE  9C                              SUBB    A,R4
 2112:    07BF  FC                              MOV     R4,A
 2113:    07C0  74 01                           MOV     A,#01h
 2114:    07C2  93                              MOVC    A,@A+DPTR
 2115:    07C3  CD                              XCH     A,R5
 2116:    07C4  9D                              SUBB    A,R5
 2117:    07C5  FD                              MOV     R5,A
 2118:    07C6  74 02                           MOV     A,#02h
 2119:    07C8  93                              MOVC    A,@A+DPTR
 2120:    07C9  CE                              XCH     A,R6
 2121:    07CA  9E                              SUBB    A,R6
 2122:    07CB  FE                              MOV     R6,A
 2123:    07CC  74 03                           MOV     A,#03h
 2124:    07CE  93                              MOVC    A,@A+DPTR
 2125:    07CF  CF                              XCH     A,R7
 2126:    07D0  9F                              SUBB    A,R7
 2127:    07D1  FF                              MOV     R7,A
 2128:    07D2  22                              RET
 2129:
 2130:    07D3  E4              ADDIT:          CLR     A
 2131:    07D4  93                              MOVC    A,@A+DPTR
 2132:    07D5  2C                              ADD     A,R4
 2133:    07D6  FC                              MOV     R4,A
 2134:    07D7  74 01                           MOV     A,#01h
 2135:    07D9  93                              MOVC    A,@A+DPTR
 2136:    07DA  3D                              ADDC    A,R5
 2137:    07DB  FD                              MOV     R5,A
 2138:    07DC  74 02                           MOV     A,#02h
 2139:    07DE  93                              MOVC    A,@A+DPTR
 2140:    07DF  3E                              ADDC    A,R6
 2141:    07E0  FE                              MOV     R6,A
 2142:    07E1  74 03                           MOV     A,#03h
 2143:    07E3  93                              MOVC    A,@A+DPTR
 2144:    07E4  3F                              ADDC    A,R7
 2145:    07E5  FF                              MOV     R7,A
 2146:    07E6  22                              RET
 2147:
 2148:    07E7  00 CA 9A 3B     BINDEC:         DB 000h,0CAh,09Ah,03Bh                  ;1000000000
 2149:    07EB  00 E1 F5 05                     DB 000h,0E1h,0F5h,005h                  ; 100000000
 2150:    07EF  80 96 98 00                     DB 080h,096h,098h,000h                  ;  10000000
 2151:    07F3  40 42 0F 00                     DB 040h,042h,0Fh,0000h                  ;   1000000
 2152:    07F7  A0 86 01 00                     DB 0A0h,086h,001h,000h                  ;    100000
 2153:    07FB  10 27 00 00                     DB 010h,027h,000h,000h                  ;     10000
 2154:    07FF  E8 03 00 00                     DB 0E8h,003h,000h,000h                  ;      1000
 2155:    0803  64 00 00 00                     DB 064h,000h,000h,000h                  ;       100
 2156:    0807  0A 00 00 00                     DB 00Ah,000h,000h,000h                  ;        10
 2157:    080B  01 00 00 00                     DB 001h,000h,000h,000h                  ;         1
 2158:
 2159:                          ;------------------------------------------------------------------
 2160:
 2161:                          ;Get LC meter frquency
 2162:                          ;IN:    A Port #8000h value, R3:R1 points to FP buffer
 2163:                          ;OUT:   Nothing
 2164:    080F  C0 03           LCMETERGETFRQ:  PUSH    03h                             ;Save R3
 2165:    0811  C0 01                           PUSH    01h                             ;Save R1
 2166:    0813  90 80 00                        MOV     DPTR,#8000h
 2167:    0816  F0                              MOVX    @DPTR,A                         ;D7, D6
 2168:    0817  74 FA                           MOV     A,#250
 2169:    0819  12 1C 2A                        LCALL   WAIT                            ;Wait 25ms for relay to kick in / out
 2170:    081C  74 FA                           MOV     A,#250
 2171:    081E  12 1C 2A                        LCALL   WAIT                            ;Wait 25ms for relay to kick in / out
 2172:    0821  74 02                           MOV     A,#02h                          ;CH2, LC Meter
 2173:    0823  12 0A 2B                        LCALL   FRQCOUNT
 2174:    0826  78 40                           MOV     R0,#LCDLINE
 2175:    0828  12 07 91                        LCALL   BIN2DEC
 2176:    082B  78 40                           MOV     R0,#LCDLINE
 2177:    082D  90 00 48                        MOV     DPTR,#CONVT
 2178:    0830  7F 0A                           MOV     R7,#0Ah
 2179:    0832  E6              LCMETERGETFRQ1: MOV     A,@R0
 2180:    0833  F0                              MOVX    @DPTR,A
 2181:    0834  08                              INC     R0
 2182:    0835  A3                              INC     DPTR
 2183:    0836  DF FA                           DJNZ    R7,LCMETERGETFRQ1
 2184:    0838  74 0D                           MOV     A,#0Dh
 2185:    083A  F0                              MOVX    @DPTR,A
 2186:    083B  90 00 48                        MOV     DPTR,#CONVT
 2187:    083E  12 04 0B                        LCALL   FLOATING_POINT_INPUT
 2188:    0841  D0 01                           POP     01h                             ;Restore R1
 2189:    0843  D0 03                           POP     03H                             ;Restore R3
 2190:    0845  12 07 0F                        LCALL   POPAS                           ;POP ARGUMENT TO R3:R1
 2191:    0848  22                              RET
 2192:
 2193:                          ;Calculate X=((Fa/Fb)^2)-1
 2194:                          ;IN:    Fa=R2:R0, Fb=R3:R1
 2195:                          ;OUT:   Nothing
 2196:    0849  C0 01           LCCALC:         PUSH    01h
 2197:    084B  C0 03                           PUSH    03h
 2198:    084D  12 07 13                        LCALL   PUSHAS                          ; PUSH R2:R0 TO ARGUMENT
 2199:    0850  D0 02                           POP     02h
 2200:    0852  D0 00                           POP     00h
 2201:    0854  12 07 13                        LCALL   PUSHAS                          ; PUSH R2:R0 TO ARGUMENT
 2202:    0857  12 02 0B                        LCALL   FLOATING_DIV
 2203:    085A  A8 24                           MOV     R0,ARG_STACK
 2204:    085C  7A 01                           MOV     R2,#ARG_STACK_PAGE
 2205:    085E  12 07 13                        LCALL   PUSHAS                          ; PUSH R2:R0 TO ARGUMENT
 2206:    0861  12 01 D6                        LCALL   FLOATING_MUL
 2207:    0864  90 0C E3                        MOV     DPTR,#FPONE
 2208:    0867  12 07 7B                        LCALL   PUSHC                           ; PUSH ARG IN DPTR TO STACK
 2209:    086A  12 00 E8                        LCALL   FLOATING_SUB
 2210:    086D  22                              RET
 2211:
 2212:                          ;Get LC meter frquency F1 and F2. Calculatr LCCA=((F1/F2)^2)-1 and LCCB=LCCA*((1/(2*Pi*F1))^2)*(1/Ccal)
 2213:                          ;IN:    Nothing
 2214:                          ;OUT:   Nothing
 2215:    086E  74 00           LCMETERINIT:    MOV     A,#00h                          ;D6 LC Meter    0=C, 1=L
 2216:                                                                                  ;D7 LC Meter    0=F1, 1=F2 (Adding C Cal)
 2217:    0870  90 80 00                        MOV     DPTR,#8000h
 2218:    0873  F0                              MOVX    @DPTR,A                         ;D7, D6
 2219:    0874  12 1D 38                        LCALL   LCDCLEAR
 2220:    0877  12 11 18                        LCALL   PRNTCSTRLCD
 2221:    087A  43 61 6C 69                     DB      'Calibrating',0
          087E  62 72 61 74
          0882  69 6E 67 00
 2222:    0886  7F 05                           MOV     R7,#05h
 2223:    0888  C0 07           LCMETERINIT1:   PUSH    07h
 2224:    088A  12 0A 1E                        LCALL   WAITASEC
 2225:    088D  74 2E                           MOV     A,#'.'
 2226:    088F  12 1D 47                        LCALL   LCDCHROUT
 2227:    0892  D0 07                           POP     07h
 2228:    0894  DF F2                           DJNZ    R7,LCMETERINIT1
 2229:    0896  74 00                           MOV     A,#00h                          ;D6 LC Meter    0=C, 1=L
 2230:                                                                                  ;D7 LC Meter    0=F1, 1=F2 (Adding C Cal)
 2231:    0898  79 60                           MOV     R1,#LOW LCF1
 2232:    089A  7B 00                           MOV     R3,#HIGH LCF1
 2233:    089C  12 08 0F                        LCALL   LCMETERGETFRQ                   ;Get F1
 2234:    089F  74 80                           MOV     A,#80h                          ;D6 LC Meter    0=C, 1=L
 2235:                                                                                  ;D7 LC Meter    0=F1, 1=F2 (Adding C Cal)
 2236:    08A1  79 68                           MOV     R1,#LOW LCF2
 2237:    08A3  7B 00                           MOV     R3,#HIGH LCF2
 2238:    08A5  12 08 0F                        LCALL   LCMETERGETFRQ                   ;Get F2
 2239:                                          ;Calculate LCCA=((F1/F2)^2)-1
 2240:    08A8  78 60                           MOV     R0,#LOW LCF1
 2241:    08AA  7A 00                           MOV     R2,#HIGH LCF1
 2242:    08AC  79 68                           MOV     R1,#LOW LCF2
 2243:    08AE  7B 00                           MOV     R3,#HIGH LCF2
 2244:    08B0  12 08 49                        LCALL   LCCALC
 2245:                                          ;Save result to LCCA
 2246:    08B3  79 78                           MOV     R1,#LOW LCCA
 2247:    08B5  7B 00                           MOV     R3,#HIGH LCCA
 2248:    08B7  12 07 0F                        LCALL   POPAS                           ;POP ARGUMENT TO R3:R1
 2249:                                          ;Calculate A=(1/(2*Pi*F1))^2
 2250:    08BA  90 0C E9                        MOV     DPTR,#FPTWO
 2251:    08BD  12 07 7B                        LCALL   PUSHC                           ;PUSH ARG IN DPTR TO STACK
 2252:    08C0  90 0C EF                        MOV     DPTR,#FPPI
 2253:    08C3  12 07 7B                        LCALL   PUSHC                           ;PUSH ARG IN DPTR TO STACK
 2254:    08C6  12 01 D6                        LCALL   FLOATING_MUL
 2255:    08C9  78 60                           MOV     R0,#LOW LCF1
 2256:    08CB  7A 00                           MOV     R2,#HIGH LCF1
 2257:    08CD  12 07 13                        LCALL   PUSHAS                          ;PUSH R2:R0 TO ARGUMENT
 2258:    08D0  12 01 D6                        LCALL   FLOATING_MUL
 2259:    08D3  79 88                           MOV     R1,#LOW LCCT
 2260:    08D5  7B 00                           MOV     R3,#HIGH LCCT
 2261:    08D7  12 07 0F                        LCALL   POPAS                           ;POP ARGUMENT TO R3:R1
 2262:    08DA  90 0C E3                        MOV     DPTR,#FPONE
 2263:    08DD  12 07 7B                        LCALL   PUSHC                           ;PUSH ARG IN DPTR TO STACK
 2264:    08E0  78 88                           MOV     R0,#LOW LCCT
 2265:    08E2  7A 00                           MOV     R2,#HIGH LCCT
 2266:    08E4  12 07 13                        LCALL   PUSHAS                          ;PUSH R2:R0 TO ARGUMENT
 2267:    08E7  12 02 0B                        LCALL   FLOATING_DIV
 2268:    08EA  A8 24                           MOV     R0,ARG_STACK
 2269:    08EC  7A 01                           MOV     R2,#ARG_STACK_PAGE
 2270:    08EE  12 07 13                        LCALL   PUSHAS                          ;PUSH R2:R0 TO ARGUMENT
 2271:    08F1  12 01 D6                        LCALL   FLOATING_MUL
 2272:                                          ;Calculate LCCB=A*LCCA*(1/Ccal)
 2273:    08F4  78 78                           MOV     R0,#LOW LCCA
 2274:    08F6  7A 00                           MOV     R2,#HIGH LCCA
 2275:    08F8  12 07 13                        LCALL   PUSHAS                          ;PUSH R2:R0 TO ARGUMENT
 2276:    08FB  12 01 D6                        LCALL   FLOATING_MUL
 2277:    08FE  90 0C F5                        MOV     DPTR,#FPCCAL
 2278:    0901  12 07 7B                        LCALL   PUSHC                           ;PUSH ARG IN DPTR TO STACK
 2279:    0904  12 02 0B                        LCALL   FLOATING_DIV
 2280:                                          ;Save result to LCCB
 2281:    0907  79 80                           MOV     R1,#LOW LCCB
 2282:    0909  7B 00                           MOV     R3,#HIGH LCCB
 2283:    090B  12 07 0F                        LCALL   POPAS                           ;POP ARGUMENT TO R3:R1
 2284:    090E  E4                              CLR     A
 2285:    090F  90 80 00                        MOV     DPTR,#8000h
 2286:    0912  F0                              MOVX    @DPTR,A                         ;D7, D6
 2287:    0913  12 1D 38                        LCALL   LCDCLEAR
 2288:    0916  22                              RET
 2289:
 2290:                          ;Inductance meter Lx=((F1/F3)^2)-1)*((F1/F2)^2)-1)*((1/(2*Pi*F1))^2)*(1/Ccal)
 2291:                          ;IN:    Nothing
 2292:                          ;OUT:   Nothing
 2293:    0917  74 40           LMETER:         MOV     A,#40h                          ;D6 LC Meter    0=C, 1=L
 2294:    0919  F5 21                           MOV     OUTD7D6,A
 2295:                                                                                  ;D7 LC Meter    0=F1, 1=F2 (Adding C Cal)
 2296:    091B  79 70                           MOV     R1,#LOW LCF3
 2297:    091D  7B 00                           MOV     R3,#HIGH LCF3
 2298:    091F  12 08 0F                        LCALL   LCMETERGETFRQ                   ;Get F3
 2299:                                          ;Calculate A=((F1/F3)^2)-1
 2300:    0922  78 60                           MOV     R0,#LOW LCF1
 2301:    0924  7A 00                           MOV     R2,#HIGH LCF1
 2302:    0926  79 70                           MOV     R1,#LOW LCF3
 2303:    0928  7B 00                           MOV     R3,#HIGH LCF3
 2304:    092A  12 08 49                        LCALL   LCCALC
 2305:                                          ;Calculate B=A*LCCB
 2306:    092D  78 80                           MOV     R0,#LOW LCCB
 2307:    092F  7A 00                           MOV     R2,#HIGH LCCB
 2308:    0931  12 07 13                        LCALL   PUSHAS                          ;PUSH R2:R0 TO ARGUMENT
 2309:    0934  12 01 D6                        LCALL   FLOATING_MUL
 2310:    0937  85 24 82                        MOV     DPL,ARG_STACK
 2311:    093A  75 83 01                        MOV     DPH,#ARG_STACK_PAGE
 2312:    093D  15 82                           DEC     DPL
 2313:    093F  E0                              MOVX    A,@DPTR
 2314:    0940  05 82                           INC     DPL
 2315:    0942  60 02                           JZ      LMETER1
 2316:    0944  E4                              CLR     A
 2317:    0945  F0                              MOVX    @DPTR,A
 2318:    0946  E0              LMETER1:        MOVX    A,@DPTR
 2319:    0947  B4 80 00                        CJNE    A,#80h,$+3
 2320:    094A  40 02                           JC      LMETER2
 2321:    094C  E4                              CLR     A
 2322:    094D  F0                              MOVX    @DPTR,A
 2323:    094E  75 4E 6E        LMETER2:        MOV     LCDLINE+14,#'n'
 2324:    0951  90 0D 01                        MOV     DPTR,#FPN
 2325:    0954  60 16                           JZ      LMETER3
 2326:    0956  B4 7B 00                        CJNE    A,#7Bh,$+3
 2327:    0959  40 11                           JC      LMETER3
 2328:    095B  75 4E 75                        MOV     LCDLINE+14,#'u'
 2329:    095E  90 0D 07                        MOV     DPTR,#FPU
 2330:    0961  B4 7E 00                        CJNE    A,#7Eh,$+3
 2331:    0964  40 06                           JC      LMETER3
 2332:    0966  75 4E 6D                        MOV     LCDLINE+14,#'m'
 2333:    0969  90 0D 0D                        MOV     DPTR,#FPM
 2334:    096C  12 07 7B        LMETER3:        LCALL   PUSHC                           ;PUSH ARG IN DPTR TO STACK
 2335:    096F  12 01 D6                        LCALL   FLOATING_MUL
 2336:    0972  75 40 4C                        MOV     LCDLINE,#'L'
 2337:    0975  75 41 20                        MOV     LCDLINE+1,#' '
 2338:    0978  75 42 3D                        MOV     LCDLINE+2,#'='
 2339:    097B  75 43 20                        MOV     LCDLINE+3,#' '
 2340:    097E  75 4F 48                        MOV     LCDLINE+15,#'H'
 2341:    0981  75 50 44                        MOV     FPCHR_OUT,#LCDLINE+4
 2342:    0984  75 25 53                        MOV     FORMAT,#53h
 2343:    0987  E5 24                           MOV     A,ARG_STACK
 2344:    0989  C3                              CLR     C
 2345:    098A  94 05                           SUBB    A,#05h
 2346:    098C  F8                              MOV     R0,A
 2347:    098D  12 04 C3                        LCALL   FLOATING_POINT_OUTPUT
 2348:    0990  74 00                           MOV     A,#00h
 2349:    0992  12 1D 42                        LCALL   LCDSETADR
 2350:    0995  78 40                           MOV     R0,#LCDLINE
 2351:    0997  7F 10                           MOV     R7,#10h
 2352:    0999  12 11 42                        LCALL   PRINTSTR
 2353:    099C  02 10 38                        LJMP    START
 2354:
 2355:                          ;Capacitance meter: Cx=((F1/F3)^2)-1)/((F1/F2)^2)-1)*Ccal
 2356:                          ;IN:    Nothing
 2357:                          ;OUT:   Nothing
 2358:    099F  74 00           CMETER:         MOV     A,#00h                          ;D6 LC Meter    0=C, 1=L
 2359:                                                                                  ;D7 LC Meter    0=F1, 1=F2 (Adding C Cal)
 2360:    09A1  F5 21                           MOV     OUTD7D6,A
 2361:    09A3  79 70                           MOV     R1,#LOW LCF3
 2362:    09A5  7B 00                           MOV     R3,#HIGH LCF3
 2363:    09A7  12 08 0F                        LCALL   LCMETERGETFRQ                   ;Get F3
 2364:                                          ;Calculate A=((F1/F3)^2)-1
 2365:    09AA  78 60                           MOV     R0,#LOW LCF1
 2366:    09AC  7A 00                           MOV     R2,#HIGH LCF1
 2367:    09AE  79 70                           MOV     R1,#LOW LCF3
 2368:    09B0  7B 00                           MOV     R3,#HIGH LCF3
 2369:    09B2  12 08 49                        LCALL   LCCALC
 2370:                                          ;Calculate B=A/LCCA
 2371:    09B5  78 78                           MOV     R0,#LOW LCCA
 2372:    09B7  7A 00                           MOV     R2,#HIGH LCCA
 2373:    09B9  12 07 13                        LCALL   PUSHAS                          ;PUSH R2:R0 TO ARGUMENT
 2374:    09BC  12 02 0B                        LCALL   FLOATING_DIV
 2375:                                          ;Calculate Cx=A/B*Ccal
 2376:    09BF  90 0C F5                        MOV     DPTR,#FPCCAL
 2377:    09C2  12 07 7B                        LCALL   PUSHC                           ;PUSH ARG IN DPTR TO STACK
 2378:    09C5  12 01 D6                        LCALL   FLOATING_MUL
 2379:    09C8  85 24 82                        MOV     DPL,ARG_STACK
 2380:    09CB  75 83 01                        MOV     DPH,#ARG_STACK_PAGE
 2381:    09CE  15 82                           DEC     DPL
 2382:    09D0  E0                              MOVX    A,@DPTR
 2383:    09D1  05 82                           INC     DPL
 2384:    09D3  60 02                           JZ      CMETER1
 2385:    09D5  E4                              CLR     A
 2386:    09D6  F0                              MOVX    @DPTR,A
 2387:    09D7  E0              CMETER1:        MOVX    A,@DPTR
 2388:    09D8  75 4E 70                        MOV     LCDLINE+14,#'p'
 2389:    09DB  90 0C FB                        MOV     DPTR,#FPP
 2390:    09DE  60 0B                           JZ      CMETER2
 2391:    09E0  B4 78 00                        CJNE    A,#78h,$+3
 2392:    09E3  40 06                           JC      CMETER2
 2393:    09E5  75 4E 6E                        MOV     LCDLINE+14,#'n'
 2394:    09E8  90 0D 01                        MOV     DPTR,#FPN
 2395:    09EB  12 07 7B        CMETER2:        LCALL   PUSHC                           ;PUSH ARG IN DPTR TO STACK
 2396:    09EE  12 01 D6                        LCALL   FLOATING_MUL
 2397:    09F1  75 40 43                        MOV     LCDLINE,#'C'
 2398:    09F4  75 41 20                        MOV     LCDLINE+1,#' '
 2399:    09F7  75 42 3D                        MOV     LCDLINE+2,#'='
 2400:    09FA  75 43 20                        MOV     LCDLINE+3,#' '
 2401:    09FD  75 4F 46                        MOV     LCDLINE+15,#'F'
 2402:    0A00  75 50 44                        MOV     FPCHR_OUT,#LCDLINE+4
 2403:    0A03  75 25 53                        MOV     FORMAT,#53h
 2404:    0A06  E5 24                           MOV     A,ARG_STACK
 2405:    0A08  C3                              CLR     C
 2406:    0A09  94 05                           SUBB    A,#05h
 2407:    0A0B  F8                              MOV     R0,A
 2408:    0A0C  12 04 C3                        LCALL   FLOATING_POINT_OUTPUT
 2409:    0A0F  74 00                           MOV     A,#00h
 2410:    0A11  12 1D 42                        LCALL   LCDSETADR
 2411:    0A14  78 40                           MOV     R0,#LCDLINE
 2412:    0A16  7F 10                           MOV     R7,#10h
 2413:    0A18  12 11 42                        LCALL   PRINTSTR
 2414:    0A1B  02 10 38                        LJMP    START
 2415:
 2416:                          ;------------------------------------------------------------------
 2417:
 2418:                          ;Wait loop. Waits 1 second
 2419:                          ;-----------------------------------------------------
 2420:    0A1E  7F F8           WAITASEC:       MOV     R7,#0F8h
 2421:    0A20  7E 33                           MOV     R6,#51
 2422:    0A22  7D 10                           MOV     R5,#16
 2423:    0A24  DF FE           WAITASEC1:      DJNZ    R7,WAITASEC1
 2424:    0A26  DE FC                           DJNZ    R6,WAITASEC1
 2425:    0A28  DD FA                           DJNZ    R5,WAITASEC1
 2426:    0A2A  22                              RET
 2427:
 2428:                          ;Frequency counter. LSB from 74LS393 read at 8001h, TL0, TH0, TF0 bit. 25 bits, max 33554431 Hz
 2429:                          ;IN;    A holds channel (0 to 3). ACC.7 FRQ TTL Active high
 2430:                          ;OUT:   32 Bit result in R7:R6:R5:R4
 2431:                          ;------------------------------------------------------------------
 2432:    0A2B  44 7C           FRQCOUNT:       ORL     A,#7Ch                          ;D0,D1  CHANNEL (0-3)
 2433:                                                                                  ;D2     FRQ     Gate active low
 2434:                                                                                  ;D3     FRQ     Reset active high
 2435:                                                                                  ;D4     ADC     CS Active low
 2436:                                                                                  ;D5     ADC     CLK High to Low transition
 2437:                                                                                  ;D6     ADC     DIN
 2438:                                                                                  ;D7     FRQ TTL  Active high
 2439:    0A2D  90 80 01                        MOV     DPTR,#8001h
 2440:    0A30  F0                              MOVX    @DPTR,A                         ;Reset and gate off
 2441:    0A31  C0 E0                           PUSH    ACC
 2442:    0A33  75 8A 00                        MOV     TL0,#00h
 2443:    0A36  75 8C 00                        MOV     TH0,#00h
 2444:    0A39  E5 89                           MOV     A,TMOD
 2445:    0A3B  D2 E0                           SETB    ACC.0                           ;M00
 2446:    0A3D  C2 E1                           CLR     ACC.1                           ;M01
 2447:    0A3F  D2 E2                           SETB    ACC.2                           ;C/T0#
 2448:    0A41  C2 E3                           CLR     ACC.3                           ;GATE0
 2449:    0A43  F5 89                           MOV     TMOD,A
 2450:    0A45  E5 88                           MOV     A,TCON
 2451:    0A47  D2 E4                           SETB    ACC.4                           ;TR0
 2452:    0A49  C2 E5                           CLR     ACC.5                           ;TF0
 2453:    0A4B  F5 88                           MOV     TCON,A
 2454:    0A4D  D0 E0                           POP     ACC
 2455:    0A4F  54 F3                           ANL     A,#0F3h                         ;D2     FRQ Gate active low
 2456:                                                                                  ;D3     FRQ Reset active high
 2457:    0A51  F0                              MOVX    @DPTR,A                         ;Gate on(low),Reset inactive (low)
 2458:    0A52  51 1E                           ACALL   WAITASEC
 2459:    0A54  D2 E2                           SETB    ACC.2                           ;D2     FRQ Gate active low
 2460:    0A56  F0                              MOVX    @DPTR,A                         ;Stop counting
 2461:    0A57  E0                              MOVX    A,@DPTR
 2462:    0A58  FC                              MOV     R4,A
 2463:    0A59  E5 8A                           MOV     A,TL0
 2464:    0A5B  FD                              MOV     R5,A
 2465:    0A5C  E5 8C                           MOV     A,TH0
 2466:    0A5E  FE                              MOV     R6,A
 2467:    0A5F  E4                              CLR     A                               ;TF0 Is the 25th bit
 2468:    0A60  A2 8D                           MOV     C,TF0
 2469:    0A62  33                              RLC     A
 2470:    0A63  FF                              MOV     R7,A
 2471:    0A64  22                              RET
 2472:
 2473:                          ;Format frequency conter text line
 2474:                          ;IN:    A holds channel (0 to 3)
 2475:                          ;       LCDLINE+4 Decimal result
 2476:                          ;       R7 Number of digits
 2477:                          ;OUT:   Formatted LCDLINE
 2478:    0A65  75 40 43        FRQFORMAT:      MOV     LCDLINE,#'C'
 2479:    0A68  75 41 48                        MOV     LCDLINE+1,#'H'
 2480:    0A6B  44 30                           ORL     A,#30h
 2481:    0A6D  F5 42                           MOV     LCDLINE+2,A
 2482:    0A6F  75 43 20                        MOV     LCDLINE+3,#' '
 2483:    0A72  78 44                           MOV     R0,#LCDLINE+4
 2484:    0A74  79 46                           MOV     R1,#LCDLINE+6
 2485:    0A76  BF 07 00                        CJNE    R7,#07h,$+3
 2486:    0A79  40 19                           JC      FRQFORMATKHZ
 2487:                                          ;MHz
 2488:    0A7B  7F 08                           MOV     R7,#08h
 2489:    0A7D  E7              FRQFORMATMHZ1:  MOV     A,@R1
 2490:    0A7E  BF 06 03                        CJNE    R7,#06h,FRQFORMATMHZ2
 2491:    0A81  76 2E                           MOV     @R0,#'.'
 2492:    0A83  08                              INC     R0
 2493:    0A84  F6              FRQFORMATMHZ2:  MOV     @R0,A
 2494:    0A85  08                              INC     R0
 2495:    0A86  09                              INC     R1
 2496:    0A87  DF F4                           DJNZ    R7,FRQFORMATMHZ1
 2497:    0A89  75 4D 4D                        MOV     LCDLINE+13,#'M'
 2498:    0A8C  75 4E 48                        MOV     LCDLINE+14,#'H'
 2499:    0A8F  75 4F 7A                        MOV     LCDLINE+15,#'z'
 2500:    0A92  80 33                           SJMP    FRQFORMATDONE
 2501:    0A94  BF 04 00        FRQFORMATKHZ:   CJNE    R7,#04h,$+3
 2502:    0A97  40 19                           JC      FRQFORMATHZ
 2503:                                          ;KHz
 2504:    0A99  7F 08                           MOV     R7,#08h
 2505:    0A9B  E7              FRQFORMATKHZ1:  MOV     A,@R1
 2506:    0A9C  BF 03 03                        CJNE    R7,#03h,FRQFORMATKHZ2
 2507:    0A9F  76 2E                           MOV     @R0,#'.'
 2508:    0AA1  08                              INC     R0
 2509:    0AA2  F6              FRQFORMATKHZ2:  MOV     @R0,A
 2510:    0AA3  08                              INC     R0
 2511:    0AA4  09                              INC     R1
 2512:    0AA5  DF F4                           DJNZ    R7,FRQFORMATKHZ1
 2513:    0AA7  75 4D 4B                        MOV     LCDLINE+13,#'K'
 2514:    0AAA  75 4E 48                        MOV     LCDLINE+14,#'H'
 2515:    0AAD  75 4F 7A                        MOV     LCDLINE+15,#'z'
 2516:    0AB0  80 15                           SJMP    FRQFORMATDONE
 2517:    0AB2                  FRQFORMATHZ:    ;Hz
 2518:    0AB2  75 44 20                        MOV     LCDLINE+4,#' '
 2519:    0AB5  08                              INC     R0
 2520:    0AB6  7F 08                           MOV     R7,#08h
 2521:    0AB8  E7              FRQFORMATHZ1:   MOV     A,@R1
 2522:    0AB9  F6                              MOV     @R0,A
 2523:    0ABA  08                              INC     R0
 2524:    0ABB  09                              INC     R1
 2525:    0ABC  DF FA                           DJNZ    R7,FRQFORMATHZ1
 2526:    0ABE  75 4D 48                        MOV     LCDLINE+13,#'H'
 2527:    0AC1  75 4E 7A                        MOV     LCDLINE+14,#'z'
 2528:    0AC4  75 4F 20                        MOV     LCDLINE+15,#' '
 2529:    0AC7  22              FRQFORMATDONE:  RET
 2530:
 2531:                          ;Frequency conter and AD Converter channel 0 and 5
 2532:                          ;IN:    Frequency cont channel (0-3)
 2533:                          ;OUT:   Nothing
 2534:    0AC8  C0 E0           FREQENCYCOUNT:  PUSH    ACC
 2535:    0ACA  12 0A 2B                        LCALL   FRQCOUNT
 2536:    0ACD  78 44                           MOV     R0,#LCDLINE+4                   ;Decimal buffer
 2537:    0ACF  12 07 91                        LCALL   BIN2DEC
 2538:    0AD2  FF                              MOV     R7,A                            ;Number of digits
 2539:    0AD3  D0 E0                           POP     ACC
 2540:    0AD5  54 03                           ANL     A,#03h
 2541:    0AD7  12 0A 65                        LCALL   FRQFORMAT
 2542:    0ADA  74 00                           MOV     A,#00h
 2543:    0ADC  12 1D 42                        LCALL   LCDSETADR
 2544:    0ADF  78 40                           MOV     R0,#LCDLINE                     ;Output result
 2545:    0AE1  7F 10                           MOV     R7,#10h
 2546:    0AE3  12 11 42                        LCALL   PRINTSTR
 2547:    0AE6  74 00                           MOV     A,#00h                          ;ADC Channel 0
 2548:    0AE8  12 0B 2C                        LCALL   ADCONVERT
 2549:    0AEB  74 00                           MOV     A,#00h
 2550:    0AED  79 44                           MOV     R1,#LCDLINE+4
 2551:    0AEF  75 25 22                        MOV     FORMAT,#22h
 2552:    0AF2  12 0B 81                        LCALL   ADOUTPUT
 2553:    0AF5  74 05                           MOV     A,#05h                          ;ADC Channel 5
 2554:    0AF7  12 0B 2C                        LCALL   ADCONVERT
 2555:    0AFA  E8                              MOV     A,R0
 2556:    0AFB  C3                              CLR     C
 2557:    0AFC  94 73                           SUBB    A,#73h
 2558:    0AFE  F8                              MOV     R0,A
 2559:    0AFF  EA                              MOV     A,R2
 2560:    0B00  94 00                           SUBB    A,#00h
 2561:    0B02  50 02                           JNC     FREQENCYCOUNT1
 2562:    0B04  E4                              CLR     A
 2563:    0B05  F8                              MOV     R0,A
 2564:    0B06  FA              FREQENCYCOUNT1: MOV     R2,A
 2565:    0B07  74 05                           MOV     A,#05h
 2566:    0B09  79 4A                           MOV     R1,#LCDLINE+10
 2567:    0B0B  75 25 13                        MOV     FORMAT,#13h
 2568:    0B0E  12 0B 81                        LCALL   ADOUTPUT
 2569:    0B11  75 40 56                        MOV     LCDLINE,#'V'                    ;Output result
 2570:    0B14  75 41 41                        MOV     LCDLINE+1,#'A'
 2571:    0B17  75 42 52                        MOV     LCDLINE+2,#'R'
 2572:    0B1A  75 43 20                        MOV     LCDLINE+3,#' '
 2573:    0B1D  74 40                           MOV     A,#40h
 2574:    0B1F  12 1D 42                        LCALL   LCDSETADR
 2575:    0B22  78 40                           MOV     R0,#LCDLINE
 2576:    0B24  7F 10                           MOV     R7,#10h
 2577:    0B26  12 11 42                        LCALL   PRINTSTR
 2578:    0B29  02 10 38                        LJMP    START
 2579:
 2580:                          ;------------------------------------------------------------------
 2581:
 2582:                          ;AD Converter.
 2583:                          ;IN:    A holds channel (0 to 7).
 2584:                          ;OUT:   R2:R0 Holds 16 Bit result
 2585:                          ;-----------------------------------------------------
 2586:    0B2C  44 18           ADCONVERT:      ORL     A,#18h                          ;START, SINGLE ENDED
 2587:    0B2E  23                              RL      A
 2588:    0B2F  23                              RL      A
 2589:    0B30  23                              RL      A
 2590:    0B31  FA                              MOV     R2,A
 2591:    0B32  74 7C                           MOV     A,#7Ch                          ;D0,D1 FRQ SEL
 2592:                                                                                  ;D2 FRQ GATE    ACTIVE LOW
 2593:                                                                                  ;D3 FRQ RESET   ACTIVE HIGH
 2594:                                                                                  ;D4 ADC CS      ACTIVE LOW
 2595:                                                                                  ;D5 ADC CLK     HIGH TO LOW TRANSITION
 2596:                                                                                  ;D6 ADC DIN     START,S/D,D2,D1,D0
 2597:                                                                                  ;D7 FRQ TTL     ACTIVE HIGH
 2598:    0B34  90 80 01                        MOV     DPTR,#8001h
 2599:    0B37  F0                              MOVX    @DPTR,A
 2600:                                          ;CS low
 2601:    0B38  C2 E4                           CLR     ACC.4                           ;D4 ADC CS      ACTIVE LOW
 2602:    0B3A  F0                              MOVX    @DPTR,A
 2603:                                          ;Clock in channel select and Single/Diff+2 clocks for sample
 2604:    0B3B  7F 07                           MOV     R7,#07h
 2605:    0B3D  CA              ADCONVERT1:     XCH     A,R2
 2606:    0B3E  33                              RLC     A
 2607:    0B3F  CA                              XCH     A,R2
 2608:    0B40  92 E6                           MOV     ACC.6,C ;ADC DIN
 2609:    0B42  C2 E5                           CLR     ACC.5
 2610:    0B44  F0                              MOVX    @DPTR,A
 2611:    0B45  D2 E5                           SETB    ACC.5
 2612:    0B47  F0                              MOVX    @DPTR,A
 2613:    0B48  DF F3                           DJNZ    R7,ADCONVERT1
 2614:    0B4A  7A 00                           MOV     R2,#00h
 2615:                                          ;Clock in 5 bits, including null bit
 2616:    0B4C  7F 05                           MOV     R7,#05h
 2617:    0B4E  C0 E0           ADCONVERT2:     PUSH    ACC
 2618:    0B50  90 80 00                        MOV     DPTR,#8000h
 2619:    0B53  E0                              MOVX    A,@DPTR
 2620:    0B54  13                              RRC     A
 2621:    0B55  CA                              XCH     A,R2
 2622:    0B56  33                              RLC     A
 2623:    0B57  CA                              XCH     A,R2
 2624:    0B58  90 80 01                        MOV     DPTR,#8001h
 2625:    0B5B  D0 E0                           POP     ACC
 2626:    0B5D  C2 E5                           CLR     ACC.5
 2627:    0B5F  F0                              MOVX    @DPTR,A
 2628:    0B60  D2 E5                           SETB    ACC.5
 2629:    0B62  F0                              MOVX    @DPTR,A
 2630:    0B63  DF E9                           DJNZ    R7,ADCONVERT2
 2631:    0B65  78 00                           MOV     R0,#00h
 2632:                                          ;Clock in 8 bits
 2633:    0B67  7F 08                           MOV     R7,#08h
 2634:    0B69  C0 E0           ADCONVERT3:     PUSH    ACC
 2635:    0B6B  90 80 00                        MOV     DPTR,#8000h
 2636:    0B6E  E0                              MOVX    A,@DPTR
 2637:    0B6F  13                              RRC     A
 2638:    0B70  C8                              XCH     A,R0
 2639:    0B71  33                              RLC     A
 2640:    0B72  C8                              XCH     A,R0
 2641:    0B73  90 80 01                        MOV     DPTR,#8001h
 2642:    0B76  D0 E0                           POP     ACC
 2643:    0B78  C2 E5                           CLR     ACC.5
 2644:    0B7A  F0                              MOVX    @DPTR,A
 2645:    0B7B  D2 E5                           SETB    ACC.5
 2646:    0B7D  F0                              MOVX    @DPTR,A
 2647:    0B7E  DF E9                           DJNZ    R7,ADCONVERT3
 2648:    0B80  22                              RET
 2649:
 2650:                          ;AD Converter output
 2651:                          ;IN:    A holds channel (0 to 7).
 2652:                          ;       R2:R0 adc result
 2653:                          ;       R1 pointer to buffer
 2654:                          ;OUT:   6 Characters
 2655:                          ;-----------------------------------------------------
 2656:    0B81  89 50           ADOUTPUT:       MOV     FPCHR_OUT,R1
 2657:    0B83  C0 E0                           PUSH    ACC
 2658:                                          ;Convert 16 bit integer in R2:R0 to float and push it to fp arg stack
 2659:    0B85  12 03 FF                        LCALL   PUSHR2R0
 2660:                                          ;Push the channelS constant to fp arg stack
 2661:    0B88  90 0C B3                        MOV     DPTR,#ADCMUL
 2662:    0B8B  D0 E0                           POP     ACC
 2663:    0B8D  75 F0 06                        MOV     B,#FP_NUMBER_SIZE
 2664:    0B90  A4                              MUL     AB
 2665:    0B91  25 82                           ADD     A,DPL
 2666:    0B93  F5 82                           MOV     DPL,A
 2667:    0B95  50 02                           JNC     ADOUTPUT1
 2668:    0B97  05 83                           INC     DPH
 2669:    0B99  12 07 7B        ADOUTPUT1:      LCALL   PUSHC
 2670:                                          ;Multiply
 2671:    0B9C  12 01 D6                        LCALL   FLOATING_MUL
 2672:    0B9F  E5 24                           MOV     A,ARG_STACK
 2673:    0BA1  C3                              CLR     C
 2674:    0BA2  94 05                           SUBB    A,#05h
 2675:    0BA4  F8                              MOV     R0,A
 2676:    0BA5  12 04 C3                        LCALL   FLOATING_POINT_OUTPUT
 2677:    0BA8  22                              RET
 2678:
 2679:                          ;AD Converter
 2680:                          ;IN:    Nothing
 2681:                          ;OUT:   Nothing
 2682:    0BA9  74 03           ADCONVERTERINT: MOV     A,#03h                          ;Channel 3
 2683:    0BAB  12 0B 2C                        LCALL   ADCONVERT
 2684:    0BAE  74 03                           MOV     A,#03h
 2685:    0BB0  79 44                           MOV     R1,#LCDLINE+4
 2686:    0BB2  75 25 22                        MOV     FORMAT,#22h
 2687:    0BB5  12 0B 81                        LCALL   ADOUTPUT
 2688:    0BB8  74 07                           MOV     A,#07h                          ;Channel 7
 2689:    0BBA  12 0B 2C                        LCALL   ADCONVERT
 2690:    0BBD  74 07                           MOV     A,#07h
 2691:    0BBF  79 4A                           MOV     R1,#LCDLINE+10
 2692:    0BC1  75 25 13                        MOV     FORMAT,#13h
 2693:    0BC4  12 0B 81                        LCALL   ADOUTPUT
 2694:    0BC7  75 40 49                        MOV     LCDLINE,#'I'                    ;Output result
 2695:    0BCA  75 41 4E                        MOV     LCDLINE+1,#'N'
 2696:    0BCD  75 42 54                        MOV     LCDLINE+2,#'T'
 2697:    0BD0  75 43 20                        MOV     LCDLINE+3,#' '
 2698:    0BD3  74 00                           MOV     A,#00h
 2699:    0BD5  12 1D 42                        LCALL   LCDSETADR
 2700:    0BD8  78 40                           MOV     R0,#LCDLINE
 2701:    0BDA  7F 10                           MOV     R7,#10h
 2702:    0BDC  12 11 42                        LCALL   PRINTSTR
 2703:    0BDF  74 02                           MOV     A,#02h                          ;Channel 2
 2704:    0BE1  12 0B 2C                        LCALL   ADCONVERT
 2705:    0BE4  74 02                           MOV     A,#02h
 2706:    0BE6  79 44                           MOV     R1,#LCDLINE+4
 2707:    0BE8  75 25 22                        MOV     FORMAT,#22h
 2708:    0BEB  12 0B 81                        LCALL   ADOUTPUT
 2709:    0BEE  74 06                           MOV     A,#06h                          ;Channel 6
 2710:    0BF0  12 0B 2C                        LCALL   ADCONVERT
 2711:    0BF3  74 06                           MOV     A,#06h
 2712:    0BF5  79 4A                           MOV     R1,#LCDLINE+10
 2713:    0BF7  75 25 13                        MOV     FORMAT,#13h
 2714:    0BFA  12 0B 81                        LCALL   ADOUTPUT
 2715:    0BFD  75 40 49                        MOV     LCDLINE,#'I'                    ;Output result
 2716:    0C00  75 41 4E                        MOV     LCDLINE+1,#'N'
 2717:    0C03  75 42 54                        MOV     LCDLINE+2,#'T'
 2718:    0C06  75 43 20                        MOV     LCDLINE+3,#' '
 2719:    0C09  74 40                           MOV     A,#40h
 2720:    0C0B  12 1D 42                        LCALL   LCDSETADR
 2721:    0C0E  78 40                           MOV     R0,#LCDLINE
 2722:    0C10  7F 10                           MOV     R7,#10h
 2723:    0C12  12 11 42                        LCALL   PRINTSTR
 2724:    0C15  7F 14                           MOV     R7,#14h
 2725:    0C17  74 FA           ADCONVERTERINT1:MOV     A,#250
 2726:    0C19  12 1C 2A                        LCALL   WAIT                            ;Wait 25ms for relay to kick in / out
 2727:    0C1C  DF F9                           DJNZ    R7,ADCONVERTERINT1
 2728:    0C1E  02 10 38                        LJMP    START
 2729:
 2730:    0C21  74 01           ADCONVERTEREXT: MOV     A,#01h                          ;Channel 1
 2731:    0C23  12 0B 2C                        LCALL   ADCONVERT
 2732:    0C26  74 01                           MOV     A,#01h
 2733:    0C28  79 44                           MOV     R1,#LCDLINE+4
 2734:    0C2A  75 25 22                        MOV     FORMAT,#22h
 2735:    0C2D  12 0B 81                        LCALL   ADOUTPUT
 2736:    0C30  74 04                           MOV     A,#04h                          ;Channel 4
 2737:    0C32  12 0B 2C                        LCALL   ADCONVERT
 2738:    0C35  E8                              MOV     A,R0
 2739:    0C36  C3                              CLR     C
 2740:    0C37  94 73                           SUBB    A,#73h
 2741:    0C39  F8                              MOV     R0,A
 2742:    0C3A  EA                              MOV     A,R2
 2743:    0C3B  94 00                           SUBB    A,#00h
 2744:    0C3D  50 02                           JNC     ADCONVEXT
 2745:    0C3F  E4                              CLR     A
 2746:    0C40  F8                              MOV     R0,A
 2747:    0C41  FA              ADCONVEXT:      MOV     R2,A
 2748:    0C42  74 04                           MOV     A,#04h
 2749:    0C44  79 4A                           MOV     R1,#LCDLINE+10
 2750:    0C46  75 25 13                        MOV     FORMAT,#13h
 2751:    0C49  12 0B 81                        LCALL   ADOUTPUT
 2752:    0C4C  75 40 45                        MOV     LCDLINE,#'E'                    ;Output result
 2753:    0C4F  75 41 58                        MOV     LCDLINE+1,#'X'
 2754:    0C52  75 42 54                        MOV     LCDLINE+2,#'T'
 2755:    0C55  75 43 20                        MOV     LCDLINE+3,#' '
 2756:    0C58  74 00                           MOV     A,#00h
 2757:    0C5A  12 1D 42                        LCALL   LCDSETADR
 2758:    0C5D  78 40                           MOV     R0,#LCDLINE
 2759:    0C5F  7F 10                           MOV     R7,#10h
 2760:    0C61  12 11 42                        LCALL   PRINTSTR
 2761:    0C64  74 00                           MOV     A,#00h                          ;Channel 0
 2762:    0C66  12 0B 2C                        LCALL   ADCONVERT
 2763:    0C69  74 00                           MOV     A,#00h
 2764:    0C6B  79 44                           MOV     R1,#LCDLINE+4
 2765:    0C6D  75 25 22                        MOV     FORMAT,#22h
 2766:    0C70  12 0B 81                        LCALL   ADOUTPUT
 2767:    0C73  74 05                           MOV     A,#05h                          ;Channel 5
 2768:    0C75  12 0B 2C                        LCALL   ADCONVERT
 2769:    0C78  E8                              MOV     A,R0
 2770:    0C79  C3                              CLR     C
 2771:    0C7A  94 73                           SUBB    A,#73h
 2772:    0C7C  F8                              MOV     R0,A
 2773:    0C7D  EA                              MOV     A,R2
 2774:    0C7E  94 00                           SUBB    A,#00h
 2775:    0C80  50 02                           JNC     ADCONVEXT1
 2776:    0C82  E4                              CLR     A
 2777:    0C83  F8                              MOV     R0,A
 2778:    0C84  FA              ADCONVEXT1:     MOV     R2,A
 2779:    0C85  74 05                           MOV     A,#05h
 2780:    0C87  79 4A                           MOV     R1,#LCDLINE+10
 2781:    0C89  75 25 13                        MOV     FORMAT,#13h
 2782:    0C8C  12 0B 81                        LCALL   ADOUTPUT
 2783:    0C8F  75 40 56                        MOV     LCDLINE,#'V'                    ;Output result
 2784:    0C92  75 41 41                        MOV     LCDLINE+1,#'A'
 2785:    0C95  75 42 52                        MOV     LCDLINE+2,#'R'
 2786:    0C98  75 43 20                        MOV     LCDLINE+3,#' '
 2787:    0C9B  74 40                           MOV     A,#40h
 2788:    0C9D  12 1D 42                        LCALL   LCDSETADR
 2789:    0CA0  78 40                           MOV     R0,#LCDLINE
 2790:    0CA2  7F 10                           MOV     R7,#10h
 2791:    0CA4  12 11 42                        LCALL   PRINTSTR
 2792:    0CA7  7F 14                           MOV     R7,#14h
 2793:    0CA9  74 FA           ADCONVERTEREXT1:MOV     A,#250
 2794:    0CAB  12 1C 2A                        LCALL   WAIT                            ;Wait 25ms for relay to kick in / out
 2795:    0CAE  DF F9                           DJNZ    R7,ADCONVERTEREXT1
 2796:    0CB0  02 10 38                        LJMP    START
 2797:
 2798:                          ;------------------------------------------------------------------
 2799:    0CB3  7E 00 00 07     ADCMUL:         DB 7Eh,00h,00h,07h,03h,52h              ;CH0
          0CB7  03 52
 2800:    0CB9  7E 00 00 07                     DB 7Eh,00h,00h,07h,03h,16h              ;CH1
          0CBD  03 16
 2801:    0CBF  7E 00 00 00                     DB 7Eh,00h,00h,00h,02h,36h              ;CH2
          0CC3  02 36
 2802:    0CC5  7E 00 00 07                     DB 7Eh,00h,00h,07h,03h,16h              ;CH3
          0CC9  03 16
 2803:    0CCB  7D 00 00 00                     DB 7Dh,00h,00h,00h,50h,30h              ;CH4
          0CCF  50 30
 2804:    0CD1  7D 00 00 00                     DB 7Dh,00h,00h,00h,50h,30h              ;CH5
          0CD5  50 30
 2805:    0CD7  00 00 00 00                     DB 00h,00h,00h,00h,00h,00h              ;CH6
          0CDB  00 00
 2806:    0CDD  00 00 00 00                     DB 00h,00h,00h,00h,00h,00h              ;CH7
          0CE1  00 00
 2807:                          ;------------------------------------------------------------------
 2808:    0CE3  81 00 00 00     FPONE:          DB 81h,00h,00h,00h,00h,10h              ;1.0000000
          0CE7  00 10
 2809:    0CE9  81 00 00 00     FPTWO:          DB 81h,00h,00h,00h,00h,20h              ;2.0000000
          0CED  00 20
 2810:    0CEF  81 00 27 59     FPPI:           DB 81h,00h,27h,59h,41h,31h              ;3.1415927
          0CF3  41 31
 2811:    0CF5  77 00 00 00     FPCCAL:         DB 77h,00h,00h,00h,50h,94h              ;1nF=1e-9
          0CF9  50 94
 2812:    0CFB  8D 00 00 00     FPP:            DB 8Dh,00h,00h,00h,00h,10h              ;1e12
          0CFF  00 10
 2813:    0D01  8A 00 00 00     FPN:            DB 8Ah,00h,00h,00h,00h,10h              ;1e9
          0D05  00 10
 2814:    0D07  87 00 00 00     FPU:            DB 87h,00h,00h,00h,00h,10h              ;1e6
          0D0B  00 10
 2815:    0D0D  84 00 00 00     FPM:            DB 84h,00h,00h,00h,00h,10h              ;1e3
          0D11  00 10
 2816:                          ;------------------------------------------------------------------
 2817:
 2818:    0D13  54 65 72 6D     MODE0:          DB 'Terminal',0
          0D17  69 6E 61 6C
          0D1B  00
 2819:    0D1C  46 72 71 20     MODE1:          DB 'Frq Count',0
          0D20  43 6F 75 6E
          0D24  74 00
 2820:    0D26  46 72 71 20     MODE2:          DB 'Frq Count TTL',0
          0D2A  43 6F 75 6E
          0D2E  74 20 54 54
          0D32  4C 00
 2821:    0D34  46 72 71 20     MODE3:          DB 'Frq Count FG',0
          0D38  43 6F 75 6E
          0D3C  74 20 46 47
          0D40  00
 2822:    0D41  46 72 71 20     MODE4:          DB 'Frq Count LC',0
          0D45  43 6F 75 6E
          0D49  74 20 4C 43
          0D4D  00
 2823:    0D4E  46 72 71 20     MODE5:          DB 'Frq Count ALE',0
          0D52  43 6F 75 6E
          0D56  74 20 41 4C
          0D5A  45 00
 2824:    0D5C  56 6F 6C 74     MODE6:          DB 'Volts INT',0
          0D60  73 20 49 4E
          0D64  54 00
 2825:    0D66  56 6F 6C 74     MODE7:          DB 'Volts EXT',0
          0D6A  73 20 45 58
          0D6E  54 00
 2826:    0D70  4C 20 4D 65     MODE8:          DB 'L Meter',0
          0D74  74 65 72 00
 2827:    0D78  43 20 4D 65     MODE9:          DB 'C Meter',0
          0D7C  74 65 72 00
 2828:    0D80  43 61 6C 69     MODE10:         DB 'Calibrate',0
          0D84  62 72 61 74
          0D88  65 00
 2829:
 2830:          N      FFFF     IF DEVMODE=0
 2831:          N      1000                     ORG     1000h
 2832:                          ELSE
 2833:                                          ORG     3000h
 2834:                          ENDIF
 2835:
 2836:    1000  E4              START0:         CLR     A
 2837:    1001  F5 A8                           MOV     IE,A                            ;Disable all interrupts
 2838:    1003  F5 59                           MOV     MODE,A                          ;Set mode to RS232 Terminal
 2839:    1005  F5 21                           MOV     OUTD7D6,A
 2840:    1007  F5 20                           MOV     INTBITS,A                       ;RAM int routines (.0-.5 INTERRUPTS, .6=LCD OUT, .7 Single step)
 2841:    1009  14                              DEC     A
 2842:    100A  F5 5A                           MOV     SSADRLSB,A                      ;Single step adress
 2843:    100C  F5 5B                           MOV     SSADRMSB,A                      ;Single step adress
 2844:    100E  F5 B0                           MOV     P3,A                            ;All bits input
 2845:    1010  75 CA D9                        MOV     RCAP2L,#0D9h                    ;19200bps with 24MHz OSC
 2846:    1013  F5 CB                           MOV     RCAP2H,A
 2847:    1015  75 CC D9                        MOV     TL2,#0D9h
 2848:    1018  F5 CD                           MOV     TH2,A
 2849:    101A  75 C8 34                        MOV     T2CON,#34h                      ;TF2=l
 2850:                                                                                  ;EXF2=l
 2851:                                                                                  ;RCLK=h
 2852:                                                                                  ;TCLK=h
 2853:                                                                                  ;EXEN2=l
 2854:                                                                                  ;TR2=h
 2855:                                                                                  ;C/T2#=l
 2856:                                                                                  ;CP/RL2#=l
 2857:    101D  75 98 50                        MOV     SCON,#50h                       ;SM0=l
 2858:                                                                                  ;SM1=h
 2859:                                                                                  ;SM2=l
 2860:                                                                                  ;REN=h
 2861:                                                                                  ;TB8=l
 2862:                                                                                  ;RB8=l
 2863:                                                                                  ;TI=l
 2864:                                                                                  ;RI=l
 2865:    1020  75 53 01                        MOV     ROMACTION,#01h                  ;Action
 2866:    1023  75 54 02                        MOV     ROMSIZE,#02h                    ;Size
 2867:    1026  75 55 01                        MOV     ROMMODE,#01h                    ;Mode
 2868:
 2869:    1029  D2 A8                           SETB    EX0                             ;Enable INT0
 2870:    102B  D2 AA                           SETB    EX1                             ;Enable INT1
 2871:    102D  D2 AF                           SETB    EA                              ;Enable interrupts
 2872:    102F  12 1D 5B                        LCALL   LCDINIT
 2873:    1032  12 08 6E                        LCALL   LCMETERINIT
 2874:    1035  12 00 72                        LCALL   SETMODE
 2875:
 2876:          N      0000     IF DEVMODE=1
 2877:                                          MOV     INTBITS,#3Fh                    ;Redirect all interrupts, Output to LCD
 2878:          N      0000             IF DEBUG=1
 2879:                                          SETB    INTBITS.7                       ;Set single step flag
 2880:                                          CLR     IT1                             ;Level triggered
 2881:                                          CLR     P3.3                            ;Pull INT1 low
 2882:                                          NOP
 2883:                                          NOP
 2884:                                  ENDIF
 2885:                          ENDIF
 2886:
 2887:    1038  75 81 CF        START:          MOV     SP,#0CFh                        ;Init stack pointer. The stack is 48 bytes
 2888:    103B  90 20 00                        MOV     DPTR,#2000h
 2889:          N      0000     IF DEVMODE=1
 2890:                                          JNB     RI,START01
 2891:                                          MOV     INTBITS,#00h                    ;Redirect no interrupts
 2892:                                          LJMP    0000h
 2893:                          START01:
 2894:                          ENDIF
 2895:
 2896:    103E  75 24 80                        MOV     ARG_STACK,#80h
 2897:    1041  E5 59                           MOV     A,MODE
 2898:    1043  FF                              MOV     R7,A
 2899:    1044  70 02                           JNZ     START1
 2900:    1046  01 83                           AJMP    TERMINAL                        ;RS232 Terminal
 2901:    1048  DF 04           START1:         DJNZ    R7,START2
 2902:    104A  E4                              CLR     A                               ;Frequency counter channel0. External, Amplified
 2903:    104B  02 0A C8                        LJMP    FREQENCYCOUNT
 2904:    104E  DF 05           START2:         DJNZ    R7,START3                       ;Frequency counter channel0. External, TTL Level
 2905:    1050  74 80                           MOV     A,#80h
 2906:    1052  02 0A C8                        LJMP    FREQENCYCOUNT
 2907:    1055  DF 05           START3:         DJNZ    R7,START4
 2908:    1057  74 01                           MOV     A,#01h                          ;Frequency counter channel1. Function generator
 2909:    1059  02 0A C8                        LJMP    FREQENCYCOUNT
 2910:    105C  DF 05           START4:         DJNZ    R7,START5
 2911:    105E  74 02                           MOV     A,#02h                          ;Frequency counter channel2. LC Meter
 2912:    1060  02 0A C8                        LJMP    FREQENCYCOUNT
 2913:    1063  DF 05           START5:         DJNZ    R7,START6
 2914:    1065  74 03                           MOV     A,#03h                          ;Frequency counter channel3. ALE
 2915:    1067  02 0A C8                        LJMP    FREQENCYCOUNT
 2916:    106A  DF 03           START6:         DJNZ    R7,START7
 2917:    106C  02 0B A9                        LJMP    ADCONVERTERINT                  ;AD Coverter Internal PSU
 2918:    106F  DF 03           START7:         DJNZ    R7,START8
 2919:    1071  02 0C 21                        LJMP    ADCONVERTEREXT                  ;AD Coverter External PSU
 2920:    1074  DF 03           START8:         DJNZ    R7,START9
 2921:    1076  02 09 17                        LJMP    LMETER                          ;Inductance
 2922:    1079  DF 03           START9:         DJNZ    R7,START10
 2923:    107B  02 09 9F                        LJMP    CMETER                          ;Capacitance
 2924:    107E  12 08 6E        START10:        LCALL   LCMETERINIT                     ;Calibrate
 2925:    1081  80 B5                           SJMP    START
 2926:
 2927:                          ;------------------------------------------------------------------
 2928:
 2929:                          ;RS232 Terminal
 2930:                          ;IN:    Nothing
 2931:                          ;OUT:   Nothing
 2932:    1083  51 90           TERMINAL:       ACALL   HELPMENU
 2933:    1085  31 9C           TERMINAL1:      ACALL   PRNTCRLF
 2934:    1087  74 3E                           MOV     A,#3Eh
 2935:    1089  51 79                           ACALL   TXBYTE
 2936:    108B  51 62           TERMINAL2:      ACALL   RXBYTE
 2937:    108D  B4 41 06                        CJNE    A,#41h,TERMINAL3
 2938:                                          ;Address input
 2939:    1090  31 97                           ACALL   PRNTCMND
 2940:    1092  51 41                           ACALL   INPDPTR
 2941:    1094  80 EF                           SJMP    TERMINAL1
 2942:    1096  B4 44 06        TERMINAL3:      CJNE    A,#44h,TERMINAL4
 2943:                                          ;Dump
 2944:    1099  31 97                           ACALL   PRNTCMND
 2945:    109B  71 39                           ACALL   DUMP
 2946:    109D  80 E4                           SJMP    TERMINAL
 2947:    109F  B4 45 06        TERMINAL4:      CJNE    A,#45h,TERMINAL5
 2948:                                          ;Enter hex
 2949:    10A2  31 97                           ACALL   PRNTCMND
 2950:    10A4  71 65                           ACALL   ENTERHEX
 2951:    10A6  80 DB                           SJMP    TERMINAL
 2952:    10A8  B4 47 06        TERMINAL5:      CJNE    A,#47h,TERMINAL6
 2953:                                          ;Go
 2954:    10AB  31 97                           ACALL   PRNTCMND
 2955:    10AD  B1 5D                           ACALL   GO
 2956:    10AF  80 D2                           SJMP    TERMINAL
 2957:    10B1  B4 48 04        TERMINAL6:      CJNE    A,#48h,TERMINAL7
 2958:                                          ;Help
 2959:    10B4  31 97                           ACALL   PRNTCMND
 2960:    10B6  80 CB                           SJMP    TERMINAL
 2961:    10B8  B4 49 06        TERMINAL7:      CJNE    A,#49h,TERMINAL8
 2962:                                          ;Internal memory
 2963:    10BB  31 97                           ACALL   PRNTCMND
 2964:    10BD  71 97                           ACALL   MEMDUMP
 2965:    10BF  80 C4                           SJMP    TERMINAL1
 2966:    10C1  B4 4C 06        TERMINAL8:      CJNE    A,#4Ch,TERMINAL9
 2967:                                          ;Load
 2968:    10C4  31 97                           ACALL   PRNTCMND
 2969:    10C6  B1 30                           ACALL   LOAD
 2970:    10C8  80 BB                           SJMP    TERMINAL1
 2971:    10CA  B4 50 06        TERMINAL9:      CJNE    A,#50h,TERMINAL10
 2972:                                          ;Program ROM
 2973:    10CD  31 97                           ACALL   PRNTCMND
 2974:    10CF  B1 61                           ACALL   EPROM
 2975:    10D1  80 B0                           SJMP    TERMINAL
 2976:    10D3  B4 52 06        TERMINAL10:     CJNE    A,#52h,TERMINAL11
 2977:                                          ;Run
 2978:    10D6  31 97                           ACALL   PRNTCMND
 2979:    10D8  B1 5F                           ACALL   RUN
 2980:    10DA  80 A7                           SJMP    TERMINAL
 2981:    10DC  B4 53 07        TERMINAL11:     CJNE    A,#53h,TERMINAL12
 2982:                                          ;SFR dump
 2983:    10DF  12 11 97                        LCALL   PRNTCMND
 2984:    10E2  71 BA                           ACALL   DUMPSFR
 2985:    10E4  80 9F                           SJMP    TERMINAL1
 2986:    10E6  B4 46 06        TERMINAL12:     CJNE    A,#46h,TERMINAL13
 2987:                                          ;Enter float
 2988:    10E9  31 97                           ACALL   PRNTCMND
 2989:    10EB  71 7A                           ACALL   ENTERFLOAT
 2990:    10ED  80 96                           SJMP    TERMINAL1
 2991:    10EF  B4 9F 03        TERMINAL13:     CJNE    A,#9Fh,TERMINAL14
 2992:                                          ;Esc
 2993:    10F2  02 00 00                        LJMP    0000h
 2994:    10F5  B4 0D 93        TERMINAL14:     CJNE    A,#0Dh,TERMINAL2
 2995:                                          ;CR
 2996:    10F8  80 8B                           SJMP    TERMINAL1
 2997:
 2998:                          ;RS232 Functions
 2999:                          ;------------------------------------------------------------------
 3000:
 3001:    10FA  85 82 57        PRNTCSTR:       MOV     DPLSAVE,DPL
 3002:    10FD  85 83 58                        MOV     DPHSAVE,DPH
 3003:    1100  D0 83                           POP     DPH
 3004:    1102  D0 82                           POP     DPL
 3005:    1104  E4              PRNTCSTR1:      CLR     A
 3006:    1105  93                              MOVC    A,@A+DPTR
 3007:    1106  A3                              INC     DPTR
 3008:    1107  60 04                           JZ      PRNTCSTR2
 3009:    1109  51 79                           ACALL   TXBYTE
 3010:    110B  80 F7                           SJMP    PRNTCSTR1
 3011:    110D  C0 82           PRNTCSTR2:      PUSH    DPL
 3012:    110F  C0 83                           PUSH    DPH
 3013:    1111  85 57 82                        MOV     DPL,DPLSAVE
 3014:    1114  85 58 83                        MOV     DPH,DPHSAVE
 3015:    1117  22                              RET
 3016:
 3017:    1118  85 82 57        PRNTCSTRLCD:    MOV     DPLSAVE,DPL
 3018:    111B  85 83 58                        MOV     DPHSAVE,DPH
 3019:    111E  D0 83                           POP     DPH
 3020:    1120  D0 82                           POP     DPL
 3021:    1122  E4              PRNTCSTRLCD1:   CLR     A
 3022:    1123  93                              MOVC    A,@A+DPTR
 3023:    1124  A3                              INC     DPTR
 3024:    1125  60 05                           JZ      PRNTCSTRLCD2
 3025:    1127  12 1D 47                        LCALL   LCDCHROUT
 3026:    112A  80 F6                           SJMP    PRNTCSTRLCD1
 3027:    112C  C0 82           PRNTCSTRLCD2:   PUSH    DPL
 3028:    112E  C0 83                           PUSH    DPH
 3029:    1130  85 57 82                        MOV     DPL,DPLSAVE
 3030:    1133  85 58 83                        MOV     DPH,DPHSAVE
 3031:    1136  22                              RET
 3032:
 3033:    1137  E4              PRNTCDPTRLCD:   CLR     A
 3034:    1138  93                              MOVC    A,@A+DPTR
 3035:    1139  60 06                           JZ      PRNTCDPTRLCD1
 3036:    113B  12 1D 47                        LCALL   LCDCHROUT
 3037:    113E  A3                              INC     DPTR
 3038:    113F  80 F6                           SJMP    PRNTCDPTRLCD
 3039:    1141  22              PRNTCDPTRLCD1:  RET
 3040:
 3041:    1142  30 06 09        PRINTSTR:       JNB     INTBITS.6,PRINTSTRLCD
 3042:    1145  E6              PRINTSTRTRM:    MOV     A,@R0
 3043:    1146  51 79                           ACALL   TXBYTE
 3044:    1148  08                              INC     R0
 3045:    1149  DF FA                           DJNZ    R7,PRINTSTRTRM
 3046:    114B  31 9C                           ACALL   PRNTCRLF
 3047:    114D  22                              RET
 3048:
 3049:    114E  E6              PRINTSTRLCD:    MOV     A,@R0
 3050:    114F  12 1D 47                        LCALL   LCDCHROUT
 3051:    1152  08                              INC     R0
 3052:    1153  DF F9                           DJNZ    R7,PRINTSTRLCD
 3053:    1155  22                              RET
 3054:
 3055:    1156  E0              PRINTDPTRSTR:   MOVX    A,@DPTR
 3056:    1157  51 79                           ACALL   TXBYTE
 3057:    1159  A3                              INC     DPTR
 3058:    115A  B4 0D F9                        CJNE    A,#0Dh,PRINTDPTRSTR
 3059:    115D  74 0A                           MOV     A,#0Ah
 3060:    115F  51 79                           ACALL   TXBYTE
 3061:    1161  22                              RET
 3062:
 3063:    1162  75 50 40        PRINTFP:        MOV     FPCHR_OUT,#LCDLINE
 3064:    1165  75 25 00                        MOV     FORMAT,#00h
 3065:    1168  E5 24                           MOV     A,ARG_STACK
 3066:    116A  C3                              CLR     C
 3067:    116B  94 05                           SUBB    A,#05h
 3068:    116D  F8                              MOV     R0,A
 3069:    116E  12 04 C3                        LCALL   FLOATING_POINT_OUTPUT
 3070:    1171  A8 50                           MOV     R0,FPCHR_OUT
 3071:    1173  E4                              CLR     A
 3072:    1174  F6                              MOV     @R0,A
 3073:    1175  78 40                           MOV     R0,#LCDLINE
 3074:    1177  E6                              MOV     A,@R0
 3075:    1178  51 79           PRINTFP1:       ACALL   TXBYTE
 3076:    117A  08                              INC     R0
 3077:    117B  E6                              MOV     A,@R0
 3078:    117C  70 FA                           JNZ     PRINTFP1
 3079:    117E  74 20                           MOV     A,#20h
 3080:    1180  51 79                           ACALL   TXBYTE
 3081:    1182  74 20                           MOV     A,#20h
 3082:    1184  51 79                           ACALL   TXBYTE
 3083:    1186  74 20                           MOV     A,#20h
 3084:    1188  51 79                           ACALL   TXBYTE
 3085:    118A  74 20                           MOV     A,#20h
 3086:    118C  51 79                           ACALL   TXBYTE
 3087:    118E  74 0D                           MOV     A,#0Dh
 3088:    1190  51 79                           ACALL   TXBYTE
 3089:    1192  74 0A                           MOV     A,#0Ah
 3090:    1194  51 79                           ACALL   TXBYTE
 3091:    1196  22                              RET
 3092:
 3093:    1197  51 79           PRNTCMND:       ACALL   TXBYTE
 3094:    1199  31 9C                           ACALL   PRNTCRLF
 3095:    119B  22                              RET
 3096:
 3097:    119C  74 0D           PRNTCRLF:       MOV     A,#0Dh
 3098:    119E  51 79                           ACALL   TXBYTE
 3099:    11A0  74 0A                           MOV     A,#0Ah
 3100:    11A2  51 79                           ACALL   TXBYTE
 3101:    11A4  22                              RET
 3102:
 3103:    11A5  C0 E0           HEXOUT:         PUSH    ACC
 3104:    11A7  C4                              SWAP    A
 3105:    11A8  31 AC                           ACALL   HEXOUT1
 3106:    11AA  D0 E0                           POP     ACC
 3107:    11AC  54 0F           HEXOUT1:        ANL     A,#0Fh
 3108:    11AE  C3                              CLR     C
 3109:    11AF  94 0A                           SUBB    A,#0Ah
 3110:    11B1  40 02                           JC      HEXOUT2
 3111:    11B3  24 07                           ADD     A,#07h
 3112:    11B5  24 3A           HEXOUT2:        ADD     A,#3Ah
 3113:    11B7  51 79                           ACALL   TXBYTE
 3114:    11B9  22                              RET
 3115:
 3116:    11BA  78 08           BINOUT:         MOV     R0,#08h
 3117:    11BC  33              BINOUT1:        RLC     A
 3118:    11BD  C0 E0                           PUSH    ACC
 3119:    11BF  74 20                           MOV     A,#20h
 3120:    11C1  12 12 79                        LCALL   TXBYTE
 3121:    11C4  74 20                           MOV     A,#20h
 3122:    11C6  12 12 79                        LCALL   TXBYTE
 3123:    11C9  74 30                           MOV     A,#30H
 3124:    11CB  50 01           BINOUT2:        JNC     BINOUT3
 3125:    11CD  04                              INC     A
 3126:    11CE  12 12 79        BINOUT3:        LCALL   TXBYTE
 3127:    11D1  D0 E0                           POP     ACC
 3128:    11D3  D8 E7                           DJNZ    R0,BINOUT1
 3129:    11D5  12 11 9C                        LCALL   PRNTCRLF
 3130:    11D8  22                              RET
 3131:
 3132:    11D9  E5 83           HEXDPTR:        MOV     A,DPH
 3133:    11DB  31 A5                           ACALL   HEXOUT
 3134:    11DD  E5 82                           MOV     A,DPL
 3135:    11DF  31 A5                           ACALL   HEXOUT
 3136:    11E1  74 20                           MOV     A,#20h
 3137:    11E3  51 79                           ACALL   TXBYTE
 3138:    11E5  22                              RET
 3139:
 3140:    11E6  E5 24           HEXDUMPFP:      MOV     A,ARG_STACK
 3141:    11E8  C3                              CLR     C
 3142:    11E9  94 05                           SUBB    A,#05h
 3143:    11EB  F5 82                           MOV     DPL,A
 3144:    11ED  75 83 01                        MOV     DPH,#ARG_STACK_PAGE
 3145:    11F0  7F 06                           MOV     R7,#06h
 3146:    11F2  E0              HEXDUMPFP1:     MOVX    A,@DPTR
 3147:    11F3  31 A5                           ACALL   HEXOUT
 3148:    11F5  05 82                           INC     DPL
 3149:    11F7  DF F9                           DJNZ    R7,HEXDUMPFP1
 3150:    11F9  74 0D                           MOV     A,#0Dh
 3151:    11FB  51 79                           ACALL   TXBYTE
 3152:    11FD  74 0A                           MOV     A,#0Ah
 3153:    11FF  51 79                           ACALL   TXBYTE
 3154:    1201  22                              RET
 3155:
 3156:    1202  51 0E           HEXINPBYTE:     ACALL   HEXINP
 3157:    1204  40 07                           JC      HEXINPBYTE1
 3158:    1206  C4                              SWAP    A
 3159:    1207  FB                              MOV     R3,A
 3160:    1208  51 0E                           ACALL   HEXINP
 3161:    120A  40 01                           JC      HEXINPBYTE1
 3162:    120C  2B                              ADD     A,R3
 3163:    120D  22              HEXINPBYTE1:    RET
 3164:
 3165:    120E  51 1A           HEXINP:         ACALL   HEXINP2
 3166:    1210  40 07                           JC      HEXINP1
 3167:    1212  C0 E0                           PUSH    ACC
 3168:    1214  EA                              MOV     A,R2
 3169:    1215  51 79                           ACALL   TXBYTE
 3170:    1217  D0 E0                           POP     ACC
 3171:    1219  22              HEXINP1:        RET
 3172:
 3173:    121A  51 62           HEXINP2:        ACALL   RXBYTE
 3174:    121C  B4 9F 02                        CJNE    A,#9Fh,HEXINP3                  ;Esc
 3175:    121F  D3                              SETB    C
 3176:    1220  22                              RET
 3177:    1221  B4 0D 02        HEXINP3:        CJNE    A,#0Dh,HEXINP4                  ;Cr
 3178:    1224  D3                              SETB    C
 3179:    1225  22                              RET
 3180:    1226  FA              HEXINP4:        MOV     R2,A
 3181:    1227  B4 3A 00                        CJNE    A,#3Ah,HEXINP40
 3182:    122A  50 08           HEXINP40:       JNC     HEXINP5
 3183:    122C  B4 30 00                        CJNE    A,#30h,HEXINP41
 3184:    122F  40 E9           HEXINP41:       JC      HEXINP2
 3185:    1231  94 30                           SUBB    A,#30h
 3186:    1233  22                              RET
 3187:    1234  B4 47 00        HEXINP5:        CJNE    A,#47h,HEXINP50
 3188:    1237  50 E1           HEXINP50:       JNC     HEXINP2
 3189:    1239  B4 41 00                        CJNE    A,#41h,HEXINP51
 3190:    123C  40 DC           HEXINP51:       JC      HEXINP2
 3191:    123E  94 37                           SUBB    A,#37h
 3192:    1240  22                              RET
 3193:
 3194:    1241  31 D9           INPDPTR:        ACALL   HEXDPTR
 3195:    1243  51 02                           ACALL   HEXINPBYTE
 3196:    1245  40 08                           JC      INPDPTR1
 3197:    1247  F5 83                           MOV     DPH,A
 3198:    1249  51 02                           ACALL   HEXINPBYTE
 3199:    124B  40 02                           JC      INPDPTR1
 3200:    124D  F5 82                           MOV     DPL,A
 3201:    124F  31 9C           INPDPTR1:       ACALL   PRNTCRLF
 3202:    1251  22                              RET
 3203:
 3204:    1252  74 05           RX16BYTES:      MOV     A,#05h
 3205:    1254  51 79                           ACALL   TXBYTE
 3206:    1256  78 40                           MOV     R0,#ROMBUFF
 3207:    1258  51 62           RX16BYTES1:     ACALL   RXBYTE
 3208:    125A  F6                              MOV     @R0,A
 3209:    125B  08                              INC     R0
 3210:    125C  B8 50 F9                        CJNE    R0,#ROMBUFF+10h,RX16BYTES1
 3211:    125F  78 40                           MOV     R0,#ROMBUFF
 3212:    1261  22                              RET
 3213:
 3214:    1262  20 07 08        RXBYTE:         JB      20h.7,RXBYTE1
 3215:    1265  30 98 FD                        JNB     RI,$
 3216:    1268  C2 98                           CLR     RI
 3217:    126A  E5 99                           MOV     A,SBUF
 3218:    126C  22                              RET
 3219:
 3220:    126D  C2 AA           RXBYTE1:        CLR     EX1
 3221:    126F  30 98 FD                        JNB     RI,$
 3222:    1272  C2 98                           CLR     RI
 3223:    1274  E5 99                           MOV     A,SBUF
 3224:    1276  D2 AA                           SETB    EX1
 3225:    1278  22                              RET
 3226:
 3227:    1279  20 07 08        TXBYTE:         JB      20h.7,TXBYTE1
 3228:    127C  F5 99                           MOV     SBUF,A
 3229:    127E  30 99 FD                        JNB     TI,$
 3230:    1281  C2 99                           CLR     TI
 3231:    1283  22                              RET
 3232:
 3233:    1284  C2 AA           TXBYTE1:        CLR     EX1
 3234:    1286  F5 99                           MOV     SBUF,A
 3235:    1288  30 99 FD                        JNB     TI,$
 3236:    128B  C2 99                           CLR     TI
 3237:    128D  D2 AA                           SETB    EX1
 3238:    128F  22                              RET
 3239:
 3240:                          ;Functions
 3241:                          ;------------------------------------------------------------------
 3242:
 3243:    1290  11 FA           HELPMENU:       ACALL   PRNTCSTR
 3244:    1292  0E                              DB      0Eh
 3245:          N      0000     IF DEVMODE=1
 3246:                                          DB      '*** DEVMODE ***',0Dh,0Ah
 3247:                          ENDIF
 3248:    1293  41 20 41 64                     DB      'A Address input',0Dh,0Ah
          1297  64 72 65 73
          129B  73 20 69 6E
          129F  70 75 74 0D
          12A3  0A
 3249:    12A4  44 20 44 75                     DB      'D Dump as hex',0Dh,0Ah
          12A8  6D 70 20 61
          12AC  73 20 68 65
          12B0  78 0D 0A
 3250:    12B3  45 20 45 6E                     DB      'E Enter hex',0Dh,0Ah
          12B7  74 65 72 20
          12BB  68 65 78 0D
          12BF  0A
 3251:    12C0  46 20 45 6E                     DB      'F Enter float',0Dh,0Ah
          12C4  74 65 72 20
          12C8  66 6C 6F 61
          12CC  74 0D 0A
 3252:    12CF  47 20 47 6F                     DB      'G Go (Load and Run)',0Dh,0Ah
          12D3  20 28 4C 6F
          12D7  61 64 20 61
          12DB  6E 64 20 52
          12DF  75 6E 29 0D
          12E3  0A
 3253:    12E4  48 20 48 65                     DB      'H Help',0Dh,0Ah
          12E8  6C 70 0D 0A
 3254:    12EC  49 20 49 6E                     DB      'I Internal memory dump',0Dh,0Ah
          12F0  74 65 72 6E
          12F4  61 6C 20 6D
          12F8  65 6D 6F 72
          12FC  79 20 64 75
          1300  6D 70 0D 0A
 3255:    1304  4C 20 4C 6F                     DB      'L Load cmd file',0Dh,0Ah
          1308  61 64 20 63
          130C  6D 64 20 66
          1310  69 6C 65 0D
          1314  0A
 3256:    1315  50 20 50 72                     DB      'P Program ROM',0Dh,0Ah
          1319  6F 67 72 61
          131D  6D 20 52 4F
          1321  4D 0D 0A
 3257:    1324  52 20 52 75                     DB      'R Run',0Dh,0Ah
          1328  6E 0D 0A
 3258:    132B  53 20 53 46                     DB      'S SFR dunp',0Dh,0Ah,00h
          132F  52 20 64 75
          1333  6E 70 0D 0A
          1337  00
 3259:    1338  22                              RET
 3260:
 3261:    1339  C0 82           DUMP:           PUSH    DPL
 3262:    133B  C0 83                           PUSH    DPH
 3263:    133D  C0 02                           PUSH    02h
 3264:    133F  C0 03                           PUSH    03h
 3265:    1341  7B 10           DUMP1:          MOV     R3,#10h
 3266:    1343  7A 10           DUMP2:          MOV     R2,#10h
 3267:    1345  31 D9                           ACALL   HEXDPTR
 3268:    1347  E0              DUMP3:          MOVX    A,@DPTR
 3269:    1348  31 A5                           ACALL   HEXOUT
 3270:    134A  74 20                           MOV     A,#20h
 3271:    134C  51 79                           ACALL   TXBYTE
 3272:    134E  A3                              INC     DPTR
 3273:    134F  DA F6                           DJNZ    R2,DUMP3
 3274:    1351  31 9C                           ACALL   PRNTCRLF
 3275:    1353  DB EE                           DJNZ    R3,DUMP2
 3276:    1355  31 9C                           ACALL   PRNTCRLF
 3277:    1357  51 62                           ACALL   RXBYTE
 3278:    1359  B4 9F E5                        CJNE    A,#9Fh,DUMP1                    ;Esc
 3279:    135C  D0 03                           POP     03h
 3280:    135E  D0 02                           POP     02h
 3281:    1360  D0 83                           POP     DPH
 3282:    1362  D0 82                           POP     DPL
 3283:    1364  22                              RET
 3284:
 3285:    1365  C0 82           ENTERHEX:       PUSH    DPL
 3286:    1367  C0 83                           PUSH    DPH
 3287:    1369  31 D9           ENTERHEX1:      ACALL   HEXDPTR
 3288:    136B  51 02                           ACALL   HEXINPBYTE
 3289:    136D  40 06                           JC      ENTERHEX2
 3290:    136F  F0                              MOVX    @DPTR,A
 3291:    1370  A3                              INC     DPTR
 3292:    1371  31 9C                           ACALL   PRNTCRLF
 3293:    1373  80 F4                           SJMP    ENTERHEX1
 3294:    1375  D0 83           ENTERHEX2:      POP     DPH
 3295:    1377  D0 82                           POP     DPL
 3296:    1379  22                              RET
 3297:
 3298:    137A  C0 82           ENTERFLOAT:     PUSH    DPL
 3299:    137C  C0 83                           PUSH    DPH
 3300:    137E  90 00 48                        MOV     DPTR,#CONVT
 3301:    1381  51 62           ENTERFLOAT1:    ACALL   RXBYTE
 3302:    1383  51 79                           ACALL   TXBYTE
 3303:    1385  F0                              MOVX    @DPTR,A
 3304:    1386  A3                              INC     DPTR
 3305:    1387  B4 0D F7                        CJNE    A,#0Dh,ENTERFLOAT1
 3306:    138A  90 00 48                        MOV     DPTR,#CONVT
 3307:    138D  12 04 0B                        LCALL   FLOATING_POINT_INPUT
 3308:    1390  31 E6                           ACALL   HEXDUMPFP
 3309:    1392  D0 83                           POP     DPH
 3310:    1394  D0 82                           POP     DPL
 3311:    1396  22                              RET
 3312:
 3313:    1397  C0 00           MEMDUMP:        PUSH    00h
 3314:    1399  78 00                           MOV     R0,#00h
 3315:    139B  E4              MEMDUMP1:       CLR     A
 3316:    139C  31 A5                           ACALL   HEXOUT
 3317:    139E  E8                              MOV     A,R0
 3318:    139F  31 A5                           ACALL   HEXOUT
 3319:    13A1  74 20                           MOV     A,#20h
 3320:    13A3  51 79                           ACALL   TXBYTE
 3321:    13A5  E6              MEMDUMP2:       MOV     A,@R0
 3322:    13A6  31 A5                           ACALL   HEXOUT
 3323:    13A8  74 20                           MOV     A,#20h
 3324:    13AA  51 79                           ACALL   TXBYTE
 3325:    13AC  08                              INC     R0
 3326:    13AD  E8                              MOV     A,R0
 3327:    13AE  54 0F                           ANL     A,#0Fh
 3328:    13B0  70 F3                           JNZ     MEMDUMP2
 3329:    13B2  31 9C                           ACALL   PRNTCRLF
 3330:    13B4  E8                              MOV     A,R0
 3331:    13B5  70 E4                           JNZ     MEMDUMP1
 3332:    13B7  D0 00                           POP     00h
 3333:    13B9  22                              RET
 3334:
 3335:    13BA  C0 D0           DUMPSFR:        PUSH    PSW
 3336:    13BC  C2 D3                           CLR     RS0
 3337:    13BE  C2 D4                           CLR     RS1
 3338:    13C0  C0 E0                           PUSH    ACC
 3339:    13C2  C0 00                           PUSH    00h
 3340:    13C4  C0 E0                           PUSH    ACC
 3341:    13C6  12 10 FA                        LCALL   PRNTCSTR
 3342:    13C9  0D 0A 53 46                     DB 0Dh,0Ah,'SFR  D7 D6 D5 D4 D3 D2 D1 D0',0Dh,0Ah
          13CD  52 20 20 44
          13D1  37 20 44 36
          13D5  20 44 35 20
          13D9  44 34 20 44
          13DD  33 20 44 32
          13E1  20 44 31 20
          13E5  44 30 0D 0A
 3343:    13E9  2D 2D 2D 2D                     DB '----------------------------',0Dh,0Ah
          13ED  2D 2D 2D 2D
          13F1  2D 2D 2D 2D
          13F5  2D 2D 2D 2D
          13F9  2D 2D 2D 2D
          13FD  2D 2D 2D 2D
          1401  2D 2D 2D 2D
          1405  0D 0A
 3344:    1407  41 43 43 20                     DB 'ACC ',0
          140B  00
 3345:    140C  D0 E0                           POP     ACC
 3346:    140E  12 11 BA                        LCALL   BINOUT
 3347:    1411  12 10 FA                        LCALL   PRNTCSTR
 3348:    1414  42 20 20 20                     DB 'B   ',0
          1418  00
 3349:    1419  E5 F0                           MOV     A,B
 3350:    141B  12 11 BA                        LCALL   BINOUT
 3351:    141E  12 10 FA                        LCALL   PRNTCSTR
 3352:    1421  44 50 48 20                     DB 'DPH ',0
          1425  00
 3353:    1426  E5 83                           MOV     A,DPH
 3354:    1428  12 11 BA                        LCALL   BINOUT
 3355:    142B  12 10 FA                        LCALL   PRNTCSTR
 3356:    142E  44 50 4C 20                     DB 'DPL ',0
          1432  00
 3357:    1433  E5 82                           MOV     A,DPL
 3358:    1435  12 11 BA                        LCALL   BINOUT
 3359:    1438  12 10 FA                        LCALL   PRNTCSTR
 3360:    143B  49 45 20 20                     DB 'IE  ',0
          143F  00
 3361:    1440  E5 A8                           MOV     A,IE
 3362:    1442  12 11 BA                        LCALL   BINOUT
 3363:    1445  12 10 FA                        LCALL   PRNTCSTR
 3364:    1448  49 50 20 20                     DB 'IP  ',0
          144C  00
 3365:    144D  E5 B8                           MOV     A,IP
 3366:    144F  12 11 BA                        LCALL   BINOUT
 3367:    1452  12 10 FA                        LCALL   PRNTCSTR
 3368:    1455  50 30 20 20                     DB 'P0  ',0
          1459  00
 3369:    145A  E5 80                           MOV     A,P0
 3370:    145C  12 11 BA                        LCALL   BINOUT
 3371:    145F  12 10 FA                        LCALL   PRNTCSTR
 3372:    1462  50 31 20 20                     DB 'P1  ',0
          1466  00
 3373:    1467  E5 90                           MOV     A,P1
 3374:    1469  12 11 BA                        LCALL   BINOUT
 3375:    146C  12 10 FA                        LCALL   PRNTCSTR
 3376:    146F  50 32 20 20                     DB 'P2  ',0
          1473  00
 3377:    1474  E5 A0                           MOV     A,P2
 3378:    1476  12 11 BA                        LCALL   BINOUT
 3379:    1479  12 10 FA                        LCALL   PRNTCSTR
 3380:    147C  50 33 20 20                     DB 'P3  ',0
          1480  00
 3381:    1481  E5 B0                           MOV     A,P3
 3382:    1483  12 11 BA                        LCALL   BINOUT
 3383:    1486  12 10 FA                        LCALL   PRNTCSTR
 3384:    1489  50 43 4F 4E                     DB 'PCON',0
          148D  00
 3385:    148E  E5 87                           MOV     A,PCON
 3386:    1490  12 11 BA                        LCALL   BINOUT
 3387:    1493  12 10 FA                        LCALL   PRNTCSTR
 3388:    1496  50 53 57 20                     DB 'PSW ',0
          149A  00
 3389:    149B  E5 D0                           MOV     A,PSW
 3390:    149D  12 11 BA                        LCALL   BINOUT
 3391:    14A0  12 10 FA                        LCALL   PRNTCSTR
 3392:    14A3  53 42 55 46                     DB 'SBUF',0
          14A7  00
 3393:    14A8  E5 99                           MOV     A,SBUF
 3394:    14AA  12 11 BA                        LCALL   BINOUT
 3395:    14AD  12 10 FA                        LCALL   PRNTCSTR
 3396:    14B0  53 43 4F 4E                     DB 'SCON',0
          14B4  00
 3397:    14B5  E5 98                           MOV     A,SCON
 3398:    14B7  12 11 BA                        LCALL   BINOUT
 3399:    14BA  12 10 FA                        LCALL   PRNTCSTR
 3400:    14BD  53 50 20 20                     DB 'SP  ',0
          14C1  00
 3401:    14C2  E5 81                           MOV     A,SP
 3402:    14C4  12 11 BA                        LCALL   BINOUT
 3403:    14C7  12 10 FA                        LCALL   PRNTCSTR
 3404:    14CA  54 43 4F 4E                     DB 'TCON',0
          14CE  00
 3405:    14CF  E5 88                           MOV     A,TCON
 3406:    14D1  12 11 BA                        LCALL   BINOUT
 3407:    14D4  12 10 FA                        LCALL   PRNTCSTR
 3408:    14D7  54 48 30 20                     DB 'TH0 ',0
          14DB  00
 3409:    14DC  E5 8C                           MOV     A,TH0
 3410:    14DE  12 11 BA                        LCALL   BINOUT
 3411:    14E1  12 10 FA                        LCALL   PRNTCSTR
 3412:    14E4  54 48 31 20                     DB 'TH1 ',0
          14E8  00
 3413:    14E9  E5 8D                           MOV     A,TH1
 3414:    14EB  12 11 BA                        LCALL   BINOUT
 3415:    14EE  12 10 FA                        LCALL   PRNTCSTR
 3416:    14F1  54 4C 30 20                     DB 'TL0 ',0
          14F5  00
 3417:    14F6  E5 8A                           MOV     A,TL0
 3418:    14F8  12 11 BA                        LCALL   BINOUT
 3419:    14FB  12 10 FA                        LCALL   PRNTCSTR
 3420:    14FE  54 4C 31 20                     DB 'TL1 ',0
          1502  00
 3421:    1503  E5 8B                           MOV     A,TL1
 3422:    1505  12 11 BA                        LCALL   BINOUT
 3423:    1508  12 10 FA                        LCALL   PRNTCSTR
 3424:    150B  54 4D 4F 44                     DB 'TMOD',0
          150F  00
 3425:    1510  E5 89                           MOV     A,TMOD
 3426:    1512  12 11 BA                        LCALL   BINOUT
 3427:    1515  D0 00                           POP     00h
 3428:    1517  D0 E0                           POP     ACC
 3429:    1519  D0 D0                           POP     PSW
 3430:    151B  22                              RET
 3431:
 3432:    151C  7B 40           LOAD1K:         MOV     R3,#40h
 3433:    151E  51 52           LOAD1K1:        ACALL   RX16BYTES                       ;Read 16 bytes from cmd file
 3434:    1520  E6              LOAD1K2:        MOV     A,@R0
 3435:    1521  F0                              MOVX    @DPTR,A
 3436:    1522  A3                              INC     DPTR
 3437:    1523  08                              INC     R0
 3438:    1524  E8                              MOV     A,R0
 3439:    1525  64 50                           XRL     A,#50h
 3440:    1527  70 F7                           JNZ     LOAD1K2                         ;Not 16 bytes yet
 3441:    1529  DB F3                           DJNZ    R3,LOAD1K1                      ;Not 1K yet
 3442:    152B  74 2E                           MOV     A,#'.'
 3443:    152D  51 79                           ACALL   TXBYTE
 3444:    152F  22                              RET
 3445:
 3446:    1530  C0 82           LOAD:           PUSH    DPL
 3447:    1532  C0 83                           PUSH    DPH
 3448:    1534  C0 00                           PUSH    00h
 3449:    1536  C0 03                           PUSH    03h
 3450:    1538  C0 04                           PUSH    04h
 3451:    153A  11 FA                           ACALL   PRNTCSTR
 3452:    153C  4C 6F 61 64                     DB      'Loading .',0
          1540  69 6E 67 20
          1544  2E 00
 3453:    1546  7C 08                           MOV     R4,#08h
 3454:    1548  B1 1C           LOAD10:         ACALL   LOAD1K
 3455:    154A  DC FC                           DJNZ    R4,LOAD10
 3456:    154C  74 06                           MOV     A,#06h
 3457:    154E  51 79                           ACALL   TXBYTE                          ;End read 16 bytes from cmd file
 3458:    1550  31 9C                           ACALL   PRNTCRLF
 3459:    1552  D0 04                           POP     04h
 3460:    1554  D0 03                           POP     03h
 3461:    1556  D0 00                           POP     00h
 3462:    1558  D0 83                           POP     DPH
 3463:    155A  D0 82                           POP     DPL
 3464:    155C  22                              RET
 3465:
 3466:    155D  B1 30           GO:             ACALL   LOAD
 3467:    155F  E4              RUN:            CLR     A
 3468:    1560  73                              JMP     @A+DPTR
 3469:
 3470:                          ;ROM menu selection
 3471:                          ;------------------------------------------------------------------
 3472:
 3473:    1561  B1 D6           EPROM:          ACALL   ROMMENU
 3474:    1563  B4 94 6F                        CJNE    A,#94h,EPROMEXIT
 3475:    1566  12 18 69                        LCALL   ROMINSERT
 3476:    1569  40 F6                           JC      EPROM
 3477:    156B  12 1C A9                        LCALL   ROMINIT                         ;Turn on VCC, pull RST high and init programming mode
 3478:    156E  40 F1                           JC      EPROM                           ;Initialisation failed
 3479:    1570  E5 53                           MOV     A,ROMACTION
 3480:    1572  14                              DEC     A
 3481:    1573  70 12                           JNZ     EPROM2
 3482:                                          ;Test erased
 3483:    1575  12 19 13                        LCALL   ROMWAIT
 3484:    1578  E5 55                           MOV     A,ROMMODE
 3485:    157A  14                              DEC     A
 3486:    157B  70 05                           JNZ     EPROM1
 3487:    157D  12 19 23                        LCALL   BM_ROMERASED
 3488:    1580  80 DF                           SJMP    EPROM
 3489:    1582  12 1A 08        EPROM1:         LCALL   PM_ROMERASED
 3490:    1585  80 DA                           SJMP    EPROM
 3491:    1587  14              EPROM2:         DEC     A
 3492:    1588  70 12                           JNZ     EPROM3
 3493:                                          ;Dump to hex file
 3494:    158A  12 19 13                        LCALL   ROMWAIT
 3495:    158D  E5 55                           MOV     A,ROMMODE
 3496:    158F  14                              DEC     A
 3497:    1590  70 05                           JNZ     EPROM21
 3498:    1592  12 19 6F                        LCALL   BM_ROMDUMPF
 3499:    1595  80 CA                           SJMP    EPROM
 3500:    1597  12 1A 5F        EPROM21:        LCALL   PM_ROMDUMPF
 3501:    159A  80 C5                           SJMP    EPROM
 3502:    159C  14              EPROM3:         DEC     A
 3503:    159D  70 0F                           JNZ     EPROM4
 3504:                                          ;Dump to screen
 3505:    159F  E5 55                           MOV     A,ROMMODE
 3506:    15A1  14                              DEC     A
 3507:    15A2  70 05                           JNZ     EPROM31
 3508:    15A4  12 19 9B                        LCALL   BM_ROMDUMPS
 3509:    15A7  80 B8                           SJMP    EPROM
 3510:    15A9  12 1A 97        EPROM31:        LCALL   PM_ROMDUMPS
 3511:    15AC  80 B3                           SJMP    EPROM
 3512:    15AE  14              EPROM4:         DEC     A
 3513:    15AF  70 12                           JNZ     EPROM5
 3514:                                          ;Verify
 3515:    15B1  12 19 13                        LCALL   ROMWAIT
 3516:    15B4  E5 55                           MOV     A,ROMMODE
 3517:    15B6  14                              DEC     A
 3518:    15B7  70 05                           JNZ     EPROM41
 3519:    15B9  12 19 C8                        LCALL   BM_ROMVERIFY
 3520:    15BC  80 A3                           SJMP    EPROM
 3521:    15BE  12 1A CF        EPROM41:        LCALL   PM_ROMVERIFY
 3522:    15C1  80 9E                           SJMP    EPROM
 3523:    15C3                  EPROM5:         ;Program
 3524:    15C3  12 19 13                        LCALL   ROMWAIT
 3525:    15C6  E5 55                           MOV     A,ROMMODE
 3526:    15C8  14                              DEC     A
 3527:    15C9  70 05                           JNZ     EPROM51
 3528:    15CB  12 1B 46                        LCALL   PM_ROMPROG
 3529:    15CE  80 91                           SJMP    EPROM
 3530:    15D0  12 1B 46        EPROM51:        LCALL   PM_ROMPROG
 3531:    15D3  80 8C                           SJMP    EPROM
 3532:    15D5  22              EPROMEXIT:      RET
 3533:
 3534:    15D6  11 FA           ROMMENU:        ACALL   PRNTCSTR
 3535:    15D8  0E                              DB      0Eh
 3536:    15D9  20 20 20 2D                     DB      '   -----------------  -----------------  -----------------',0Dh,0Ah
          15DD  2D 2D 2D 2D
          15E1  2D 2D 2D 2D
          15E5  2D 2D 2D 2D
          15E9  2D 2D 2D 2D
          15ED  20 20 2D 2D
          15F1  2D 2D 2D 2D
          15F5  2D 2D 2D 2D
          15F9  2D 2D 2D 2D
          15FD  2D 2D 2D 20
          1601  20 2D 2D 2D
          1605  2D 2D 2D 2D
          1609  2D 2D 2D 2D
          160D  2D 2D 2D 2D
          1611  2D 2D 0D 0A
 3537:    1615  20 20 20 7C                     DB      '   |  Action       |  |  EEPROM size  |  |  Mode         |',0Dh,0Ah
          1619  20 20 41 63
          161D  74 69 6F 6E
          1621  20 20 20 20
          1625  20 20 20 7C
          1629  20 20 7C 20
          162D  20 45 45 50
          1631  52 4F 4D 20
          1635  73 69 7A 65
          1639  20 20 7C 20
          163D  20 7C 20 20
          1641  4D 6F 64 65
          1645  20 20 20 20
          1649  20 20 20 20
          164D  20 7C 0D 0A
 3538:    1651  20 20 20 2D                     DB      '   -----------------  -----------------  -----------------',0Dh,0Ah
          1655  2D 2D 2D 2D
          1659  2D 2D 2D 2D
          165D  2D 2D 2D 2D
          1661  2D 2D 2D 2D
          1665  20 20 2D 2D
          1669  2D 2D 2D 2D
          166D  2D 2D 2D 2D
          1671  2D 2D 2D 2D
          1675  2D 2D 2D 20
          1679  20 2D 2D 2D
          167D  2D 2D 2D 2D
          1681  2D 2D 2D 2D
          1685  2D 2D 2D 2D
          1689  2D 2D 0D 0A
 3539:    168D  20 20 20 7C                     DB      '   |  Test erased  |  |  4K           |  |  Byte         |',0Dh,0Ah
          1691  20 20 54 65
          1695  73 74 20 65
          1699  72 61 73 65
          169D  64 20 20 7C
          16A1  20 20 7C 20
          16A5  20 34 4B 20
          16A9  20 20 20 20
          16AD  20 20 20 20
          16B1  20 20 7C 20
          16B5  20 7C 20 20
          16B9  42 79 74 65
          16BD  20 20 20 20
          16C1  20 20 20 20
          16C5  20 7C 0D 0A
 3540:    16C9  20 20 20 7C                     DB      '   |  Filedump     |  |  8K           |  |  Page         |',0Dh,0Ah
          16CD  20 20 46 69
          16D1  6C 65 64 75
          16D5  6D 70 20 20
          16D9  20 20 20 7C
          16DD  20 20 7C 20
          16E1  20 38 4B 20
          16E5  20 20 20 20
          16E9  20 20 20 20
          16ED  20 20 7C 20
          16F1  20 7C 20 20
          16F5  50 61 67 65
          16F9  20 20 20 20
          16FD  20 20 20 20
          1701  20 7C 0D 0A
 3541:    1705  20 20 20 7C                     DB      '   |  Screendump   |  |  16K          |  |               |',0Dh,0Ah
          1709  20 20 53 63
          170D  72 65 65 6E
          1711  64 75 6D 70
          1715  20 20 20 7C
          1719  20 20 7C 20
          171D  20 31 36 4B
          1721  20 20 20 20
          1725  20 20 20 20
          1729  20 20 7C 20
          172D  20 7C 20 20
          1731  20 20 20 20
          1735  20 20 20 20
          1739  20 20 20 20
          173D  20 7C 0D 0A
 3542:    1741  20 20 20 7C                     DB      '   |  Verify       |  |  32K          |  |               |',0Dh,0Ah
          1745  20 20 56 65
          1749  72 69 66 79
          174D  20 20 20 20
          1751  20 20 20 7C
          1755  20 20 7C 20
          1759  20 33 32 4B
          175D  20 20 20 20
          1761  20 20 20 20
          1765  20 20 7C 20
          1769  20 7C 20 20
          176D  20 20 20 20
          1771  20 20 20 20
          1775  20 20 20 20
          1779  20 7C 0D 0A
 3543:    177D  20 20 20 7C                     DB      '   |  Program      |  |  64K          |  |               |',0Dh,0Ah
          1781  20 20 50 72
          1785  6F 67 72 61
          1789  6D 20 20 20
          178D  20 20 20 7C
          1791  20 20 7C 20
          1795  20 36 34 4B
          1799  20 20 20 20
          179D  20 20 20 20
          17A1  20 20 7C 20
          17A5  20 7C 20 20
          17A9  20 20 20 20
          17AD  20 20 20 20
          17B1  20 20 20 20
          17B5  20 7C 0D 0A
 3544:    17B9  20 20 20 2D                     DB      '   -----------------  -----------------  -----------------',0Dh,0Ah
          17BD  2D 2D 2D 2D
          17C1  2D 2D 2D 2D
          17C5  2D 2D 2D 2D
          17C9  2D 2D 2D 2D
          17CD  20 20 2D 2D
          17D1  2D 2D 2D 2D
          17D5  2D 2D 2D 2D
          17D9  2D 2D 2D 2D
          17DD  2D 2D 2D 20
          17E1  20 2D 2D 2D
          17E5  2D 2D 2D 2D
          17E9  2D 2D 2D 2D
          17ED  2D 2D 2D 2D
          17F1  2D 2D 0D 0A
 3545:    17F5  00                              DB      00h
 3546:    17F6  78 54                           MOV     R0,#ROMSIZE
 3547:    17F8  12 18 4C                        LCALL   MENUSET
 3548:    17FB  08                              INC     R0
 3549:    17FC  12 18 4C                        LCALL   MENUSET
 3550:    17FF  78 53                           MOV     R0,#ROMACTION
 3551:    1801  11 04                           ACALL   MENUXP
 3552:    1803  22                              RET
 3553:
 3554:    1804  12 18 4C        MENUXP:         LCALL   MENUSET
 3555:    1807  74 08                           MOV     A,#08h
 3556:    1809  12 12 79                        LCALL   TXBYTE
 3557:    180C  12 12 62                        LCALL   RXBYTE
 3558:    180F  B4 9A 0C                        CJNE    A,#9Ah,MENUXP1
 3559:    1812  E6                              MOV     A,@R0
 3560:    1813  14                              DEC     A
 3561:    1814  60 EE                           JZ      MENUXP
 3562:    1816  74 20                           MOV     A,#20h
 3563:    1818  12 12 79                        LCALL   TXBYTE
 3564:    181B  16                              DEC     @R0
 3565:    181C  80 E6                           SJMP    MENUXP
 3566:    181E  B4 9B 0D        MENUXP1:        CJNE    A,#9Bh,MENUXP2
 3567:    1821  E6                              MOV     A,@R0
 3568:    1822  94 05                           SUBB    A,#05h
 3569:    1824  60 DE                           JZ      MENUXP
 3570:    1826  74 20                           MOV     A,#20h
 3571:    1828  12 12 79                        LCALL   TXBYTE
 3572:    182B  06                              INC     @R0
 3573:    182C  80 D6                           SJMP    MENUXP
 3574:    182E  B4 9C 08        MENUXP2:        CJNE    A,#9Ch,MENUYP1
 3575:    1831  E8                              MOV     A,R0
 3576:    1832  94 55                           SUBB    A,#ROMMODE
 3577:    1834  60 CE                           JZ      MENUXP
 3578:    1836  08                              INC     R0
 3579:    1837  80 CB                           SJMP    MENUXP
 3580:    1839  B4 9D 08        MENUYP1:        CJNE    A,#9Dh,MENUYP2
 3581:    183C  E8                              MOV     A,R0
 3582:    183D  94 53                           SUBB    A,#ROMACTION
 3583:    183F  60 C3                           JZ      MENUXP
 3584:    1841  18                              DEC     R0
 3585:    1842  80 C0                           SJMP    MENUXP
 3586:    1844  B4 9F 01        MENUYP2:        CJNE    A,#9Fh,MENUYP3                  ;Esc
 3587:    1847  22                              RET
 3588:    1848  B4 94 B9        MENUYP3:        CJNE    A,#94h,MENUXP                   ;Insert
 3589:    184B  22                              RET
 3590:
 3591:    184C  74 0B           MENUSET:        MOV     A,#0Bh
 3592:    184E  12 12 79                        LCALL   TXBYTE
 3593:    1851  E6                              MOV     A,@R0
 3594:    1852  24 22                           ADD     A,#22h
 3595:    1854  12 12 79                        LCALL   TXBYTE
 3596:    1857  E8                              MOV     A,R0
 3597:    1858  94 53                           SUBB    A,#ROMACTION
 3598:    185A  75 F0 13                        MOV     B,#13h
 3599:    185D  A4                              MUL     AB
 3600:    185E  24 24                           ADD     A,#24h
 3601:    1860  12 12 79                        LCALL   TXBYTE
 3602:    1863  74 FB                           MOV     A,#0FBh                         ;
 3603:    1865  12 12 79                        LCALL   TXBYTE
 3604:    1868  22                              RET
 3605:
 3606:                          ;------------------------------------------------------------------
 3607:
 3608:    1869  12 1C 59        ROMINSERT:      LCALL   ROMOFF
 3609:    186C  12 10 FA                        LCALL   PRNTCSTR
 3610:    186F  0B 2A 23 49                     DB      0Bh,2Ah,23h,'Insert ',00h
          1873  6E 73 65 72
          1877  74 20 00
 3611:    187A  E5 54                           MOV     A,ROMSIZE
 3612:    187C  14                              DEC     A
 3613:    187D  70 09                           JNZ     ROMINSERT1
 3614:    187F  12 10 FA                        LCALL   PRNTCSTR
 3615:    1882  34 4B 00                        DB      '4K',00h
 3616:    1885  75 52 10                        MOV     ROMPAGES,#10h                   ;16 Pages
 3617:    1888  14              ROMINSERT1:     DEC     A
 3618:    1889  70 09                           JNZ     ROMINSERT2
 3619:    188B  12 10 FA                        LCALL   PRNTCSTR
 3620:    188E  38 4B 00                        DB      '8K',00h
 3621:    1891  75 52 20                        MOV     ROMPAGES,#20h                   ;32 Pages
 3622:    1894  14              ROMINSERT2:     DEC     A
 3623:    1895  70 0A                           JNZ     ROMINSERT3
 3624:    1897  12 10 FA                        LCALL   PRNTCSTR
 3625:    189A  31 36 4B 00                     DB      '16K',00h
 3626:    189E  75 52 40                        MOV     ROMPAGES,#40h                   ;64 Pages
 3627:    18A1  14              ROMINSERT3:     DEC     A
 3628:    18A2  70 0A                           JNZ     ROMINSERT4
 3629:    18A4  12 10 FA                        LCALL   PRNTCSTR
 3630:    18A7  33 32 4B 00                     DB      '32K',00h
 3631:    18AB  75 52 80                        MOV     ROMPAGES,#80h                   ;128 Pages
 3632:    18AE  14              ROMINSERT4:     DEC     A
 3633:    18AF  70 0A                           JNZ     ROMINSERT5
 3634:    18B1  12 10 FA                        LCALL   PRNTCSTR
 3635:    18B4  36 34 4B 00                     DB      '64K',00h
 3636:    18B8  75 52 00                        MOV     ROMPAGES,#00h                   ;256 Pages
 3637:    18BB  12 10 FA        ROMINSERT5:     LCALL   PRNTCSTR
 3638:    18BE  20 64 65 76                     DB      ' device and strike <Enter> ',00h
          18C2  69 63 65 20
          18C6  61 6E 64 20
          18CA  73 74 72 69
          18CE  6B 65 20 3C
          18D2  45 6E 74 65
          18D6  72 3E 20 00
 3639:    18DA  12 12 62                        LCALL   RXBYTE
 3640:    18DD  B4 9F 02                        CJNE    A,#9Fh,ROMINSERT6               ;Esc
 3641:    18E0  D3                              SETB    C
 3642:    18E1  22                              RET
 3643:    18E2  12 10 FA        ROMINSERT6:     LCALL   PRNTCSTR
 3644:    18E5  0B 2A 23 20                     DB      0Bh,2Ah,23h,'                                       '
          18E9  20 20 20 20
          18ED  20 20 20 20
          18F1  20 20 20 20
          18F5  20 20 20 20
          18F9  20 20 20 20
          18FD  20 20 20 20
          1901  20 20 20 20
          1905  20 20 20 20
          1909  20 20 20 20
          190D  20 20
 3645:    190F  0D 00                           DB      0Dh,00h
 3646:    1911  C3                              CLR     C
 3647:    1912  22                              RET
 3648:
 3649:    1913  12 10 FA        ROMWAIT:        LCALL   PRNTCSTR
 3650:    1916  0B 2A 23 57                     DB      0Bh,2Ah,23h,'Wait ...',00h
          191A  61 69 74 20
          191E  2E 2E 2E 00
 3651:    1922  22                              RET
 3652:
 3653:
 3654:                          ;Byte mode
 3655:                          ;------------------------------------------------------------------
 3656:
 3657:    1923  12 1C B9        BM_ROMERASED:   LCALL   BM_ROMRDBYTE                    ;Read a byte from ROM
 3658:    1926  B4 FF 0E                        CJNE    A,#0FFh,BM_ROMERASED1           ;Not erased
 3659:    1929  A3                              INC     DPTR                            ;Next address
 3660:    192A  E5 82                           MOV     A,DPL
 3661:    192C  70 F5                           JNZ     BM_ROMERASED                    ;Jump if more bytes in this page
 3662:    192E  E5 83                           MOV     A,DPH
 3663:    1930  B5 52 F0                        CJNE    A,ROMPAGES,BM_ROMERASED         ;Jump if more pages
 3664:    1933  12 1C 59                        LCALL   ROMOFF                          ;Set RST low and turn off VCC
 3665:    1936  22                              RET
 3666:    1937  12 1C 59        BM_ROMERASED1:  LCALL   ROMOFF                          ;Set RST low and turn off VCC
 3667:    193A  12 10 FA                        LCALL   PRNTCSTR
 3668:    193D  0B 2A 23 42                     DB      0Bh,2Ah,23h,'Byte at ',00h
          1941  79 74 65 20
          1945  61 74 20 00
 3669:    1949  E5 83                           MOV     A,DPH
 3670:    194B  12 11 A5                        LCALL   HEXOUT                          ;High address
 3671:    194E  E5 82                           MOV     A,DPL
 3672:    1950  12 11 A5                        LCALL   HEXOUT                          ;Low address
 3673:    1953  12 10 FA                        LCALL   PRNTCSTR
 3674:    1956  20 6E 6F 74                     DB      ' not erased <Enter> ',00h
          195A  20 65 72 61
          195E  73 65 64 20
          1962  3C 45 6E 74
          1966  65 72 3E 20
          196A  00
 3675:    196B  12 12 62                        LCALL   RXBYTE                          ;Wait for keypress
 3676:    196E  22                              RET
 3677:
 3678:    196F  74 03           BM_ROMDUMPF:    MOV     A,#03h
 3679:    1971  12 12 79                        LCALL   TXBYTE                          ;Init write to file
 3680:    1974  12 1C B9        BM_ROMDUMPF1:   LCALL   BM_ROMRDBYTE                    ;Read a byte from ROM
 3681:    1977  12 11 A5                        LCALL   HEXOUT                          ;Output as hex
 3682:    197A  74 20                           MOV     A,#20h
 3683:    197C  12 12 79                        LCALL   TXBYTE                          ;Output a space
 3684:    197F  A3                              INC     DPTR
 3685:    1980  E5 82                           MOV     A,DPL
 3686:    1982  54 0F                           ANL     A,#0Fh
 3687:    1984  70 03                           JNZ     BM_ROMDUMPF2                    ;Still on same line
 3688:    1986  12 11 9C                        LCALL   PRNTCRLF                        ;Output CRLF
 3689:    1989  E5 82           BM_ROMDUMPF2:   MOV     A,DPL
 3690:    198B  70 E7                           JNZ     BM_ROMDUMPF1                    ;Jump if more bytes in this page
 3691:    198D  E5 83                           MOV     A,DPH
 3692:    198F  B5 52 E2                        CJNE    A,ROMPAGES,BM_ROMDUMPF1         ;Jump if more pages
 3693:    1992  74 04                           MOV     A,#04h
 3694:    1994  12 12 79                        LCALL   TXBYTE                          ;End write to file
 3695:    1997  12 1C 59                        LCALL   ROMOFF                          ;Set RST low and turn off VCC
 3696:    199A  22              BM_ROMDUMPF3:   RET
 3697:
 3698:    199B  12 1C B9        BM_ROMDUMPS:    LCALL   BM_ROMRDBYTE                    ;Read a byte from ROM
 3699:    199E  12 11 A5                        LCALL   HEXOUT                          ;Output as hex
 3700:    19A1  74 20                           MOV     A,#20h
 3701:    19A3  12 12 79                        LCALL   TXBYTE                          ;Output a space
 3702:    19A6  A3                              INC     DPTR                            ;Next ROM address
 3703:    19A7  E5 82                           MOV     A,DPL
 3704:    19A9  54 0F                           ANL     A,#0Fh
 3705:    19AB  70 03                           JNZ     BM_ROMDUMPS1                    ;Jump if still on same line
 3706:    19AD  12 11 9C                        LCALL   PRNTCRLF                        ;Output CRLF
 3707:    19B0  E5 82           BM_ROMDUMPS1:   MOV     A,DPL
 3708:    19B2  70 E7                           JNZ     BM_ROMDUMPS                     ;Jump if more bytes in this page
 3709:    19B4  12 11 9C                        LCALL   PRNTCRLF                        ;Output CRLF
 3710:    19B7  12 12 62                        LCALL   RXBYTE                          ;Wait for a keypress
 3711:    19BA  B4 9F 02                        CJNE    A,#9Fh,BM_ROMDUMPS2
 3712:    19BD  80 05                           SJMP    BM_ROMDUMPS3
 3713:    19BF  E5 83           BM_ROMDUMPS2:   MOV     A,DPH
 3714:    19C1  B5 52 D7                        CJNE    A,ROMPAGES,BM_ROMDUMPS          ;Jump if more pages
 3715:    19C4  12 1C 59        BM_ROMDUMPS3:   LCALL   ROMOFF                          ;Set RST low and turn off VCC
 3716:    19C7  22                              RET
 3717:
 3718:    19C8  C0 00           BM_ROMVERIFY:   PUSH    00h                             ;Save R0
 3719:    19CA  75 56 00                        MOV     ROMVERERR,#00h                  ;Number of errors
 3720:    19CD  12 12 52                        LCALL   RX16BYTES                       ;Read 16 bytes from cmd file. R0 points to start of 16 byte buffer
 3721:    19D0  86 51           BM_ROMVERIFY1:  MOV     ROMVER,@R0                      ;Get byte from buffer
 3722:    19D2  12 1C B9                        LCALL   BM_ROMRDBYTE                    ;Read a byte from ROM
 3723:    19D5  B5 51 1D                        CJNE    A,ROMVER,BM_ROMVERIFY4          ;Compare and jump if not equal
 3724:    19D8  08              BM_ROMVERIFY2:  INC     R0                              ;Increment buffer pointer
 3725:    19D9  E8                              MOV     A,R0
 3726:    19DA  B4 50 03                        CJNE    A,#50h,BM_ROMVERIFY3            ;Jump if not last byte in buffer
 3727:    19DD  12 12 52                        LCALL   RX16BYTES                       ;Read 16 bytes from cmd file. R0 points to start of 16 byte buffer
 3728:    19E0  A3              BM_ROMVERIFY3:  INC     DPTR                            ;Next ROM address
 3729:    19E1  E5 82                           MOV     A,DPL
 3730:    19E3  70 EB                           JNZ     BM_ROMVERIFY1                   ;Jump if still on same page
 3731:    19E5  E5 83                           MOV     A,DPH
 3732:    19E7  B5 52 E6                        CJNE    A,ROMPAGES,BM_ROMVERIFY1        ;Jump if more pages
 3733:    19EA  12 1C 59                        LCALL   ROMOFF                          ;Set RST low and turn off VCC
 3734:    19ED  74 06                           MOV     A,#06h
 3735:    19EF  12 12 79                        LCALL   TXBYTE                          ;End read 16 bytes from cmd file
 3736:    19F2  D0 00                           POP     00h                             ;Restore R0
 3737:    19F4  22                              RET
 3738:    19F5  12 1C CE        BM_ROMVERIFY4:  LCALL   ROMVERIFYERR
 3739:    19F8  50 DE                           JNC     BM_ROMVERIFY2                   ;Jump if less than 16 errors
 3740:    19FA  12 1C 59                        LCALL   ROMOFF                          ;Set RST low and turn off VCC
 3741:    19FD  74 06                           MOV     A,#06h
 3742:    19FF  12 12 79                        LCALL   TXBYTE                          ;End read 16 bytes from cmd file
 3743:    1A02  12 12 62                        LCALL   RXBYTE                          ;Wait for a keypress
 3744:    1A05  D0 00                           POP     00h                             ;Restore R0
 3745:    1A07  22                              RET
 3746:
 3747:                          ;Page mode
 3748:                          ;------------------------------------------------------------------
 3749:
 3750:    1A08  74 30           PM_ROMERASED:   MOV     A,#30h
 3751:    1A0A  12 1C 31                        LCALL   ISPCOMM                         ;Init read page mode
 3752:    1A0D  E5 83                           MOV     A,DPH
 3753:    1A0F  12 1C 31                        LCALL   ISPCOMM                         ;Send high address
 3754:    1A12  E4              PM_ROMERASED1:  CLR     A
 3755:    1A13  12 1C 31                        LCALL   ISPCOMM                         ;Get byte from ROM
 3756:    1A16  B4 FF 0E                        CJNE    A,#0FFh,PM_ROMERASED2           ;Jump if not erased
 3757:    1A19  A3                              INC     DPTR
 3758:    1A1A  E5 82                           MOV     A,DPL
 3759:    1A1C  70 F4                           JNZ     PM_ROMERASED1                   ;Jump if more bytes on this page
 3760:    1A1E  E5 83                           MOV     A,DPH
 3761:    1A20  B5 52 E5                        CJNE    A,ROMPAGES,PM_ROMERASED         ;Jump if more pagees
 3762:    1A23  12 1C 59                        LCALL   ROMOFF                          ;Set RST low and turn off VCC
 3763:    1A26  22                              RET
 3764:    1A27  12 1C 59        PM_ROMERASED2:  LCALL   ROMOFF                          ;Set RST low and turn off VCC
 3765:    1A2A  12 10 FA                        LCALL   PRNTCSTR
 3766:    1A2D  0B 2A 23 42                     DB      0Bh,2Ah,23h,'Byte at ',00h
          1A31  79 74 65 20
          1A35  61 74 20 00
 3767:    1A39  E5 83                           MOV     A,DPH
 3768:    1A3B  12 11 A5                        LCALL   HEXOUT                          ;Output high address as hex
 3769:    1A3E  E5 82                           MOV     A,DPL
 3770:    1A40  12 11 A5                        LCALL   HEXOUT                          ;Output low address as hex
 3771:    1A43  12 10 FA                        LCALL   PRNTCSTR
 3772:    1A46  20 6E 6F 74                     DB      ' not erased <Enter> ',00h
          1A4A  20 65 72 61
          1A4E  73 65 64 20
          1A52  3C 45 6E 74
          1A56  65 72 3E 20
          1A5A  00
 3773:    1A5B  12 12 62                        LCALL   RXBYTE                          ;Wait for a keypress
 3774:    1A5E  22                              RET
 3775:
 3776:    1A5F  74 03           PM_ROMDUMPF:    MOV     A,#03h
 3777:    1A61  12 12 79                        LCALL   TXBYTE                          ;Init Output to hex file
 3778:    1A64  74 30           PM_ROMDUMPF1:   MOV     A,#30h
 3779:    1A66  12 1C 31                        LCALL   ISPCOMM                         ;Init read page mode
 3780:    1A69  E5 83                           MOV     A,DPH
 3781:    1A6B  12 1C 31                        LCALL   ISPCOMM                         ;Send high address
 3782:    1A6E  E4              PM_ROMDUMPF2:   CLR     A
 3783:    1A6F  12 1C 31                        LCALL   ISPCOMM                         ;Get byte from ROM
 3784:    1A72  12 11 A5                        LCALL   HEXOUT                          ;Output as hex
 3785:    1A75  74 20                           MOV     A,#20h
 3786:    1A77  12 12 79                        LCALL   TXBYTE                          ;Output a space
 3787:    1A7A  A3                              INC     DPTR
 3788:    1A7B  E5 82                           MOV     A,DPL
 3789:    1A7D  54 0F                           ANL     A,#0Fh
 3790:    1A7F  B4 00 07                        CJNE    A,#00h,PM_ROMDUMPF3             ;Jump if more bytes in this line
 3791:    1A82  12 11 9C                        LCALL   PRNTCRLF                        ;Output CRLF
 3792:    1A85  E5 82                           MOV     A,DPL
 3793:    1A87  70 E5                           JNZ     PM_ROMDUMPF2                    ;Jump if more bytes in this page
 3794:    1A89  E5 83           PM_ROMDUMPF3:   MOV     A,DPH
 3795:    1A8B  B5 52 D6                        CJNE    A,ROMPAGES,PM_ROMDUMPF1         ;Jump if more pages
 3796:    1A8E  74 04                           MOV     A,#04h
 3797:    1A90  12 12 79                        LCALL   TXBYTE                          ;End Output to hex file
 3798:    1A93  12 1C 59                        LCALL   ROMOFF                          ;Set RST low and turn off VCC
 3799:    1A96  22                              RET
 3800:
 3801:    1A97  74 30           PM_ROMDUMPS:    MOV     A,#30h
 3802:    1A99  12 1C 31                        LCALL   ISPCOMM                         ;Init read page mode
 3803:    1A9C  E5 83                           MOV     A,DPH
 3804:    1A9E  12 1C 31                        LCALL   ISPCOMM                         ;Send high address
 3805:    1AA1  E4              PM_ROMDUMPS1:   CLR     A
 3806:    1AA2  12 1C 31                        LCALL   ISPCOMM                         ;Get byte from ROM
 3807:    1AA5  12 11 A5                        LCALL   HEXOUT                          ;Output as hex
 3808:    1AA8  74 20                           MOV     A,#20h
 3809:    1AAA  12 12 79                        LCALL   TXBYTE                          ;Output a space
 3810:    1AAD  A3                              INC     DPTR
 3811:    1AAE  E5 82                           MOV     A,DPL
 3812:    1AB0  54 0F                           ANL     A,#0Fh
 3813:    1AB2  70 12                           JNZ     PM_ROMDUMPS2                    ;Jump if still on same line
 3814:    1AB4  12 11 9C                        LCALL   PRNTCRLF                        ;Output CRLF
 3815:    1AB7  E5 82                           MOV     A,DPL
 3816:    1AB9  70 E6                           JNZ     PM_ROMDUMPS1                    ;Jump if more bytes on this page
 3817:    1ABB  12 11 9C                        LCALL   PRNTCRLF                        ;Output CRLF
 3818:    1ABE  12 12 62                        LCALL   RXBYTE                          ;Wait for a keypress
 3819:    1AC1  B4 9F 02                        CJNE    A,#9Fh,PM_ROMDUMPS2
 3820:    1AC4  80 05                           SJMP    PM_ROMDUMPS3                    ;Esc pressed
 3821:    1AC6  E5 83           PM_ROMDUMPS2:   MOV     A,DPH
 3822:    1AC8  B5 52 CC                        CJNE    A,ROMPAGES,PM_ROMDUMPS          ;Jump if more pages
 3823:    1ACB  12 1C 59        PM_ROMDUMPS3:   LCALL   ROMOFF                          ;Set RST low and turn off VCC
 3824:    1ACE  22                              RET
 3825:
 3826:    1ACF  C0 00           PM_ROMVERIFY:   PUSH    00h                             ;Save R0
 3827:    1AD1  75 56 00                        MOV     ROMVERERR,#00h                  ;Number of errors
 3828:    1AD4  12 12 52                        LCALL   RX16BYTES                       ;Read 16 bytes from cmd file. R0 points to start of 16 byte buffer
 3829:    1AD7  74 30           PM_ROMVERIFY1:  MOV     A,#30h
 3830:    1AD9  12 1C 31                        LCALL   ISPCOMM                         ;Init read page mode
 3831:    1ADC  E5 83                           MOV     A,DPH
 3832:    1ADE  12 1C 31                        LCALL   ISPCOMM                         ;Send high address
 3833:    1AE1  86 51           PM_ROMVERIFY2:  MOV     ROMVER,@R0                      ;Get byte from buffer
 3834:    1AE3  E4                              CLR     A
 3835:    1AE4  12 1C 31                        LCALL   ISPCOMM                         ;Get byte from ROM
 3836:    1AE7  B5 51 1D                        CJNE    A,ROMVER,PM_ROMVERIFY5          ;Compare and jump if not equal
 3837:    1AEA  08              PM_ROMVERIFY3:  INC     R0                              ;Increment buffer pointer
 3838:    1AEB  E8                              MOV     A,R0
 3839:    1AEC  B4 50 03                        CJNE    A,#50h,PM_ROMVERIFY4            ;Jump if not last byte in buffer
 3840:    1AEF  12 12 52                        LCALL   RX16BYTES                       ;Read 16 bytes from cmd file. R0 points to start of 16 byte buffer
 3841:    1AF2  A3              PM_ROMVERIFY4:  INC     DPTR
 3842:    1AF3  E5 82                           MOV     A,DPL
 3843:    1AF5  70 EA                           JNZ     PM_ROMVERIFY2                   ;Jump if still on same page
 3844:    1AF7  E5 83                           MOV     A,DPH
 3845:    1AF9  B5 52 DB                        CJNE    A,ROMPAGES,PM_ROMVERIFY1        ;Jump if more pages
 3846:    1AFC  12 1C 59                        LCALL   ROMOFF                          ;Set RST low and turn off VCC
 3847:    1AFF  74 06                           MOV     A,#06h
 3848:    1B01  12 12 79                        LCALL   TXBYTE                          ;End read 16 bytes from cmd file
 3849:    1B04  D0 00                           POP     00h                             ;Restore R0
 3850:    1B06  22                              RET
 3851:    1B07  12 1C CE        PM_ROMVERIFY5:  LCALL   ROMVERIFYERR
 3852:    1B0A  50 DE                           JNC     PM_ROMVERIFY3                   ;Jump if less than 16 errors
 3853:    1B0C  12 1C 59                        LCALL   ROMOFF                          ;Set RST low and turn off VCC
 3854:    1B0F  74 06                           MOV     A,#06h
 3855:    1B11  12 12 79                        LCALL   TXBYTE                          ;End read 16 bytes from cmd file
 3856:    1B14  12 12 62                        LCALL   RXBYTE                          ;Wait for keypress
 3857:    1B17  D0 00                           POP     00h                             ;Restore R0
 3858:    1B19  22                              RET
 3859:
 3860:    1B1A  90 00 00        PM_ISERASED:    MOV     DPTR,#0000h
 3861:    1B1D  75 56 00                        MOV     ROMVERERR,#00h
 3862:    1B20  74 30           PM_ISERASED1:   MOV     A,#30h
 3863:    1B22  12 1C 31                        LCALL   ISPCOMM                         ;Init read page mode
 3864:    1B25  E5 83                           MOV     A,DPH
 3865:    1B27  12 1C 31                        LCALL   ISPCOMM                         ;Send high address
 3866:    1B2A  E4              PM_ISERASED2:   CLR     A
 3867:    1B2B  12 1C 31                        LCALL   ISPCOMM                         ;Get byte from ROM
 3868:    1B2E  04                              INC     A
 3869:    1B2F  42 56                           ORL     ROMVERERR,A
 3870:    1B31  A3                              INC     DPTR
 3871:    1B32  E5 82                           MOV     A,DPL
 3872:    1B34  70 F4                           JNZ     PM_ISERASED2                    ;Jump if more bytes on this page
 3873:    1B36  E5 56                           MOV     A,ROMVERERR
 3874:    1B38  70 05                           JNZ     PM_ISERASED3
 3875:    1B3A  E5 83                           MOV     A,DPH
 3876:    1B3C  B5 52 E1                        CJNE    A,ROMPAGES,PM_ISERASED1         ;Jump if more pagees
 3877:    1B3F  C3              PM_ISERASED3:   CLR     C
 3878:    1B40  E5 56                           MOV     A,ROMVERERR
 3879:    1B42  60 01                           JZ      PM_ISERASED4
 3880:    1B44  D3                              SETB    C
 3881:    1B45  22              PM_ISERASED4:   RET
 3882:
 3883:    1B46  12 1B 1A        PM_ROMPROG:     LCALL   PM_ISERASED                     ;Check if chip is erased
 3884:    1B49  50 4E                           JNC     PM_ROMPROG1
 3885:    1B4B  74 AC                           MOV     A,#0ACh
 3886:    1B4D  12 1C 31                        LCALL   ISPCOMM                         ;Init chip erase byte 1
 3887:    1B50  74 80                           MOV     A,#80h
 3888:    1B52  12 1C 31                        LCALL   ISPCOMM                         ;Init chip erase byte 2
 3889:    1B55  E4                              CLR     A
 3890:    1B56  12 1C 31                        LCALL   ISPCOMM                         ;Init chip erase byte 3
 3891:    1B59  E4                              CLR     A
 3892:    1B5A  12 1C 31                        LCALL   ISPCOMM                         ;Init chip erase byte 4
 3893:    1B5D  E4                              CLR     A
 3894:    1B5E  12 1C 2A                        LCALL   WAIT                            ;Wait 256 ms
 3895:    1B61  E4                              CLR     A
 3896:    1B62  12 1C 2A                        LCALL   WAIT                            ;Wait 256 ms
 3897:    1B65  E4                              CLR     A
 3898:    1B66  12 1C 2A                        LCALL   WAIT                            ;Wait 256 ms
 3899:    1B69  12 1B 1A                        LCALL   PM_ISERASED
 3900:    1B6C  50 2B                           JNC     PM_ROMPROG1
 3901:    1B6E  12 1C 59                        LCALL   ROMOFF                          ;Set RST low and turn off VCC
 3902:    1B71  12 10 FA                        LCALL   PRNTCSTR
 3903:    1B74  0B 2A 23 43                     DB      0Bh,2Ah,23h,'Could not erase chip <Enter> ',00h
          1B78  6F 75 6C 64
          1B7C  20 6E 6F 74
          1B80  20 65 72 61
          1B84  73 65 20 63
          1B88  68 69 70 20
          1B8C  3C 45 6E 74
          1B90  65 72 3E 20
          1B94  00
 3904:    1B95  12 12 62                        LCALL   RXBYTE                          ;Wait for keypress
 3905:    1B98  22                              RET
 3906:    1B99  C0 00           PM_ROMPROG1:    PUSH    00h
 3907:    1B9B  90 00 00                        MOV     DPTR,#0000h
 3908:    1B9E  12 12 52                        LCALL   RX16BYTES                       ;Read 16 bytes from cmd file. R0 points to start of 16 byte buffer
 3909:    1BA1  74 40           PM_ROMPROG2:    MOV     A,#40h
 3910:    1BA3  12 1C 31                        LCALL   ISPCOMM                         ;Init byte programming mode
 3911:    1BA6  E5 83                           MOV     A,DPH
 3912:    1BA8  12 1C 31                        LCALL   ISPCOMM                         ;Send high address
 3913:    1BAB  E5 82                           MOV     A,DPL
 3914:    1BAD  12 1C 31                        LCALL   ISPCOMM                         ;Send low address
 3915:    1BB0  E6                              MOV     A,@R0                           ;Get byte from buffer
 3916:    1BB1  F5 51                           MOV     ROMVER,A
 3917:    1BB3  12 1C 31                        LCALL   ISPCOMM                         ;Send byte to be programmed
 3918:    1BB6  74 10                           MOV     A,#10h
 3919:    1BB8  12 1C 2A                        LCALL   WAIT                            ;Wait 1mS
 3920:    1BBB  12 1C B9                        LCALL   BM_ROMRDBYTE                    ;Read a byte from ROM
 3921:    1BBE  B5 51 22                        CJNE    A,ROMVER,PM_ROMPROG4            ;Compare and jump if not equal
 3922:    1BC1  08                              INC     R0
 3923:    1BC2  E8                              MOV     A,R0
 3924:    1BC3  B4 50 03                        CJNE    A,#50h,PM_ROMPROG3
 3925:    1BC6  12 12 52                        LCALL   RX16BYTES                       ;Read 16 bytes from cmd file. R0 points to start of 16 byte buffer
 3926:    1BC9  A3              PM_ROMPROG3:    INC     DPTR
 3927:    1BCA  E5 82                           MOV     A,DPL
 3928:    1BCC  70 D3                           JNZ     PM_ROMPROG2                     ;Jump if still on same page
 3929:    1BCE  74 2E                           MOV     A,#2Eh
 3930:    1BD0  12 12 79                        LCALL   TXBYTE
 3931:    1BD3  E5 83                           MOV     A,DPH
 3932:    1BD5  B5 52 C9                        CJNE    A,ROMPAGES,PM_ROMPROG2          ;Jump if more pages
 3933:    1BD8  12 1C 59                        LCALL   ROMOFF                          ;Set RST low and turn off VCC
 3934:    1BDB  74 06                           MOV     A,#06h
 3935:    1BDD  12 12 79                        LCALL   TXBYTE                          ;End read 16 bytes from cmd file
 3936:    1BE0  D0 00                           POP     00h
 3937:    1BE2  22                              RET
 3938:    1BE3  C0 E0           PM_ROMPROG4:    PUSH    ACC
 3939:    1BE5  12 1C 59                        LCALL   ROMOFF                          ;Set RST low and turn off VCC
 3940:    1BE8  74 06                           MOV     A,#06h
 3941:    1BEA  12 12 79                        LCALL   TXBYTE                          ;End read 16 bytes from cmd file
 3942:    1BED  12 10 FA                        LCALL   PRNTCSTR
 3943:    1BF0  0B 2A 23 45                     DB      0Bh,2Ah,23h,'Error at ',00h
          1BF4  72 72 6F 72
          1BF8  20 61 74 20
          1BFC  00
 3944:    1BFD  E5 83                           MOV     A,DPH
 3945:    1BFF  12 11 A5                        LCALL   HEXOUT                          ;High address
 3946:    1C02  E5 82                           MOV     A,DPL
 3947:    1C04  12 11 A5                        LCALL   HEXOUT                          ;Low address
 3948:    1C07  74 20                           MOV     A,#20h
 3949:    1C09  12 12 79                        LCALL   TXBYTE
 3950:    1C0C  E5 51                           MOV     A,ROMVER                        ;Byte from .cmd file
 3951:    1C0E  12 11 A5                        LCALL   HEXOUT
 3952:    1C11  74 20                           MOV     A,#20h
 3953:    1C13  12 12 79                        LCALL   TXBYTE
 3954:    1C16  D0 E0                           POP     ACC
 3955:    1C18  12 11 A5                        LCALL   HEXOUT                          ;Byte read from ROM
 3956:    1C1B  12 12 62                        LCALL   RXBYTE                          ;Wait for a keypress
 3957:    1C1E  D0 00                           POP     00h                             ;Restore R0
 3958:    1C20  22                              RET
 3959:
 3960:                          ;Wait functions
 3961:                          ;------------------------------------------------------------------
 3962:
 3963:    1C21  C0 07           WAIT100:        PUSH    07h                             ;Save R7
 3964:    1C23  7F 64                           MOV     R7,#64h
 3965:    1C25  DF FE           WAIT1001:       DJNZ    R7,WAIT1001                     ;Wait loop, 100uS
 3966:    1C27  D0 07                           POP     07h                             ;Restore R7
 3967:    1C29  22                              RET
 3968:
 3969:    1C2A  CF              WAIT:           XCH     A,R7
 3970:    1C2B  91 21           WAIT1:          ACALL   WAIT100
 3971:    1C2D  DF FC                           DJNZ    R7,WAIT1
 3972:    1C2F  CF                              XCH     A,R7
 3973:    1C30  22                              RET
 3974:
 3975:                          ;Control functions
 3976:                          ;------------------------------------------------------------------
 3977:
 3978:                          ;IN A, OUT A
 3979:    1C31  C0 07           ISPCOMM:        PUSH    07h
 3980:    1C33  C0 02                           PUSH    02h
 3981:    1C35  7A 08                           MOV     R2,#08h
 3982:    1C37  33              ISPCOMM1:       RLC     A
 3983:    1C38  92 93                           MOV     P1.3,C                          ;MISO
 3984:    1C3A  A2 94                           MOV     C,P1.4                          ;MOSI
 3985:    1C3C  CF                              XCH     A,R7
 3986:    1C3D  33                              RLC     A
 3987:    1C3E  CF                              XCH     A,R7
 3988:    1C3F  D2 92                           SETB    P1.2                            ;SCK H
 3989:    1C41  00                              NOP
 3990:    1C42  C2 92                           CLR     P1.2                            ;SCK L
 3991:    1C44  DA F1                           DJNZ    R2,ISPCOMM1
 3992:    1C46  EF                              MOV     A,R7
 3993:    1C47  D0 02                           POP     02
 3994:    1C49  D0 07                           POP     07
 3995:    1C4B  22                              RET
 3996:
 3997:    1C4C  D2 90           ROMON:          SETB    P1.0                            ;+5V On
 3998:    1C4E  74 0A                           MOV     A,#0Ah
 3999:    1C50  91 2A                           ACALL   WAIT                            ;Wait 1mS
 4000:    1C52  D2 91                           SETB    P1.1                            ;RST H
 4001:    1C54  74 0A                           MOV     A,#0Ah
 4002:    1C56  91 2A                           ACALL   WAIT                            ;Wait 1mS
 4003:    1C58  22                              RET
 4004:
 4005:    1C59  C2 91           ROMOFF:         CLR     P1.1                            ;RST L
 4006:    1C5B  74 01                           MOV     A,#01h
 4007:    1C5D  91 2A                           ACALL   WAIT                            ;Wait 100uS
 4008:    1C5F  75 90 10                        MOV     P1,#10h                         ;+5V Off, P1.4 As Input
 4009:    1C62  74 0A                           MOV     A,#0Ah
 4010:    1C64  12 1C 2A                        LCALL   WAIT                            ;Wait 1mS
 4011:    1C67  22                              RET
 4012:
 4013:    1C68  74 AC           ROMINITPGM:     MOV     A,#0ACh
 4014:    1C6A  12 1C 31                        LCALL   ISPCOMM
 4015:    1C6D  74 53                           MOV     A,#53h
 4016:    1C6F  12 1C 31                        LCALL   ISPCOMM
 4017:    1C72  74 00                           MOV     A,#00h
 4018:    1C74  12 1C 31                        LCALL   ISPCOMM
 4019:    1C77  74 00                           MOV     A,#00h
 4020:    1C79  12 1C 31                        LCALL   ISPCOMM
 4021:    1C7C  B4 69 01                        CJNE    A,#69h,ROMINITPGM1
 4022:    1C7F  22                              RET
 4023:    1C80  12 10 FA        ROMINITPGM1:    LCALL   PRNTCSTR
 4024:    1C83  0B 2A 23 49                     DB      0Bh,2Ah,23h,'Initialisation Error <Enter> ',00h
          1C87  6E 69 74 69
          1C8B  61 6C 69 73
          1C8F  61 74 69 6F
          1C93  6E 20 45 72
          1C97  72 6F 72 20
          1C9B  3C 45 6E 74
          1C9F  65 72 3E 20
          1CA3  00
 4025:    1CA4  12 12 62                        LCALL   RXBYTE
 4026:    1CA7  D3                              SETB    C
 4027:    1CA8  22                              RET
 4028:
 4029:    1CA9  90 00 00        ROMINIT:        MOV     DPTR,#0000h                     ;DPTR holds ROM address
 4030:    1CAC  12 1C 4C                        LCALL   ROMON                           ;Turn on VCC and pull RST high
 4031:    1CAF  12 1C 68                        LCALL   ROMINITPGM
 4032:    1CB2  50 04                           JNC     ROMINIT1
 4033:    1CB4  12 1C 59                        LCALL   ROMOFF                          ;Init programming failed
 4034:    1CB7  D3                              SETB    C
 4035:    1CB8  22              ROMINIT1:       RET
 4036:
 4037:    1CB9  74 20           BM_ROMRDBYTE:   MOV     A,#20h
 4038:    1CBB  12 1C 31                        LCALL   ISPCOMM
 4039:    1CBE  E5 83                           MOV     A,DPH
 4040:    1CC0  12 1C 31                        LCALL   ISPCOMM
 4041:    1CC3  E5 82                           MOV     A,DPL
 4042:    1CC5  12 1C 31                        LCALL   ISPCOMM
 4043:    1CC8  74 00                           MOV     A,#00h
 4044:    1CCA  12 1C 31                        LCALL   ISPCOMM
 4045:    1CCD  22                              RET
 4046:
 4047:    1CCE  C0 E0           ROMVERIFYERR:   PUSH    ACC
 4048:    1CD0  12 10 FA                        LCALL   PRNTCSTR
 4049:    1CD3  0D 20 20 20                     DB      0Dh,'   Error at ',00h
          1CD7  45 72 72 6F
          1CDB  72 20 61 74
          1CDF  20 00
 4050:    1CE1  E5 83                           MOV     A,DPH
 4051:    1CE3  12 11 A5                        LCALL   HEXOUT
 4052:    1CE6  E5 82                           MOV     A,DPL
 4053:    1CE8  12 11 A5                        LCALL   HEXOUT
 4054:    1CEB  74 20                           MOV     A,#20h
 4055:    1CED  12 12 79                        LCALL   TXBYTE
 4056:    1CF0  E5 51                           MOV     A,ROMVER
 4057:    1CF2  12 11 A5                        LCALL   HEXOUT
 4058:    1CF5  74 20                           MOV     A,#20h
 4059:    1CF7  12 12 79                        LCALL   TXBYTE
 4060:    1CFA  D0 E0                           POP     ACC
 4061:    1CFC  12 11 A5                        LCALL   HEXOUT
 4062:    1CFF  12 11 9C                        LCALL   PRNTCRLF
 4063:    1D02  05 56                           INC     ROMVERERR
 4064:    1D04  E5 56                           MOV     A,ROMVERERR
 4065:    1D06  B4 10 00                        CJNE    A,#10h,ROMVERIFYERR1
 4066:    1D09  B3              ROMVERIFYERR1:  CPL     C
 4067:    1D0A  22                              RET
 4068:
 4069:                          ;LCD Output.
 4070:                          ;-----------------------------------------------------
 4071:    1D0B  C0 07           LCDDELAY:       PUSH    07h
 4072:    1D0D  7F 00                           MOV     R7,#00h
 4073:    1D0F  DF FE                           DJNZ    R7,$
 4074:    1D11  D0 07                           POP     07h
 4075:    1D13  22                              RET
 4076:
 4077:                          ;A contains nibble
 4078:    1D14  C0 82           LCDNIBOUT:      PUSH    DPL
 4079:    1D16  C0 83                           PUSH    DPH
 4080:    1D18  90 80 00                        MOV     DPTR,#8000h
 4081:    1D1B  45 21                           ORL     A,OUTD7D6
 4082:    1D1D  D2 E5                           SETB    ACC.5                           ;E
 4083:    1D1F  F0                              MOVX    @DPTR,A                         ;
 4084:    1D20  C2 E5                           CLR     ACC.5                           ;Negative edge on E
 4085:    1D22  F0                              MOVX    @DPTR,A                         ;
 4086:    1D23  D0 83                           POP     DPH
 4087:    1D25  D0 82                           POP     DPL
 4088:    1D27  22                              RET
 4089:
 4090:                          ;A contains byte
 4091:    1D28  C0 E0           LCDCMDOUT:      PUSH    ACC
 4092:    1D2A  C4                              SWAP    A                               ;High nibble first
 4093:    1D2B  54 0F                           ANL     A,#0Fh
 4094:    1D2D  B1 14                           ACALL   LCDNIBOUT
 4095:    1D2F  D0 E0                           POP     ACC
 4096:    1D31  54 0F                           ANL     A,#0Fh
 4097:    1D33  B1 14                           ACALL   LCDNIBOUT
 4098:    1D35  B1 0B                           ACALL   LCDDELAY                        ;Wait for BF to clear
 4099:    1D37  22                              RET
 4100:
 4101:    1D38  74 01           LCDCLEAR:       MOV     A,#00000001b
 4102:    1D3A  B1 28                           ACALL   LCDCMDOUT
 4103:    1D3C  74 10                           MOV     A,#10h
 4104:    1D3E  12 1C 2A                        LCALL   WAIT
 4105:    1D41  22                              RET
 4106:
 4107:                          ;A contais address
 4108:    1D42  44 80           LCDSETADR:      ORL     A,#10000000b
 4109:    1D44  B1 28                           ACALL   LCDCMDOUT
 4110:    1D46  22                              RET
 4111:
 4112:                          ;A contains byte
 4113:    1D47  C0 E0           LCDCHROUT:      PUSH    ACC
 4114:    1D49  C4                              SWAP    A                               ;High nibble first
 4115:    1D4A  54 0F                           ANL     A,#0Fh
 4116:    1D4C  D2 E4                           SETB    ACC.4                           ;RS
 4117:    1D4E  B1 14                           ACALL   LCDNIBOUT
 4118:    1D50  D0 E0                           POP     ACC
 4119:    1D52  54 0F                           ANL     A,#0Fh
 4120:    1D54  D2 E4                           SETB    ACC.4                           ;RS
 4121:    1D56  B1 14                           ACALL   LCDNIBOUT
 4122:    1D58  B1 0B                           ACALL   LCDDELAY                        ;Wait for BF to clear
 4123:    1D5A  22                              RET
 4124:
 4125:    1D5B  74 03           LCDINIT:        MOV     A,#00000011b                    ;Function set
 4126:    1D5D  B1 14                           ACALL   LCDNIBOUT
 4127:    1D5F  B1 0B                           ACALL   LCDDELAY                        ;Wait for BF to clear
 4128:    1D61  74 28                           MOV     A,#00101000b
 4129:    1D63  B1 28                           ACALL   LCDCMDOUT
 4130:    1D65  74 28                           MOV     A,#00101000b
 4131:    1D67  B1 28                           ACALL   LCDCMDOUT
 4132:    1D69  74 0C                           MOV     A,#00001100b                    ;Display ON/OFF
 4133:    1D6B  B1 28                           ACALL   LCDCMDOUT
 4134:    1D6D  B1 38                           ACALL   LCDCLEAR                        ;Clear
 4135:    1D6F  74 06                           MOV     A,#00000110b                    ;Cursor direction
 4136:    1D71  B1 28                           ACALL   LCDCMDOUT
 4137:    1D73  22                              RET
 4138:
 4139:                          ;Single step called when INT1 pin low and interupt is enabled
 4140:                          ;------------------------------------------------------------------
 4141:    1D74  C0 D0           SINGLESTEP:     PUSH    PSW
 4142:    1D76  C0 E0                           PUSH    ACC
 4143:    1D78  C2 D3                           CLR     RS0
 4144:    1D7A  C2 D4                           CLR     RS1
 4145:    1D7C  C0 00                           PUSH    00h
 4146:    1D7E  A8 81                           MOV     R0,SP
 4147:    1D80  18                              DEC     R0                              ;Skip PSW
 4148:    1D81  18                              DEC     R0                              ;Skip ACC
 4149:    1D82  18                              DEC     R0                              ;Skip R0
 4150:    1D83  E5 5B                           MOV     A,SSADRMSB
 4151:    1D85  04                              INC     A
 4152:    1D86  60 0A                           JZ      SINGLESTEP0
 4153:    1D88  E6                              MOV     A,@R0                           ;MSB adress
 4154:    1D89  B5 5B 74                        CJNE    A,SSADRMSB,SINGLESTEPEX2
 4155:    1D8C  18                              DEC     R0
 4156:    1D8D  E6                              MOV     A,@R0                           ;MSB adress
 4157:    1D8E  08                              INC     R0
 4158:    1D8F  B5 5A 6E                        CJNE    A,SSADRLSB,SINGLESTEPEX2
 4159:    1D92  74 07           SINGLESTEP0:    MOV     A,#07h
 4160:    1D94  12 12 79                        LCALL   TXBYTE
 4161:    1D97  E6                              MOV     A,@R0                           ;MSB adress
 4162:    1D98  12 12 79                        LCALL   TXBYTE
 4163:    1D9B  18                              DEC     R0
 4164:    1D9C  E6                              MOV     A,@R0                           ;LSB adress
 4165:    1D9D  12 12 79                        LCALL   TXBYTE
 4166:    1DA0  08                              INC     R0                              ;MSB adress
 4167:    1DA1  08                              INC     R0                              ;PSW
 4168:    1DA2  E6                              MOV     A,@R0                           ;PSW
 4169:    1DA3  12 12 79                        LCALL   TXBYTE
 4170:    1DA6  08                              INC     R0                              ;ACC
 4171:    1DA7  E6                              MOV     A,@R0                           ;ACC
 4172:    1DA8  12 12 79                        LCALL   TXBYTE
 4173:    1DAB  E5 F0                           MOV     A,B                             ;B
 4174:    1DAD  12 12 79                        LCALL   TXBYTE
 4175:    1DB0  E5 81                           MOV     A,SP                            ;SP
 4176:    1DB2  C3                              CLR     C
 4177:    1DB3  94 05                           SUBB    A,#05h
 4178:    1DB5  12 12 79                        LCALL   TXBYTE
 4179:    1DB8  E5 82                           MOV     A,DPL                           ;DPL
 4180:    1DBA  12 12 79                        LCALL   TXBYTE
 4181:    1DBD  E5 83                           MOV     A,DPH                           ;DPH
 4182:    1DBF  12 12 79                        LCALL   TXBYTE
 4183:    1DC2  08                              INC     R0                              ;R0
 4184:    1DC3  E6                              MOV     A,@R0                           ;R0
 4185:    1DC4  12 12 79                        LCALL   TXBYTE
 4186:    1DC7  78 01                           MOV     R0,#01h
 4187:    1DC9  E6              SINGLESTEP1:    MOV     A,@R0                           ;31 Bytes
 4188:    1DCA  12 12 79                        LCALL   TXBYTE
 4189:    1DCD  08                              INC     R0
 4190:    1DCE  B8 20 F8                        CJNE    R0,#20h,SINGLESTEP1
 4191:    1DD1  C0 82                           PUSH    DPL
 4192:    1DD3  C0 83                           PUSH    DPH
 4193:    1DD5  78 20                           MOV     R0,#20h                         ;32 Bytes
 4194:    1DD7  E0              SINGLESTEP2:    MOVX    A,@DPTR
 4195:    1DD8  12 12 79                        LCALL   TXBYTE
 4196:    1DDB  A3                              INC     DPTR
 4197:    1DDC  D8 F9                           DJNZ    R0,SINGLESTEP2
 4198:    1DDE  12 12 62        SINGLESTEP3:    LCALL   RXBYTE
 4199:    1DE1  B4 52 04                        CJNE    A,#'R',SINGLESTEP4              ;R Run
 4200:    1DE4  D2 B3                           SETB    P3.3                            ;Set INT1 pin high
 4201:    1DE6  80 0E                           SJMP    SINGLESTEPEX
 4202:    1DE8  B4 73 08        SINGLESTEP4:    CJNE    A,#'s',SINGLESTEP5              ;s Stop
 4203:    1DEB  D2 B3                           SETB    P3.3                            ;Set INT1 pin high
 4204:    1DED  E4                              CLR     A
 4205:    1DEE  C0 E0                           PUSH    ACC                             ;Force a software reset
 4206:    1DF0  C0 E0                           PUSH    ACC
 4207:    1DF2  32                              RETI                                    ;Return to reset vector
 4208:    1DF3  B4 69 11        SINGLESTEP5:    CJNE    A,#'i',SINGLESTEP6              ;i Step into
 4209:    1DF6  75 5A FF        SINGLESTEPEX:   MOV     SSADRLSB,#0FFh
 4210:    1DF9  75 5B FF                        MOV     SSADRMSB,#0FFh
 4211:    1DFC  D0 83           SINGLESTEPEX1:  POP     DPH
 4212:    1DFE  D0 82                           POP     DPL
 4213:    1E00  D0 00           SINGLESTEPEX2:  POP     00h
 4214:    1E02  D0 E0                           POP     ACC
 4215:    1E04  D0 D0                           POP     PSW
 4216:    1E06  32                              RETI
 4217:    1E07  B4 6F 0C        SINGLESTEP6:    CJNE    A,#'o',SINGLESTEP7              ;o Step over / Run to caret
 4218:    1E0A  12 12 62                        LCALL   RXBYTE
 4219:    1E0D  F5 5A                           MOV     SSADRLSB,A
 4220:    1E0F  12 12 62                        LCALL   RXBYTE
 4221:    1E12  F5 5B                           MOV     SSADRMSB,A
 4222:    1E14  80 E6                           SJMP    SINGLESTEPEX1
 4223:    1E16  B4 41 05        SINGLESTEP7:    CJNE    A,#'A',SINGLESTEP8              ;A Adress input
 4224:    1E19  12 12 41                        LCALL   INPDPTR
 4225:    1E1C  80 C0                           SJMP    SINGLESTEP3
 4226:    1E1E  B4 49 05        SINGLESTEP8:    CJNE    A,#'I',SINGLESTEP9              ;Dump internal memory
 4227:    1E21  12 13 97                        LCALL   MEMDUMP
 4228:    1E24  80 B8                           SJMP    SINGLESTEP3
 4229:    1E26  B4 44 05        SINGLESTEP9:    CJNE    A,#'D',SINGLESTEP10             ;Dump external memory
 4230:    1E29  12 13 39                        LCALL   DUMP
 4231:    1E2C  80 B0                           SJMP    SINGLESTEP3
 4232:    1E2E  B4 53 AD        SINGLESTEP10:   CJNE    A,#'S',SINGLESTEP3              ;Dump SFR's
 4233:    1E31  D0 83                           POP     DPH
 4234:    1E33  D0 82                           POP     DPL
 4235:    1E35  D0 00                           POP     00h
 4236:    1E37  D0 E0                           POP     ACC
 4237:    1E39  D0 D0                           POP     PSW
 4238:    1E3B  C0 D0                           PUSH    PSW
 4239:    1E3D  C0 E0                           PUSH    ACC
 4240:    1E3F  C2 D3                           CLR     RS0
 4241:    1E41  C2 D4                           CLR     RS1
 4242:    1E43  C0 00                           PUSH    00h
 4243:    1E45  C0 82                           PUSH    DPL
 4244:    1E47  C0 83                           PUSH    DPH
 4245:    1E49  12 13 BA                        LCALL   DUMPSFR
 4246:    1E4C  80 90                           SJMP    SINGLESTEP3
 4247:
 4248:                                          END





                     register banks used:  ---

                     no errors



